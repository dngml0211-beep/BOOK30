<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶í´ëŸ½ 3.0 - í†µí•© ë·°ì–´</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1',
                            cream: '#FFFBEB', peach: '#FFF7ED', mint: '#ECFDF5'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Common JS -->
    <script src="../js/common.js"></script>

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }
        body { background: linear-gradient(180deg, #FFF7ED 0%, #FEF3C7 50%, #ECFDF5 100%); }

        /* ë·°ì–´ íƒ­ ìŠ¤íƒ€ì¼ - ì»´íŒ©íŠ¸ ë²„ì „ */
        .viewer-tabs {
            display: flex;
            gap: 4px;
            padding: 6px 12px;
            background: #fafafa;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .viewer-tabs::-webkit-scrollbar { display: none; }

        .viewer-tab {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 8px;
            background: #f3f4f6;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
        }
        .viewer-tab:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        .viewer-tab.active {
            background: linear-gradient(135deg, #FF9F43 0%, #f97316 100%);
            color: white;
            border-color: #FF9F43;
            box-shadow: 0 2px 6px rgba(255, 159, 67, 0.25);
        }
        .viewer-tab .tab-icon {
            font-size: 13px;
        }
        .viewer-tab .tab-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.25);
            padding: 1px 5px;
            border-radius: 6px;
            font-size: 9px;
            margin-left: 3px;
            font-weight: 700;
        }
        .viewer-tab.active .tab-badge {
            background: rgba(255, 255, 255, 0.35);
        }

        /* iframe ì»¨í…Œì´ë„ˆ */
        .viewer-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 110px);
            background: white;
            overflow: hidden;
        }
        .viewer-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }
        .viewer-frame.active {
            display: block;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top-color: #FF9F43;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            max-width: 400px;
            text-align: center;
            padding: 24px;
        }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .back-btn {
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            transform: scale(1.05);
        }
        .back-btn:active {
            transform: scale(0.95);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 640px) {
            .viewer-tabs {
                padding: 5px 8px;
                gap: 3px;
            }
            .viewer-tab {
                padding: 4px 8px;
                font-size: 10px;
            }
            .viewer-tab .tab-icon {
                font-size: 12px;
            }
            .viewer-tab .tab-badge {
                font-size: 8px;
                padding: 1px 4px;
            }
            .viewer-container {
                height: calc(100vh - 100px);
            }
        }
    </style>
</head>
<body class="font-sans text-gray-800 h-screen overflow-hidden">
    <!-- Top Header -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-orange-100 shadow-sm">
        <div class="flex items-center justify-between px-4 py-3">
            <!-- Left: Back & Book Info -->
            <div class="flex items-center gap-3">
                <button onclick="goBack()" class="back-btn w-10 h-10 bg-orange-50 hover:bg-orange-100 rounded-xl flex items-center justify-center text-brand-primary transition-colors">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="flex items-center gap-2">
                    <span class="text-2xl" id="content-icon">ğŸ“–</span>
                    <div>
                        <h1 class="font-noto text-base text-gray-800" id="content-title">í†µí•© ë·°ì–´</h1>
                        <p class="text-xs text-gray-400" id="content-subtitle">ë…ì„œ Â· ì˜ìƒ Â· í•™ìŠµ Â· í™œë™</p>
                    </div>
                </div>
            </div>

            <!-- Right: Test Button + User Level Badge -->
            <div class="flex items-center gap-2">
                <!-- ì™„ë… í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
                <button onclick="testBookCompletion()" class="hidden sm:flex items-center gap-2 bg-green-100 hover:bg-green-200 px-3 py-2 rounded-xl text-green-700 text-sm font-bold transition-colors" title="ì™„ë… í…ŒìŠ¤íŠ¸">
                    <i class="fa-solid fa-check-circle"></i>
                    <span>ì™„ë… í…ŒìŠ¤íŠ¸</span>
                </button>

                <!-- User Level Badge -->
                <div class="hidden sm:flex items-center gap-2 bg-gradient-to-r from-orange-50 to-amber-50 px-4 py-2 rounded-full border border-orange-100">
                    <span class="text-xl">ğŸ¿ï¸</span>
                    <span class="font-noto text-sm text-brand-primary font-bold">Lv.5</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Viewer Tabs -->
    <nav class="viewer-tabs" id="viewer-tabs">
        <button class="viewer-tab active" data-viewer="book" onclick="switchViewer('book')">
            <span class="tab-icon">ğŸ“–</span>
            <span>ë„ì„œ ë·°ì–´</span>
        </button>
        <button class="viewer-tab" data-viewer="video" onclick="switchViewer('video')">
            <span class="tab-icon">ğŸ¥</span>
            <span>ì˜ìƒ ë·°ì–´</span>
        </button>
        <button class="viewer-tab" data-viewer="play" onclick="switchViewer('play')">
            <span class="tab-icon">ğŸ®</span>
            <span>ë†€ì´í•™ìŠµ</span>
        </button>
        <button class="viewer-tab" data-viewer="activity" onclick="switchViewer('activity')">
            <span class="tab-icon">âœï¸</span>
            <span>í™œë™íˆ´</span>
            <span class="tab-badge">NEW</span>
        </button>
        <button class="viewer-tab" data-viewer="album" onclick="switchViewer('album')">
            <span class="tab-icon">ğŸ“”</span>
            <span>ë…ì„œì•¨ë²”</span>
        </button>
    </nav>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewer-container">
        <!-- Loading Overlay -->
        <div class="loader-overlay" id="loader-overlay">
            <div class="loader-spinner"></div>
            <p class="font-noto text-gray-600 mt-4">ë·°ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- Book Viewer -->
        <iframe id="frame-book"
            class="viewer-frame active"
            src="../../ë¶í´ëŸ½3.0_í†µí•©ë·°ì–´/prototype/1.í†µí•©ë·°ì–´/ë¶í´ëŸ½3.0_ë…ì„œë·°ì–´_v0.3.html"
            title="ë…ì„œ ë·°ì–´">
        </iframe>

        <!-- Video Viewer -->
        <iframe id="frame-video"
            class="viewer-frame"
            src="../../ë¶í´ëŸ½3.0_í†µí•©ë·°ì–´/prototype/2.ì˜ìƒë·°ì–´/ë¶í´ëŸ½3.0_ì˜ìƒë·°ì–´_v0.2.html"
            title="ì˜ìƒ ë·°ì–´">
        </iframe>

        <!-- Play Learning -->
        <iframe id="frame-play"
            class="viewer-frame"
            src="../../ë¶í´ëŸ½3.0_í†µí•©ë·°ì–´/prototype/3.ë†€ì´í•™ìŠµ/ë¶í´ëŸ½3.0_ë†€ì´í•™ìŠµ_v1.1.html"
            title="ë†€ì´í•™ìŠµ">
        </iframe>

        <!-- Activity Tool -->
        <iframe id="frame-activity"
            class="viewer-frame"
            src="../../ë¶í´ëŸ½3.0_í†µí•©ë·°ì–´/prototype/4.í™œë™íˆ´/ë¶í´ëŸ½3.0_í™œë™íˆ´_ê°ìƒë¬¸ì“°ê¸°_v1.0.html"
            title="í™œë™íˆ´">
        </iframe>

        <!-- Reading Album -->
        <iframe id="frame-album"
            class="viewer-frame"
            src="../../ë¶í´ëŸ½3.0_í†µí•©ë·°ì–´/prototype/5.ë…ì„œì•¨ë²”/ë¶í´ëŸ½3.0_ë…ì„œì•¨ë²”_ìƒê°ê°¤ëŸ¬ë¦¬_v0.3.html"
            title="ë…ì„œì•¨ë²”">
        </iframe>

        <!-- Error Message (hidden by default) -->
        <div class="error-message hidden" id="error-message">
            <div class="text-6xl mb-4">ğŸ˜¢</div>
            <h3 class="font-noto text-xl text-gray-800 mb-2">ë·°ì–´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-sm text-gray-500 mb-4">íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            <button onclick="retryLoad()" class="px-6 py-2 bg-brand-primary text-white rounded-xl hover:bg-orange-600 transition-colors">
                <i class="fa-solid fa-rotate-right mr-2"></i>ë‹¤ì‹œ ì‹œë„
            </button>
        </div>
    </div>

    <script>
        // í˜„ì¬ í™œì„±í™”ëœ ë·°ì–´
        let currentViewer = 'book';

        // ë·°ì–´ ì •ë³´
        const viewerInfo = {
            book: {
                icon: 'ğŸ“–',
                title: 'ë…ì„œ ë·°ì–´',
                subtitle: 'AI ë²„ë””ì™€ í•¨ê»˜ ì½ê¸°'
            },
            video: {
                icon: 'ğŸ¥',
                title: 'ì˜ìƒ ë·°ì–´',
                subtitle: 'ì˜ìƒ í•™ìŠµ ì½˜í…ì¸ '
            },
            play: {
                icon: 'ğŸ®',
                title: 'ë†€ì´í•™ìŠµ',
                subtitle: 'ê²Œì„ìœ¼ë¡œ ë°°ìš°ê¸°'
            },
            activity: {
                icon: 'âœï¸',
                title: 'í™œë™íˆ´',
                subtitle: 'ê°ìƒë¬¸ Â· ê·¸ë¦¬ê¸° Â· ê¾¸ë¯¸ê¸°'
            },
            album: {
                icon: 'ğŸ“”',
                title: 'ë…ì„œì•¨ë²”',
                subtitle: 'ìƒê°ê°¤ëŸ¬ë¦¬'
            }
        };

        /**
         * ë·°ì–´ ì „í™˜
         */
        function switchViewer(viewerType) {
            if (currentViewer === viewerType) return;

            // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.viewer-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-viewer="${viewerType}"]`).classList.add('active');

            // iframe í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.viewer-frame').forEach(frame => {
                frame.classList.remove('active');
            });
            document.getElementById(`frame-${viewerType}`).classList.add('active');

            // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
            const info = viewerInfo[viewerType];
            document.getElementById('content-icon').textContent = info.icon;
            document.getElementById('content-title').textContent = info.title;
            document.getElementById('content-subtitle').textContent = info.subtitle;

            // í˜„ì¬ ë·°ì–´ ì €ì¥
            currentViewer = viewerType;
            sessionStorage.setItem('currentViewer', viewerType);

            console.log(`[Viewer] Switched to: ${viewerType}`);
        }

        /**
         * ë·°ì–´ ì¬ì‹œë„
         */
        function retryLoad() {
            location.reload();
        }

        /**
         * iframe ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸
         */
        function handleFrameLoad(viewerType) {
            console.log(`[Viewer] ${viewerType} loaded successfully`);

            // ì²« ë²ˆì§¸ ë·°ì–´ ë¡œë”© ì™„ë£Œ ì‹œ ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
            if (viewerType === 'book') {
                setTimeout(() => {
                    document.getElementById('loader-overlay').style.display = 'none';
                }, 500);
            }
        }

        /**
         * iframe ë¡œë”© ì—ëŸ¬ ì´ë²¤íŠ¸
         */
        function handleFrameError(viewerType) {
            console.error(`[Viewer] ${viewerType} failed to load`);

            if (viewerType === currentViewer) {
                document.getElementById('loader-overlay').style.display = 'none';
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        /**
         * postMessage í†µì‹  ìˆ˜ì‹ 
         */
        window.addEventListener('message', (event) => {
            // ë³´ì•ˆ: origin ì²´í¬ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ì‹¤ì œ ë„ë©”ì¸ ì²´í¬)
            // if (event.origin !== 'https://your-domain.com') return;

            const { type, data } = event.data;

            console.log('[Viewer] Message received:', type, data);

            switch (type) {
                case 'VIEWER_READY':
                    console.log(`[Viewer] ${data.viewer} is ready`);
                    break;

                case 'PAGE_CHANGED':
                    console.log('[Viewer] Page changed:', data);
                    // í˜ì´ì§€ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    handlePageProgress(data);
                    break;

                case 'BOOK_COMPLETED':
                    console.log('[Viewer] Book reading completed:', data);
                    // ì™„ë… ì´ë²¤íŠ¸ ì²˜ë¦¬
                    handleBookCompletion(data);
                    break;

                case 'ACTIVITY_SAVED':
                    console.log('[Viewer] Activity saved:', data);
                    // í™œë™ ì €ì¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
                    handleActivitySaved(data);
                    break;

                case 'VIDEO_ENDED':
                    console.log('[Viewer] Video ended:', data);
                    // ì˜ìƒ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
                    handleVideoEnded(data);
                    break;

                default:
                    console.warn('[Viewer] Unknown message type:', type);
            }
        });

        /**
         * í˜ì´ì§€ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
         */
        function handlePageProgress(data) {
            const progressData = {
                bookId: data.bookId,
                currentPage: data.currentPage || 1,
                totalPages: data.totalPages || 32,
                percentage: data.percentage || 0,
                lastRead: new Date().toISOString()
            };

            // í˜„ì¬ ì±… ì •ë³´ ì—…ë°ì´íŠ¸
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            currentBook.currentPage = progressData.currentPage;
            currentBook.totalPages = progressData.totalPages;
            currentBook.percentage = progressData.percentage;
            currentBook.lastRead = progressData.lastRead;
            sessionStorage.setItem('currentBook', JSON.stringify(currentBook));

            // ì½ê¸° ì§„í–‰ë¥  ì €ì¥
            sessionStorage.setItem('readingProgress', JSON.stringify(progressData));

            console.log('[Viewer] Progress updated:', progressData);
        }

        /**
         * ì™„ë… ì´ë²¤íŠ¸ ì²˜ë¦¬
         */
        function handleBookCompletion(data) {
            // ì™„ë… ë°ì´í„° ì €ì¥
            const completionData = {
                bookId: data.bookId,
                bookTitle: data.bookTitle,
                completedAt: new Date().toISOString(),
                readingTime: data.readingTime || 0,
                pageCount: data.pageCount || 0
            };

            // sessionStorageì— ì €ì¥
            const completions = JSON.parse(sessionStorage.getItem('bookCompletions') || '[]');
            completions.push(completionData);
            sessionStorage.setItem('bookCompletions', JSON.stringify(completions));

            // ì™„ë… í”Œë˜ê·¸ ì„¤ì • (í™ˆìœ¼ë¡œ ëŒì•„ê°ˆ ë•Œ ì‚¬ìš©)
            sessionStorage.setItem('bookJustCompleted', 'true');
            sessionStorage.setItem('lastCompletedBook', JSON.stringify(completionData));

            console.log('[Viewer] Book completion saved:', completionData);
        }

        /**
         * í™œë™ ì €ì¥ ì´ë²¤íŠ¸ ì²˜ë¦¬
         */
        function handleActivitySaved(data) {
            console.log('[Viewer] Activity data:', data);
            // í™œë™ ë°ì´í„°ëŠ” ì´ë¯¸ ê° ë·°ì–´ì—ì„œ localStorageì— ì €ì¥ë¨
        }

        /**
         * ì˜ìƒ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
         */
        function handleVideoEnded(data) {
            const videoData = {
                videoId: data.videoId,
                videoTitle: data.videoTitle,
                completedAt: new Date().toISOString(),
                watchTime: data.watchTime || 0
            };

            const completions = JSON.parse(sessionStorage.getItem('videoCompletions') || '[]');
            completions.push(videoData);
            sessionStorage.setItem('videoCompletions', JSON.stringify(completions));

            console.log('[Viewer] Video completion saved:', videoData);
        }

        /**
         * ë°ì´í„° ì „ì†¡ (iframeìœ¼ë¡œ)
         */
        function sendMessageToViewer(viewerType, messageType, data) {
            const frame = document.getElementById(`frame-${viewerType}`);
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({
                    type: messageType,
                    data: data
                }, '*');
            }
        }

        /**
         * ì™„ë… í…ŒìŠ¤íŠ¸ (ê°œë°œìš©)
         */
        function testBookCompletion() {
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');

            const testData = {
                bookId: currentBook.id || 'test-book-1',
                bookTitle: currentBook.title || 'í…ŒìŠ¤íŠ¸ ë„ì„œ',
                completedAt: new Date().toISOString(),
                readingTime: 1200, // 20ë¶„
                pageCount: 32
            };

            console.log('[Test] Simulating book completion:', testData);

            // ì™„ë… ì´ë²¤íŠ¸ ì§ì ‘ í˜¸ì¶œ
            handleBookCompletion(testData);

            // ì‚¬ìš©ì ì•Œë¦¼
            alert('âœ… ì™„ë… ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!\ní™ˆìœ¼ë¡œ ëŒì•„ê°€ì„œ ì™„ë… ë±ƒì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }

        /**
         * í˜ì´ì§€ ì§„í–‰ë¥  í…ŒìŠ¤íŠ¸ (ê°œë°œìš©)
         */
        function testPageProgress(page = 15) {
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');

            const testData = {
                bookId: currentBook.id || 'test-book-1',
                currentPage: page,
                totalPages: 32,
                percentage: (page / 32) * 100
            };

            console.log('[Test] Simulating page progress:', testData);

            // ì§„í–‰ë¥  ì´ë²¤íŠ¸ ì§ì ‘ í˜¸ì¶œ
            handlePageProgress(testData);

            alert(`âœ… í˜ì´ì§€ ${page}/32 ì§„í–‰ë¥ ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        /**
         * ì´ˆê¸°í™”
         */
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Viewer] Integrated viewer initialized');

            // iframe ë¡œë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            document.querySelectorAll('.viewer-frame').forEach(frame => {
                const viewerType = frame.id.replace('frame-', '');

                frame.addEventListener('load', () => handleFrameLoad(viewerType));
                frame.addEventListener('error', () => handleFrameError(viewerType));
            });

            // ì´ì „ ë·°ì–´ ìƒíƒœ ë³µì›
            const savedViewer = sessionStorage.getItem('currentViewer');
            if (savedViewer && savedViewer !== 'book') {
                switchViewer(savedViewer);
            }

            // URL íŒŒë¼ë¯¸í„°ë¡œ ë·°ì–´ ì„ íƒ
            const urlParams = new URLSearchParams(window.location.search);
            const viewerParam = urlParams.get('viewer');
            if (viewerParam && viewerInfo[viewerParam]) {
                switchViewer(viewerParam);
            }

            // ì‚¬ìš©ì ì •ë³´ ì „ë‹¬ (ëª¨ë“  ë·°ì–´ì—ê²Œ)
            setTimeout(() => {
                const userInfo = AppState.getUserInfo();
                Object.keys(viewerInfo).forEach(viewerType => {
                    sendMessageToViewer(viewerType, 'USER_INFO', userInfo);
                });
            }, 1000);
        });

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë‚´ë³´ë‚´ê¸°
        window.switchViewer = switchViewer;
        window.sendMessageToViewer = sendMessageToViewer;
        window.testBookCompletion = testBookCompletion;
        window.testPageProgress = testPageProgress;
    </script>
</body>
</html>
