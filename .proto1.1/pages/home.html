<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>북클럽 3.0 - 홈</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1', paper: '#FDFBF7',
                            report: { bg: '#F8FAFC', accent: '#4F46E5', dark: '#1E293B' },
                            tech: { dark: '#1e293b', purple: '#8b5cf6', blue: '#3b82f6', cyan: '#06b6d4' }
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 25px -5px rgba(0, 0, 0, 0.05)',
                        'floating': '0 20px 25px -5px rgba(255, 159, 67, 0.3)',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }

        /* === Week Header === */
        .week-nav-btn { transition: all 0.2s ease; }
        .week-nav-btn:hover { background: rgba(255,159,67,0.12); border-color: #FF9F43; }
        .week-nav-btn:active { transform: scale(0.9); }

        /* === Level Badge Inline === */
        .level-badge-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #FF9F43 0%, #f97316 100%);
            color: white;
            font-size: 13px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(255, 159, 67, 0.35);
            margin-right: 6px;
        }

        /* === Book Type Tabs (코어북/교과서 짝꿍책) === */
        .book-type-tabs {
            display: flex;
            gap: 8px;
            padding: 0 6px;
        }
        .book-type-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 14px;
            background: #f8f6f3;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
        }
        .book-type-tab.core:hover {
            background: #fff8f0;
            border-color: #ffe4c4;
        }
        .book-type-tab.textbook:hover {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        .book-type-tab.active {
            background: white;
            border-color: #FF9F43;
            box-shadow: 0 2px 12px rgba(255, 159, 67, 0.2);
        }
        .book-type-tab .tab-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .book-type-tab.core .tab-icon {
            background: linear-gradient(135deg, #FF9F43, #f97316);
        }
        .book-type-tab.textbook .tab-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .book-type-tab .tab-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            min-width: 0;
        }
        .book-type-tab .tab-label {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: #6b7280;
            white-space: nowrap;
        }
        .book-type-tab.active .tab-label {
            color: #374151;
        }
        .book-type-tab .tab-title {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 11px;
            font-weight: 500;
            color: #9ca3af;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }
        .book-type-tab.active .tab-title {
            color: #FF9F43;
        }
        .book-type-tab .tab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .book-type-tab .tab-badge.incomplete {
            background: #f59e0b;
        }
        @media (max-width: 480px) {
            .book-type-tab { padding: 10px 12px; }
            .book-type-tab .tab-icon { width: 32px; height: 32px; font-size: 16px; }
            .book-type-tab .tab-label { font-size: 12px; }
            .book-type-tab .tab-title { font-size: 10px; max-width: 70px; }
        }

        /* === Step Progress Bar (탭→프로그래스바) === */
        .step-progress-bar {
            display: flex; height: 40px; border-radius: 20px;
            background: #f0ebe3; overflow: hidden; position: relative;
        }
        .step-segment {
            flex: 1; position: relative; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700; color: #b8a080;
            transition: color 0.3s; z-index: 2;
            border-right: 2px solid rgba(255,255,255,0.5);
            user-select: none;
        }
        .step-segment:last-child { border-right: none; }
        .step-segment .seg-icon { margin-right: 5px; font-size: 15px; }
        .step-segment .seg-lock { font-size: 8px; margin-left: 3px; opacity: 0.6; }
        .step-segment.active { color: #b8a080; }
        .step-segment.completed { color: #b8a080; }
        .step-segment.locked { color: #c0b49a; cursor: default; }
        .step-segment.gauge-covered { color: #fff; }

        /* Gauge fill behind segments */
        .step-gauge {
            position: absolute; top: 0; left: 0; height: 100%;
            border-radius: 20px;
            background: linear-gradient(90deg, #FF9F43, #ffb347);
            transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1;
        }
        .step-gauge.full-complete {
            background: linear-gradient(90deg, #1dd1a1, #2ecc71);
        }
        /* 교과서 짝꿍책용 게이지 색상 */
        .step-gauge.textbook-gauge {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        .step-gauge.textbook-gauge.full-complete {
            background: linear-gradient(90deg, #059669, #10b981);
        }
        /* 게이지 전환 시 즉시 리셋 */
        .step-gauge.instant-reset {
            transition: none !important;
        }

        /* === 주차 전체 완료 상태 (드롭다운 접기) === */
        /* 접힌 영역: carousel + 보상헤더 - 족자처럼 접히고 펼쳐지는 인터렉션 */
        #carousel-wrapper {
            max-height: 900px;
            overflow: hidden;
            transition: max-height 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.5s ease,
                        padding 0.5s ease;
            opacity: 1;
        }
        #carousel-wrapper.week-done-collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        /* 헤더 보상 영역도 접기 */
        .header-rewards-group {
            transition: opacity 0.3s ease, max-height 0.3s ease;
            overflow: hidden;
        }
        .header-rewards-group.week-done-hidden {
            opacity: 0;
            max-height: 0 !important;
            pointer-events: none;
        }

        /* 완료 상태 탭 - 체크마크 완료 스타일 */
        .book-type-tab.tab-done {
            background: linear-gradient(135deg, #f0fdf4, #ecfdf5) !important;
            border-color: #86efac !important;
            box-shadow: 0 2px 8px rgba(16,185,129,0.12) !important;
        }
        .book-type-tab.tab-done .tab-label {
            color: #065f46 !important;
        }
        .book-type-tab.tab-done .tab-title {
            color: #10b981 !important;
        }
        .book-type-tab.tab-done .tab-badge {
            display: flex !important;
            background: #10b981 !important;
        }

        /* 드롭다운 토글 chevron */
        .week-done-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: #ecfdf5;
            border: 1.5px solid #86efac;
            color: #10b981;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.25s ease;
            flex-shrink: 0;
        }
        .week-done-toggle:hover {
            background: #dcfce7;
            border-color: #4ade80;
            transform: scale(1.08);
        }
        .week-done-toggle i {
            transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
        }
        .week-done-toggle.expanded i {
            transform: rotate(180deg);
        }

        /* 새로운 주차 접기 토글 버튼 (Step Progress Bar 아래) */
        .week-collapse-toggle {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 16px;
            border-radius: 14px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
            color: #92400e;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
        }
        .week-collapse-toggle.show {
            display: flex;
        }
        .week-collapse-toggle:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
            border-color: #f59e0b;
            color: #78350f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        .week-collapse-toggle i {
            transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
            font-size: 12px;
        }
        .week-collapse-toggle.collapsed i {
            transform: rotate(180deg);
        }
        .week-collapse-toggle.collapsed span {
            display: none;
        }
        .week-collapse-toggle.collapsed::after {
            content: '주차 펼치기';
        }

        /* 완료 배너 (탭 아래, 접힌 상태일 때) */
        .week-done-banner {
            display: none;
            align-items: center;
            gap: 10px;
            margin: 0 24px 16px;
            padding: 12px 18px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1.5px solid #86efac;
            border-radius: 14px;
            animation: bannerSlideIn 0.4s ease-out;
        }
        .week-done-banner.visible { display: flex; }
        .week-done-banner .banner-icon {
            font-size: 22px;
            flex-shrink: 0;
        }
        .week-done-banner .banner-text {
            flex: 1;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: #065f46;
            line-height: 1.45;
        }
        .week-done-banner .banner-text small {
            display: block;
            font-size: 11px;
            font-weight: 400;
            color: #6b7280;
            margin-top: 2px;
        }
        .week-done-banner .banner-expand-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.6);
            border: 1.5px solid #86efac;
            border-radius: 50%;
            color: #065f46;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .week-done-banner .banner-expand-btn:hover {
            background: white;
            border-color: #4ade80;
            transform: scale(1.1);
        }
        @keyframes bannerSlideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 주차 라벨 완료 표시 */
        .week-label-done {
            color: #10b981 !important;
        }
        .week-label-done .level-badge-inline {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            box-shadow: 0 2px 6px rgba(16,185,129,0.35) !important;
        }

        /* 추천도서 강조 (주차완료 시) */
        .recommend-highlight {
        }

        /* === 추천도서 넷플릭스 스타일 === */
        .recommend-netflix {
            position: relative;
            padding: 28px 0 20px;
        }
        .recommend-netflix .rec-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .recommend-netflix .rec-header-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        }
        .recommend-netflix .rec-header-text h3 {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: #1f2937;
            letter-spacing: -0.3px;
        }
        .recommend-netflix .rec-header-text p {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 2px;
        }
        .recommend-netflix-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .rec-card-netflix {
            position: relative;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #f3f4f6;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .rec-card-netflix:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 48px rgba(0,0,0,0.14);
            border-color: #e5e7eb;
        }
        .rec-card-netflix .rec-cover {
            position: relative;
            width: 100%;
            aspect-ratio: 3 / 4;
            overflow: hidden;
        }
        .rec-card-netflix .rec-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        .rec-card-netflix:hover .rec-cover img {
            transform: scale(1.06);
        }
        .rec-card-netflix .rec-cover .rec-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            pointer-events: none;
        }
        .rec-card-netflix .rec-cover .rec-level {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            backdrop-filter: blur(8px);
        }
        .rec-card-netflix .rec-info {
            padding: 14px 16px 16px;
        }
        .rec-card-netflix .rec-info h4 {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 15px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .rec-card-netflix .rec-info .rec-desc {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.5;
        }
        .rec-card-netflix .rec-info .rec-tag {
            display: inline-block;
            margin-top: 8px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        /* 왜 이걸 골랐냐면 코너 */
        .rec-why-section {
            margin-top: 16px;
            padding: 18px 20px;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 1px solid #fde68a;
            border-radius: 16px;
        }
        .rec-why-section .why-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .rec-why-section .why-header span {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
        }
        .rec-why-item {
            display: flex;
            gap: 10px;
            padding: 10px 0;
        }
        .rec-why-item:not(:last-child) {
            border-bottom: 1px solid rgba(253,230,138,0.6);
        }
        .rec-why-item .why-thumb {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .rec-why-item .why-text {
            font-size: 13px;
            color: #78350f;
            line-height: 1.55;
        }
        .rec-why-item .why-text strong {
            font-weight: 700;
            color: #92400e;
        }
        @media (max-width: 480px) {
            .recommend-netflix-grid { gap: 12px; }
            .rec-card-netflix .rec-info { padding: 12px 14px 14px; }
            .rec-card-netflix .rec-info h4 { font-size: 14px; }
        }

        /* === Book Spread (양면 펼침) === */
        .book-spread {
            display: flex; flex-wrap: wrap;
            border-radius: 1.25rem;
            box-shadow: 0 4px 24px rgba(80,60,30,0.12), 0 2px 0 #ede6d8;
            border: 1px solid #e8e0d4;
            transition: all 0.3s ease;
            width: 70%;
            margin: 0 auto;
            -webkit-tap-highlight-color: transparent;
        }
        .book-spread:hover {
            box-shadow: 0 8px 32px rgba(80,60,30,0.16), 0 2px 0 #ede6d8;
        }

        /* A면: 표지 — 5:5 비율 */
        .spread-cover {
            flex: 1 1 50%; min-height: 200px; max-width: 50%;
            position: relative; background: #2c1810; overflow: hidden;
            border-radius: 1.25rem 0 0 1.25rem;
            -webkit-tap-highlight-color: transparent;
        }
        .spread-cover img {
            width: 100%; height: 100%; object-fit: cover; display: block;
        }
        /* 완독 뱃지 */
        .completion-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            z-index: 10;
            animation: badgeBounce 0.6s ease-out;
        }
        @keyframes badgeBounce {
            0% { transform: scale(0) rotate(-15deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* 책 등 (spine) 그림자 — 오른쪽 */
        .spread-cover::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 28px; height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.08) 40%, rgba(0,0,0,0.22) 100%);
            pointer-events: none;
            z-index: 5;
        }

        /* B면: 내용 — 5:5 비율 */
        .spread-content {
            flex: 1 1 50%;
            background: #FDFBF7;
            padding: clamp(1rem, 3vw, 1.75rem);
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; min-width: 0;
            border-radius: 0 1.25rem 1.25rem 0;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        /* 종이 질감 — 책 등 왼쪽 그림자 */
        .spread-content::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 24px; height: 100%;
            background: linear-gradient(90deg, rgba(0,0,0,0.12) 0%, rgba(0,0,0,0.04) 40%, transparent 100%);
            pointer-events: none; z-index: 1;
        }

        /* 페이지 넘김 애니메이션 — 설명 영역(B면)만 넘김 */
        @keyframes pageTurnRight {
            0% { transform: perspective(1200px) rotateY(0deg); opacity: 1; }
            60% { opacity: 0.6; }
            100% { transform: perspective(1200px) rotateY(-85deg); opacity: 0; }
        }
        .page-turning .spread-content {
            animation: pageTurnRight 0.55s ease-in forwards;
            transform-origin: left center;
        }

        /*
         * 반응형: flex-wrap이 자동으로 스택을 처리하지만,
         * 세로 스택 시 A면의 max-width 해제 + 고정 높이 부여
         */
        @media (max-width: 720px) {
            .book-spread {
                width: 100%;
                flex-direction: column;
            }
            .spread-cover {
                flex: none;
                max-width: 100%; min-height: 0;
                height: clamp(180px, 45vw, 260px);
                border-radius: 1.25rem 1.25rem 0 0;
            }
            .spread-cover img {
                width: 100%; height: 100%; object-fit: cover;
            }
            .spread-cover::after {
                top: auto; right: auto; bottom: 0; left: 0;
                width: 100%; height: 16px;
                background: linear-gradient(180deg, transparent, rgba(0,0,0,0.12));
            }
            .spread-content {
                flex: none;
                border-radius: 0 0 1.25rem 1.25rem;
                min-height: auto;
            }
            .spread-content::before {
                width: 100%; height: 12px;
                background: linear-gradient(180deg, rgba(0,0,0,0.05), transparent);
            }
        }

        /* 모바일: 축소 */
        @media (max-width: 768px) {
            .book-excerpt { -webkit-line-clamp: 3; line-clamp: 3; }
        }

        /* 프로그래스바·버튼 유동 사이즈 */
        @media (max-width: 480px) {
            .step-segment { font-size: 11px; }
            .step-segment .seg-icon { font-size: 12px; margin-right: 3px; }
            .step-progress-bar { height: 34px; border-radius: 17px; }
            .step-gauge { border-radius: 17px; }
            .cta-btn { padding: 11px; font-size: 13px; }
        }

        /* 모바일: 프로그래스바 컨테이너 너비 */
        @media (max-width: 720px) {
            .story-page .step-progress-bar { width: 100% !important; }
        }

        /* 태블릿: B면 콘텐츠 유동 축소 */
        @media (min-width: 721px) and (max-width: 1100px) {
            .spread-cover { max-width: 50%; min-height: 200px; }
            .spread-content { flex-basis: 50%; }
            /* B면 내부 마진·갭 축소 */
            .spread-content .book-info-top { gap: clamp(4px, 1vw, 12px); }
            .spread-content .book-info-top .tag-row { margin-bottom: clamp(4px, 1vw, 12px); }
            .spread-content .book-info-top .book-title { margin-bottom: 2px; }
            .spread-content .book-info-top .book-desc { margin-bottom: clamp(6px, 1.2vw, 16px); }
            .spread-content .book-excerpt { margin-bottom: clamp(8px, 1.5vw, 20px); }
            .book-excerpt { -webkit-line-clamp: 2; line-clamp: 2; font-size: clamp(0.85rem, 1.8vw, 1rem); line-height: 1.7; }
            .book-tag { font-size: 10px; padding: 3px 7px; }
            .cta-btn { padding: clamp(8px, 1.5vw, 12px); font-size: clamp(11px, 1.8vw, 14px); }
            .pg-indicator { font-size: 12px; }
            .pg-indicator .pg-num { font-size: 15px; }
            .pg-arrow { width: 28px; height: 28px; }
        }

        /* Book tag */
        .book-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 8px;
            font-size: 11px; font-weight: 700;
        }

        /* 본문 인용 스타일 */
        .book-excerpt {
            font-family: 'Gowun Batang', 'Noto Sans KR', serif;
            font-size: clamp(0.95rem, 2.2vw, 1.1rem);
            line-height: 1.85; color: #5c4a32;
            position: relative;
            padding-left: clamp(0.8rem, 2vw, 1.2rem);
            border-left: 3px solid #e8d5b8;
            word-break: keep-all; overflow-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* CTA Button */
        .cta-btn {
            width: 100%;
            padding: clamp(10px, 2vw, 13px);
            border-radius: clamp(10px, 2vw, 14px);
            font-weight: 700;
            font-size: clamp(12px, 2vw, 14px);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .cta-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }

        .cta-btn-secondary {
            width: 100%;
            padding: clamp(8px, 1.5vw, 10px);
            border-radius: clamp(10px, 2vw, 14px);
            font-weight: 700;
            font-size: clamp(11px, 1.8vw, 13px);
            border: 2px solid #1dd1a1;
            background: white;
            color: #1dd1a1;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.25s ease;
            white-space: nowrap;
        }
        .cta-btn-secondary:hover { background: #f0fdf9; transform: translateY(-1px); }

        /* Page indicator */
        .pg-indicator {
            display: flex; align-items: center; gap: 6px;
            font-size: 14px; font-weight: 700; color: #b8a080;
        }
        .pg-indicator .pg-num { color: #FF9F43; font-size: 18px; }
        .pg-arrow {
            width: 32px; height: 32px; border-radius: 8px; border: 1.5px solid #e8e0d4;
            background: #fff; display: flex; align-items: center; justify-content: center;
            color: #b8a080; cursor: pointer; transition: all 0.2s;
        }
        .pg-arrow:hover { border-color: #FF9F43; color: #FF9F43; background: #fff8f0; }

        /* === Carousel (표시/숨김 방식) === */
        .story-carousel { position: relative; }
        .story-page { display: none; }
        .story-page.active-page { display: block; animation: fadeInPage 0.3s ease; }
        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === Locked Card === */
        .locked-card-main {
            background: #fff; border-radius: 1.25rem;
            box-shadow: 0 2px 0 #ede6d8, 0 6px 24px rgba(120,90,50,0.08);
            border: 1px solid #f0ebe3;
            min-height: 320px; position: relative; overflow: hidden;
        }
        .locked-card-main .lock-veil {
            position: absolute; inset: 0; z-index: 10;
            background: rgba(255,255,255,0.7); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        }
        .lock-badge {
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #f0ebe3, #e8e0d4);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; color: #b8a080;
        }
        .locked-card-main.unlocked .lock-veil { display: none; }
        .locked-card-main.unlocked { cursor: pointer; transition: all 0.3s; }
        .locked-card-main.unlocked:hover { transform: translateY(-1px); box-shadow: 0 2px 0 #ede6d8, 0 12px 32px rgba(120,90,50,0.14); }

        /* === Completion Card === */
        .completion-card {
            background: #fff; border-radius: 1.25rem; text-align: center;
            box-shadow: 0 2px 0 #8fe0bb, 0 6px 24px rgba(29,209,161,0.15);
            border: 1px solid #b2f0d1; overflow: hidden; min-height: 320px;
        }
        .completion-top {
            background: linear-gradient(135deg, #1dd1a1, #10b981);
            padding: 2rem; color: #fff; position: relative; overflow: hidden;
        }
        .completion-bottom {
            padding: 1.5rem 2rem; background: #fff;
        }
        .confetti-p {
            position: absolute; border-radius: 3px;
            animation: confetti-drift 2.5s ease-in-out infinite;
        }
        @keyframes confetti-drift {
            0% { transform: translateY(0) rotate(0); opacity: 0.9; }
            100% { transform: translateY(60px) rotate(600deg); opacity: 0; }
        }

        /* === Completion Stamp (완료 도장) === */
        .completion-stamp {
            position: absolute;
            top: 16px; right: 16px;
            z-index: 20;
            background: rgba(29, 209, 161, 0.13);
            border: 2.5px solid rgba(29, 209, 161, 0.5);
            color: #1dd1a1;
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transform: rotate(-6deg);
            pointer-events: none;
            animation: stampAppear 0.4s ease-out;
        }
        .completion-stamp i {
            font-size: 16px;
        }
        @keyframes stampAppear {
            0% { opacity: 0; transform: rotate(-6deg) scale(0.5); }
            60% { transform: rotate(-6deg) scale(1.1); }
            100% { opacity: 1; transform: rotate(-6deg) scale(1); }
        }

        /* === General === */
        .book-card:hover { transform: translateY(-4px); }
        .level-badge { font-size: 10px; padding: 2px 8px; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* 찜하기 하트 */
        .fav-heart-sm {
            width: 28px; height: 28px; border-radius: 50%;
            background: rgba(255,255,255,0.85);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .fav-heart-sm:hover { transform: scale(1.15); }
        .fav-heart-sm i { font-size: 13px; color: #d1d5db; transition: color 0.2s; }
        .fav-heart-sm.active i { color: #ef4444; }
    </style>
</head>
<body class="bg-brand-bg font-sans text-gray-800 h-screen overflow-hidden">
    <!-- 모바일 햄버거 버튼 -->
    <button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()">
        <i class="fa-solid fa-bars text-gray-600 text-lg"></i>
    </button>

    <!-- 사이드바 오버레이 -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="flex w-full h-full">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="flex-1 h-full overflow-y-auto px-6 py-8 md:px-12">
          <div class="max-w-[1400px]">
            <!-- Header -->
            <header class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="font-noto text-[19px] md:text-[25px] text-gray-800">
                        <span data-user-name>우희</span>님, 안녕! <button onclick="showTtottoPopup()" class="inline-flex items-center justify-center hover:scale-125 transition-transform cursor-pointer bg-transparent border-none p-0" style="outline:none;" title="또또와 대화하기">👋</button>
                    </h2>
                    <p class="text-gray-500 mt-1">오늘도 즐거운 독서 탐험을 시작해볼까요?</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative hide-mobile">
                        <input type="text" placeholder="책 제목, 작가 검색..." class="w-64 h-12 bg-white/80 border border-gray-200 rounded-2xl px-5 pr-12 outline-none focus:border-brand-primary focus:bg-white transition-all text-sm">
                        <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button onclick="openTool('diagnosis_re')" class="flex flex-col items-center group" title="진단 테스트">
                        <div class="w-12 h-12 bg-gradient-to-br from-brand-primary to-orange-500 rounded-2xl border-2 border-orange-300 flex items-center justify-center text-white hover:shadow-lg group-hover:scale-105 transition-all shadow-md">
                            <i class="fa-solid fa-compass text-lg"></i>
                        </div>
                        <span class="text-[9px] text-gray-400/70 mt-0.5 tracking-tight">진단테스트</span>
                    </button>
                </div>
            </header>

            <!-- Weekly Curriculum Section -->
            <section id="curriculum-section" class="mb-8">
                <div class="bg-white rounded-[1.5rem] shadow-lg border border-orange-100 overflow-hidden" style="position:relative;">

                    <!-- Row 1: Week Header -->
                    <div class="flex items-center justify-between px-6 pt-5 pb-3">
                        <div class="flex items-center gap-2">
                            <button onclick="prevWeek()" class="week-nav-btn w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-brand-primary border border-gray-200 transition-all">
                                <i class="fa-solid fa-chevron-left text-xs"></i>
                            </button>
                            <span id="week-label" class="font-noto text-lg text-gray-800 mx-1 flex items-center"><span class="level-badge-inline">K2-1</span> 1주차</span>
                            <button onclick="nextWeek()" class="week-nav-btn w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-brand-primary border border-gray-200 transition-all">
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- 헤더 보상 영역: 선물상자 + 티켓/별 -->
                            <div class="header-rewards-group" id="header-rewards-group">
                                <!-- 선물상자 (헤더 버전) -->
                                <div class="header-reward-box locked" id="header-reward-box" onclick="claimHeaderRewardBox(this)">
                                    🎁
                                    <span class="box-sparkle sp1">✦</span>
                                    <span class="box-sparkle sp2">✦</span>
                                    <span class="box-sparkle sp3">✧</span>
                                    <span class="box-sparkle sp4">✦</span>
                                </div>
                                <!-- 티켓/별 버튼 -->
                                <div style="position:relative;">
                                    <button onclick="showBingoModal()" class="bingo-reward-btn" title="별딱지 빙고">
                                        <span class="bingo-reward-shimmer"></span>
                                        <span class="bingo-reward-item">
                                            <span class="bingo-reward-icon">🎟️</span>
                                            <span class="font-bold" id="bingo-orb-count">10</span>
                                        </span>
                                        <span class="bingo-reward-divider"></span>
                                        <span class="bingo-reward-item">
                                            <span class="bingo-reward-icon bingo-star-spin">⭐</span>
                                            <span class="font-bold" id="bingo-star-count">125</span>
                                        </span>
                                        <span class="bingo-reward-sparkle s1">✦</span>
                                        <span class="bingo-reward-sparkle s2">✦</span>
                                        <span class="bingo-reward-sparkle s3">✧</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Book Type Tabs (코어북 vs 교과서 짝꿍책) -->
                    <div class="book-type-tabs px-6 pb-4" id="book-type-tabs">
                        <div class="book-type-tab core active" data-book-type="core" onclick="switchBookType('core')">
                            <div class="tab-icon">📕</div>
                            <div class="tab-content">
                                <span class="tab-label">코어북</span>
                                <span class="tab-title" id="core-book-title">오즈의 마법사</span>
                            </div>
                            <div class="tab-badge incomplete" id="core-badge"><i class="fa-solid fa-ellipsis"></i></div>
                        </div>
                        <div class="book-type-tab textbook" data-book-type="textbook" onclick="switchBookType('textbook')">
                            <div class="tab-icon">📗</div>
                            <div class="tab-content">
                                <span class="tab-label">교과서 짝꿍책</span>
                                <span class="tab-title" id="textbook-book-title">국어 2-1 연계</span>
                            </div>
                            <div class="tab-badge incomplete" id="textbook-badge" style="display:none;"><i class="fa-solid fa-check"></i></div>
                        </div>
                    </div>

                    <!-- 주차 전체 완료 배너 (접힌 상태에서 표시) -->
                    <div class="week-done-banner" id="week-done-banner">
                        <div class="banner-icon">🏆</div>
                        <div class="banner-text">
                            이번 주 학습 모두 완료!
                            <small>아래 추천도서를 확인해보세요</small>
                        </div>
                        <button class="banner-expand-btn" onclick="toggleWeekCollapse()" title="주차 펼치기">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                    </div>

                    <!-- Row 3: Card Carousel -->
                    <div class="px-6 pb-5 bg-[#FFF8F0]" id="carousel-wrapper">
                        <div id="story-active" class="story-carousel">

                                <!-- PAGE 1: 도서 읽기 (양면 펼침) -->
                                <div class="story-page active-page" data-page="book">
                                    <div class="book-spread" id="book-card">
                                        <!-- A면: 표지 -->
                                        <div class="spread-cover" id="spread-cover" onclick="openBookViewer()" style="cursor:pointer;">
                                            <img id="book-cover-img" src="../img/book1.jpg" alt="책 표지">
                                        </div>
                                        <!-- B면: 내용 -->
                                        <div class="spread-content" onclick="openBookViewer()"
                                            <!-- 상단: 책 정보 -->
                                            <div class="book-info-top" id="book-info-top" onclick="openBookViewer()" style="cursor:pointer;">
                                                <!-- Labels -->
                                                <div class="flex items-center gap-2 flex-wrap tag-row" style="margin-bottom:clamp(6px,1.5vw,12px);">
                                                    <span id="book-type-badge" class="book-tag bg-orange-50 text-orange-500">
                                                        <i class="fa-solid fa-bookmark text-[9px]"></i> 코어북
                                                    </span>
                                                    <span id="main-book-level" class="book-tag bg-indigo-50 text-indigo-500 border border-indigo-100">K2-1</span>
                                                </div>

                                                <!-- Title & Desc -->
                                                <h3 id="main-book-title" class="font-noto text-gray-900 book-title" style="font-size:clamp(1rem,2.5vw,1.25rem); margin-bottom:2px;">오즈의 마법사</h3>
                                                <p id="main-book-desc" class="text-xs text-gray-400 book-desc" style="margin-bottom:clamp(8px,1.5vw,16px);">도로시와 함께하는 신비한 모험 이야기</p>

                                                <!-- 본문 인용 -->
                                                <div class="book-excerpt" id="book-excerpt" style="margin-bottom:clamp(8px,1.5vw,20px);">
                                                    쿵! 마침내 회오리바람이 멈추고 집이 땅에 떨어졌어요.<br>
                                                    도로시가 집 밖으로 나오자 지팡이를 든 할머니가 다가왔어요.
                                                </div>
                                            </div>

                                            <!-- 하단: CTA + 페이지 -->
                                            <div>
                                                <button id="main-action-btn" class="cta-btn bg-gradient-to-r from-brand-primary to-orange-400 text-white shadow-md" onclick="openBookViewer()">
                                                    <i class="fa-solid fa-book-open"></i>
                                                    <span id="main-action-text">읽기 시작</span>
                                                </button>
                                                <button id="reread-btn" class="hidden cta-btn-secondary mt-2" onclick="reReadBook()">
                                                    <i class="fa-solid fa-rotate-right"></i>
                                                    <span>다시 읽기</span>
                                                </button>

                                                <div class="flex items-center justify-end mt-3 gap-2" id="book-pg-area" onclick="openBookViewer()" style="cursor:pointer;">
                                                    <div class="pg-indicator">
                                                        <span class="pg-num" id="book-pg-current">1</span>
                                                        <span>/</span>
                                                        <span id="book-pg-total">8</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step Progress Bar (책 아래 배치 - 시원하게 확장) -->
                                    <div class="reward-box-wrapper mt-4">
                                        <div class="step-progress-bar" id="step-progress-bar">
                                            <div class="step-gauge" id="step-gauge" style="width:0%"></div>
                                            <div class="step-segment active" onclick="goToPage(0)" id="seg-book">
                                                <span class="seg-icon">📖</span><span id="seg-book-label">도서읽기</span>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(1)" id="seg-quiz">
                                                <span class="seg-icon">❓</span>독후퀴즈<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked hidden" onclick="goToPage(2)" id="seg-retelling">
                                                <span class="seg-icon">🎬</span>AI리텔링<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(getLastPageIndex())" id="seg-vocab">
                                                <span class="seg-icon">🎮</span>어휘챌린지<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                        </div>

                                        <!-- 드롭다운 토글 버튼 (Step Progress Bar 아래) -->
                                        <button class="week-collapse-toggle mt-4" id="week-collapse-toggle" onclick="toggleWeekCollapse()">
                                            <i class="fa-solid fa-chevron-up"></i>
                                            <span>주차 접기</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- PAGE 2: 독후퀴즈 -->
                                <div class="story-page" data-page="quiz">
                                    <div class="locked-card-main" id="quiz-card">
                                        <div class="lock-veil" id="quiz-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-noto text-base text-gray-500">책을 먼저 읽어주세요</span>
                                            <span class="text-xs text-gray-400">독서 완료 후 퀴즈가 열려요</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-amber-50 to-amber-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">❓</span>
                                            </div>
                                            <h4 class="font-noto text-2xl text-gray-800 mb-2">독후퀴즈</h4>
                                            <p class="text-sm text-gray-500 mb-4">책 내용을 얼마나 기억하고 있을까?</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-amber-50 text-amber-600">📝 5문제</span>
                                                <span class="book-tag bg-amber-50 text-amber-600">⭐ +50점</span>
                                            </div>
                                            <button onclick="window.location.href='quiz.html'" class="cta-btn bg-gradient-to-r from-amber-500 to-yellow-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> 퀴즈 시작하기
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num">2</span>/<span id="pg-total-quiz">3</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step Progress Bar (독후퀴즈 페이지) - locked-card 바깥 배치 -->
                                    <div class="mt-4" style="width:90%; margin:20px auto 0;">
                                        <div class="step-progress-bar">
                                            <div class="step-gauge" style="width:0%"></div>
                                            <div class="step-segment locked" onclick="goToPage(0)">
                                                <span class="seg-icon">📖</span>도서읽기
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(1)">
                                                <span class="seg-icon">❓</span>독후퀴즈<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked hidden" onclick="goToPage(2)">
                                                <span class="seg-icon">🎬</span>AI리텔링<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(getLastPageIndex())">
                                                <span class="seg-icon">🎮</span>어휘챌린지<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE 3: AI리텔링 (2,4주차) -->
                                <div class="story-page hidden" data-page="retelling" id="page-retelling">
                                    <div class="locked-card-main" id="retelling-card">
                                        <div class="lock-veil" id="retelling-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-noto text-base text-gray-500">퀴즈를 먼저 풀어주세요</span>
                                            <span class="text-xs text-gray-400">퀴즈 완료 후 열려요</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-pink-50 to-pink-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">🎬</span>
                                            </div>
                                            <h4 class="font-noto text-2xl text-gray-800 mb-2">AI 리텔링</h4>
                                            <p class="text-sm text-gray-500 mb-4">이야기를 나만의 방식으로 다시 들려줘!</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-pink-50 text-pink-600">🎙️ 음성녹음</span>
                                                <span class="book-tag bg-pink-50 text-pink-600">⭐ +70점</span>
                                            </div>
                                            <button onclick="window.location.href='video-retelling.html'" class="cta-btn bg-gradient-to-r from-pink-500 to-rose-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> 리텔링 시작하기
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num">3</span>/<span>4</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step Progress Bar (AI리텔링 페이지) - locked-card 바깥 배치 -->
                                    <div class="mt-4" style="width:90%; margin:20px auto 0;">
                                        <div class="step-progress-bar">
                                            <div class="step-gauge" style="width:0%"></div>
                                            <div class="step-segment locked" onclick="goToPage(0)">
                                                <span class="seg-icon">📖</span>도서읽기
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(1)">
                                                <span class="seg-icon">❓</span>독후퀴즈<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(2)">
                                                <span class="seg-icon">🎬</span>AI리텔링<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(getLastPageIndex())">
                                                <span class="seg-icon">🎮</span>어휘챌린지<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- PAGE: 어휘 챌린지 -->
                                <div class="story-page" data-page="vocab">
                                    <div class="locked-card-main" id="vocab-card">
                                        <div class="lock-veil" id="vocab-lock">
                                            <div class="lock-badge"><i class="fa-solid fa-lock"></i></div>
                                            <span class="font-noto text-base text-gray-500">이전 단계를 완료해주세요</span>
                                            <span class="text-xs text-gray-400">순서대로 진행해야 열려요</span>
                                        </div>
                                        <div class="p-7 flex flex-col items-center justify-center text-center" style="min-height:320px;">
                                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center mb-4">
                                                <span style="font-size:2.8rem;">🎮</span>
                                            </div>
                                            <h4 class="font-noto text-2xl text-gray-800 mb-2">어휘 챌린지</h4>
                                            <p class="text-sm text-gray-500 mb-4">재미있는 게임으로 새 단어를 정복하자!</p>
                                            <div class="flex items-center gap-3 mb-5">
                                                <span class="book-tag bg-green-50 text-green-600">🏆 10단어</span>
                                                <span class="book-tag bg-green-50 text-green-600">⭐ +80점</span>
                                            </div>
                                            <button onclick="window.location.href='vocabulary-challenge.html'" class="cta-btn bg-gradient-to-r from-green-500 to-emerald-400 text-white shadow-md" style="max-width:300px;">
                                                <i class="fa-solid fa-play"></i> 챌린지 시작하기
                                            </button>
                                            <div class="flex items-center justify-end mt-4 gap-2 w-full">
                                                <div class="pg-indicator"><span class="pg-num" id="pg-vocab-num">3</span>/<span id="pg-vocab-total">3</span></div>
                                                <button onclick="prevPage()" class="pg-arrow"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                                                <button onclick="nextPage()" class="pg-arrow"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Step Progress Bar (어휘챌린지 페이지) - locked-card 바깥 배치 -->
                                    <div class="mt-4" style="width:90%; margin:20px auto 0;">
                                        <div class="step-progress-bar">
                                            <div class="step-gauge" style="width:0%"></div>
                                            <div class="step-segment locked" onclick="goToPage(0)">
                                                <span class="seg-icon">📖</span>도서읽기
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(1)">
                                                <span class="seg-icon">❓</span>독후퀴즈<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked hidden" onclick="goToPage(2)">
                                                <span class="seg-icon">🎬</span>AI리텔링<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                            <div class="step-segment locked" onclick="goToPage(getLastPageIndex())">
                                                <span class="seg-icon">🎮</span>어휘챌린지<i class="fa-solid fa-lock seg-lock"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                        <!-- Completed State -->
                        <div id="story-completed" class="hidden">
                            <div class="completion-card">
                                <div class="completion-top">
                                    <div class="confetti-p" style="width:10px;height:10px;background:#fff;left:15%;top:20%;animation-delay:0s;"></div>
                                    <div class="confetti-p" style="width:8px;height:8px;background:#ffd54f;left:40%;top:10%;animation-delay:0.4s;"></div>
                                    <div class="confetti-p" style="width:12px;height:6px;background:#ff8a65;left:65%;top:25%;animation-delay:0.8s;"></div>
                                    <div class="confetti-p" style="width:8px;height:8px;background:#80deea;left:85%;top:12%;animation-delay:0.2s;"></div>
                                    <div style="position:relative; z-index:2;">
                                        <div style="font-size:4rem; margin-bottom:0.5rem;">🏆</div>
                                        <h3 class="font-noto text-2xl">학습 완료!</h3>
                                    </div>
                                </div>
                                <div class="completion-bottom">
                                    <!-- 책 섬네일 + 정보 -->
                                    <div class="flex items-center gap-4 mb-4">
                                        <img id="completed-book-thumb" src="../img/book1.jpg" alt="책 표지" class="w-16 h-20 rounded-lg shadow-md overflow-hidden flex-shrink-0 object-cover">
                                        <div class="text-left">
                                            <p id="completed-book-title" class="font-noto text-base font-bold text-gray-800 mb-1">오즈의 마법사</p>
                                            <p class="text-xs text-gray-400">이번 주 학습 완료!</p>
                                        </div>
                                    </div>
                                    <!-- 학습 결과 -->
                                    <div class="bg-gray-50 rounded-xl p-3 mb-4">
                                        <div class="flex flex-col gap-2 text-sm">
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-500">📝 독후퀴즈</span>
                                                <span id="completed-quiz-result" class="font-bold text-emerald-600">3문제 정답</span>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-500">📚 어휘챌린지</span>
                                                <span id="completed-vocab-result" class="font-bold text-blue-600">100점!</span>
                                            </div>
                                            <div class="flex items-center justify-between pt-2 border-t border-gray-200">
                                                <span class="text-gray-600 font-medium">🎁 완료보상</span>
                                                <span class="font-bold text-amber-600">🎟️ 딱지 1개 획득</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="startReReading()" class="cta-btn bg-gradient-to-r from-blue-500 to-indigo-400 text-white shadow-md">
                                        <i class="fa-solid fa-rotate-left"></i> 다시 읽기
                                    </button>

                                    <!-- 주차 접기 버튼 (완료 화면에서만 표시) -->
                                    <button class="week-collapse-toggle mt-3" id="week-collapse-toggle-completed" onclick="toggleWeekCollapse()" style="display:none;">
                                        <i class="fa-solid fa-chevron-up"></i>
                                        <span>주차 접기</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    <!-- 별딱지 빙고 Modal (풀스크린) -->
            <div id="bingo-modal" class="hidden" style="position:fixed;inset:0;z-index:9000;display:none;flex-direction:column;background:linear-gradient(180deg,#FFF8F0 0%,#FFECD2 40%,#FCE1C4 100%);overflow:hidden;">
                <!-- 바닥 패턴 장식 -->
                <div style="position:absolute;inset:0;opacity:0.06;background-image:url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><rect width=%2260%22 height=%2260%22 fill=%22none%22/><circle cx=%2230%22 cy=%2230%22 r=%224%22 fill=%22%23C87533%22/></svg>');pointer-events:none;z-index:0;"></div>
                <div class="bingo-modal-content" style="flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden;">
                    <!-- 닫기 X 버튼 -->
                    <button onclick="closeBingoModal()" style="position:absolute;top:16px;right:16px;z-index:30;width:36px;height:36px;border-radius:50%;background:rgba(0,0,0,0.06);border:none;color:#9ca3af;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <!-- 헤더 -->
                    <div style="padding:24px 24px 16px;position:relative;z-index:2;">
                        <h3 class="font-noto" style="font-size:26px;font-weight:900;color:#92400E;margin-bottom:14px;text-align:center;letter-spacing:-0.5px;">
                            🌟 별딱지 빙고
                        </h3>
                        <div style="display:flex;justify-content:center;gap:10px;font-size:15px;">
                            <span style="background:white;padding:8px 18px;border-radius:24px;color:#92400E;font-weight:800;display:flex;align-items:center;gap:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);font-size:15px;">
                                🎟️ <span id="bingo-modal-orbs" style="font-size:17px;">10</span>
                            </span>
                            <span style="background:white;padding:8px 18px;border-radius:24px;color:#D97706;font-weight:800;display:flex;align-items:center;gap:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);font-size:15px;">
                                ⭐ <span id="bingo-modal-stars" style="font-size:17px;">125</span>
                            </span>
                            <span style="background:white;padding:8px 18px;border-radius:24px;color:#DC2626;font-weight:800;display:flex;align-items:center;gap:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);font-size:15px;">
                                🎯 <span id="bingo-line-count" style="font-size:17px;">0</span>빙고
                            </span>
                        </div>
                    </div>
                    <!-- 빙고 완성 축하 알림 (중앙 오버레이) -->
                    <div id="bingo-line-banner" style="display:none;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:15;padding:22px 40px;border-radius:24px;background:linear-gradient(135deg,#1E3A5F,#2563EB);text-align:center;font-weight:900;color:white;font-size:24px;box-shadow:0 12px 40px rgba(37,99,235,0.5),0 0 0 5px rgba(255,255,255,0.4),0 0 60px rgba(37,99,235,0.2);pointer-events:none;white-space:nowrap;letter-spacing:-0.3px;opacity:1;">
                    </div>
                    <!-- 3x3 빙고 그리드 + SVG 라인 오버레이 -->
                    <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:12px 28px;">
                        <div style="width:100%;max-width:360px;position:relative;">
                            <!-- SVG 빙고 라인 오버레이 -->
                            <svg id="bingo-lines-svg" style="position:absolute;inset:0;width:100%;height:100%;z-index:5;pointer-events:none;"></svg>
                            <div id="bingo-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;position:relative;z-index:2;">
                            </div>
                        </div>
                    </div>
                    <!-- 하단: 딱지 뒤집기 가이드 -->
                    <div style="padding:14px 24px 24px;text-align:center;">
                        <p style="font-size:15px;color:#78350F;font-weight:700;background:rgba(255,255,255,0.6);display:inline-block;padding:10px 24px;border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);">딱지를 눌러 뒤집어 보세요! <span style="color:#D97706;">🎟️ 1장 = 딱지 1개</span></p>
                    </div>
                    <!-- 그랜드 셀레브레이션 오버레이 -->
                    <div id="bingo-grand-overlay" style="display:none;position:absolute;inset:0;z-index:20;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);flex-direction:column;">
                        <div style="text-align:center;animation:grandAppear 0.8s cubic-bezier(0.34,1.56,0.64,1);">
                            <div style="font-size:72px;margin-bottom:12px;animation:grandSpin 2s ease-in-out infinite;">🏆</div>
                            <h3 class="font-noto" style="font-size:28px;font-weight:900;color:#FFD700;text-shadow:0 2px 16px rgba(255,215,0,0.5);margin-bottom:8px;">ALL CLEAR!</h3>
                            <p style="font-size:18px;color:#FDE68A;font-weight:700;">+10⭐ 그랜드 보너스!</p>
                            <p style="font-size:13px;color:rgba(255,255,255,0.8);margin-top:6px;">모든 딱지를 뒤집었어요!</p>
                            <button onclick="closeGrandCelebration()" style="margin-top:24px;padding:14px 40px;border-radius:16px;background:linear-gradient(135deg,#FFD700,#F59E0B);color:#78350F;font-weight:800;font-size:16px;border:none;cursor:pointer;box-shadow:0 4px 20px rgba(245,158,11,0.5);transition:all 0.2s;">
                                🎉 확인
                            </button>
                        </div>
                    </div>
                    <!-- 스타트 보너스 오버레이 -->
                    <div id="bingo-start-bonus" style="display:none;position:absolute;inset:0;z-index:25;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);flex-direction:column;">
                        <div class="start-bonus-box" style="text-align:center;padding:36px 32px 28px;border-radius:28px;background:linear-gradient(160deg,#FFFBEB,#FEF3C7,#FDE68A);box-shadow:0 20px 60px rgba(0,0,0,0.3),0 0 0 4px rgba(255,255,255,0.5),0 0 80px rgba(251,191,36,0.3);position:relative;overflow:hidden;">
                            <!-- 배경 반짝이 -->
                            <div class="bonus-sparkles" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;">
                                <div class="bonus-sparkle" style="position:absolute;top:15%;left:12%;font-size:14px;animation:bonusTwinkle 1.5s ease-in-out infinite 0s;">✨</div>
                                <div class="bonus-sparkle" style="position:absolute;top:10%;right:15%;font-size:12px;animation:bonusTwinkle 1.5s ease-in-out infinite 0.3s;">✨</div>
                                <div class="bonus-sparkle" style="position:absolute;bottom:20%;left:18%;font-size:10px;animation:bonusTwinkle 1.5s ease-in-out infinite 0.6s;">✨</div>
                                <div class="bonus-sparkle" style="position:absolute;bottom:15%;right:12%;font-size:13px;animation:bonusTwinkle 1.5s ease-in-out infinite 0.9s;">✨</div>
                                <div class="bonus-sparkle" style="position:absolute;top:50%;left:8%;font-size:11px;animation:bonusTwinkle 1.5s ease-in-out infinite 1.2s;">✨</div>
                            </div>
                            <!-- 선물 아이콘 -->
                            <div class="bonus-gift-icon" style="font-size:64px;margin-bottom:16px;animation:bonusGiftBounce 1s cubic-bezier(0.34,1.56,0.64,1) both;">🎁</div>
                            <!-- 텍스트 -->
                            <p class="font-noto" style="font-size:13px;color:#92400E;font-weight:700;margin-bottom:6px;opacity:0;animation:bonusTextFadeIn 0.5s ease 0.4s both;">새로운 주차 시작 보상!</p>
                            <p class="font-noto" style="font-size:22px;color:#78350F;font-weight:900;letter-spacing:-0.5px;margin-bottom:6px;opacity:0;animation:bonusTextFadeIn 0.5s ease 0.6s both;">스타트 딱지 <span style="color:#EA580C;">1개</span>를 드려요!</p>
                            <div style="display:inline-flex;align-items:center;gap:8px;background:white;padding:8px 20px;border-radius:20px;margin-top:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);opacity:0;animation:bonusTextFadeIn 0.5s ease 0.8s both;">
                                <span style="font-size:24px;">🎟️</span>
                                <span class="font-noto" style="font-size:20px;font-weight:900;color:#D97706;">+1</span>
                            </div>
                            <!-- 받기 버튼 -->
                            <div style="margin-top:22px;opacity:0;animation:bonusTextFadeIn 0.5s ease 1.0s both;">
                                <button onclick="claimStartBonus()" class="font-noto" style="padding:14px 48px;border-radius:18px;background:linear-gradient(135deg,#F59E0B,#D97706);color:white;font-weight:800;font-size:17px;border:none;cursor:pointer;box-shadow:0 4px 20px rgba(245,158,11,0.5),0 2px 0 #B45309;transition:all 0.15s;letter-spacing:0.5px;">
                                    🎉 받기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </section>
            <style>
                /* === 보상 버튼 (헤더) - 반짝반짝 === */
                .bingo-reward-btn {
                    position: relative;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    padding: 7px 14px;
                    border-radius: 20px;
                    border: 2px solid rgba(251,191,36,0.5);
                    background: linear-gradient(135deg, #FFFBEB, #FEF3C7, #FDE68A);
                    background-size: 200% 200%;
                    animation: rewardShimmerBg 3s ease infinite;
                    cursor: pointer;
                    outline: none;
                    box-shadow: 0 2px 8px rgba(251,191,36,0.25), 0 0 12px rgba(251,191,36,0.1);
                    transition: all 0.25s;
                    overflow: hidden;
                }
                .bingo-reward-btn:hover {
                    transform: translateY(-2px) scale(1.04);
                    box-shadow: 0 4px 16px rgba(251,191,36,0.4), 0 0 20px rgba(251,191,36,0.2);
                    border-color: rgba(251,191,36,0.8);
                }
                .bingo-reward-btn:active {
                    transform: scale(0.97);
                }
                @keyframes rewardShimmerBg {
                    0% { background-position: 0% 50%; }
                    50% { background-position: 100% 50%; }
                    100% { background-position: 0% 50%; }
                }
                /* 빛 줄기 효과 */
                .bingo-reward-shimmer {
                    position: absolute;
                    top: 0; left: -100%;
                    width: 60%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
                    animation: rewardSweep 2.5s ease-in-out infinite;
                    pointer-events: none;
                }
                @keyframes rewardSweep {
                    0% { left: -100%; }
                    50% { left: 150%; }
                    100% { left: 150%; }
                }
                /* 아이템 */
                .bingo-reward-item {
                    display: flex;
                    align-items: center;
                    gap: 3px;
                    position: relative;
                    z-index: 1;
                    font-size: 14px;
                    color: #92400E;
                }
                .bingo-reward-icon {
                    font-size: 15px;
                    filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
                }
                .bingo-reward-divider {
                    width: 1.5px;
                    height: 16px;
                    background: rgba(217,119,6,0.25);
                    border-radius: 1px;
                    position: relative;
                    z-index: 1;
                }
                /* 별 회전 */
                .bingo-star-spin {
                    animation: starTwinkle 2s ease-in-out infinite;
                }
                @keyframes starTwinkle {
                    0%, 100% { transform: scale(1) rotate(0deg); }
                    50% { transform: scale(1.2) rotate(15deg); }
                }
                /* 반짝이 파티클 */
                .bingo-reward-sparkle {
                    position: absolute;
                    font-size: 8px;
                    color: #F59E0B;
                    pointer-events: none;
                    z-index: 2;
                    animation: sparkleFloat 2s ease-in-out infinite;
                }
                .bingo-reward-sparkle.s1 { top: 2px; right: 8px; animation-delay: 0s; }
                .bingo-reward-sparkle.s2 { bottom: 2px; left: 10px; animation-delay: 0.7s; font-size: 6px; }
                .bingo-reward-sparkle.s3 { top: 50%; right: 28px; animation-delay: 1.3s; font-size: 7px; color: #FBBF24; }
                @keyframes sparkleFloat {
                    0%, 100% { opacity: 0; transform: scale(0.5) translateY(0); }
                    30% { opacity: 1; transform: scale(1.2) translateY(-3px); }
                    60% { opacity: 0.7; transform: scale(0.8) translateY(1px); }
                    80% { opacity: 0; transform: scale(0.3) translateY(-2px); }
                }

                /* === 헤더 보상 그룹 (선물상자 + 티켓/별) === */
                .header-rewards-group {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .header-reward-box {
                    width: 42px;
                    height: 42px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 22px;
                    cursor: pointer;
                    position: relative;
                    transition: all 0.3s;
                    flex-shrink: 0;
                }
                .header-reward-box.locked {
                    background: linear-gradient(145deg, #e5e7eb, #d1d5db);
                    border: 2px solid #9ca3af;
                    box-shadow: 0 2px 0 #9ca3af, 0 3px 6px rgba(0,0,0,0.1);
                    filter: grayscale(0.8);
                }
                .header-reward-box.locked::after {
                    content: '🔒';
                    position: absolute;
                    bottom: -3px;
                    right: -3px;
                    font-size: 11px;
                    background: #6b7280;
                    border-radius: 50%;
                    padding: 1px;
                    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
                }
                .header-reward-box.unlocked {
                    background: linear-gradient(145deg, #FEF3C7, #FDE68A, #FBBF24);
                    border: 2px solid #F59E0B;
                    box-shadow: 0 2px 0 #D97706, 0 4px 10px rgba(251,191,36,0.4);
                    animation: boxGlow 1.5s ease-in-out infinite, headerBoxBounce 0.8s ease-in-out infinite;
                    filter: none;
                }
                @keyframes headerBoxBounce {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.08); }
                }
                .header-reward-box.unlocked::before {
                    content: '';
                    position: absolute;
                    inset: -5px;
                    border-radius: 14px;
                    background: radial-gradient(circle, rgba(251,191,36,0.4), transparent 70%);
                    animation: pulseGlow 1.2s ease-in-out infinite;
                    pointer-events: none;
                }
                .header-reward-box.unlocked .box-sparkle {
                    position: absolute;
                    font-size: 8px;
                    color: #FBBF24;
                    animation: boxSparkle 1.5s ease-in-out infinite;
                    pointer-events: none;
                }
                .header-reward-box.unlocked .box-sparkle.sp1 { top: -6px; left: 50%; animation-delay: 0s; }
                .header-reward-box.unlocked .box-sparkle.sp2 { top: 50%; right: -8px; animation-delay: 0.3s; }
                .header-reward-box.unlocked .box-sparkle.sp3 { bottom: -6px; left: 50%; animation-delay: 0.6s; }
                .header-reward-box.unlocked .box-sparkle.sp4 { top: 50%; left: -8px; animation-delay: 0.9s; }
                .header-reward-box.claimed {
                    background: linear-gradient(145deg, #D1FAE5, #A7F3D0);
                    border: 2px solid #10B981;
                    box-shadow: 0 2px 0 #059669, 0 3px 6px rgba(16,185,129,0.2);
                    animation: none;
                    filter: none;
                }
                .header-reward-box.claimed::after {
                    content: '✓';
                    position: absolute;
                    bottom: -3px;
                    right: -3px;
                    font-size: 10px;
                    background: #10B981;
                    color: white;
                    border-radius: 50%;
                    padding: 2px 3px;
                    font-weight: bold;
                }

                /* === 보상 상자 (프로그래스바 옆) === */
                .reward-box-wrapper {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    width: 90%;
                    margin: 20px auto 0;
                }
                .reward-box-wrapper .step-progress-bar {
                    flex: 1;
                }
                .reward-box {
                    width: 48px;
                    height: 48px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 26px;
                    cursor: pointer;
                    position: relative;
                    transition: all 0.3s;
                    flex-shrink: 0;
                }
                /* 잠금 상태 */
                .reward-box.locked {
                    background: linear-gradient(145deg, #e5e7eb, #d1d5db);
                    border: 2px solid #9ca3af;
                    box-shadow: 0 3px 0 #9ca3af, 0 4px 8px rgba(0,0,0,0.1);
                    filter: grayscale(0.8);
                }
                .reward-box.locked::after {
                    content: '🔒';
                    position: absolute;
                    bottom: -4px;
                    right: -4px;
                    font-size: 14px;
                    background: #6b7280;
                    border-radius: 50%;
                    padding: 2px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                }
                /* 언락/빛나는 상태 */
                .reward-box.unlocked {
                    background: linear-gradient(145deg, #FEF3C7, #FDE68A, #FBBF24);
                    border: 2px solid #F59E0B;
                    box-shadow: 0 3px 0 #D97706, 0 4px 12px rgba(251,191,36,0.4);
                    animation: boxGlow 1.5s ease-in-out infinite, boxBounce 0.8s ease-in-out infinite;
                    filter: none;
                }
                .reward-box.unlocked::before {
                    content: '';
                    position: absolute;
                    inset: -6px;
                    border-radius: 16px;
                    background: radial-gradient(circle, rgba(251,191,36,0.4), transparent 70%);
                    animation: pulseGlow 1.2s ease-in-out infinite;
                    pointer-events: none;
                }
                /* 빛나는 파티클 */
                .reward-box.unlocked .box-sparkle {
                    position: absolute;
                    font-size: 10px;
                    color: #FBBF24;
                    animation: boxSparkle 1.5s ease-in-out infinite;
                    pointer-events: none;
                }
                .reward-box.unlocked .box-sparkle.sp1 { top: -8px; left: 50%; animation-delay: 0s; }
                .reward-box.unlocked .box-sparkle.sp2 { top: 50%; right: -10px; animation-delay: 0.3s; }
                .reward-box.unlocked .box-sparkle.sp3 { bottom: -8px; left: 50%; animation-delay: 0.6s; }
                .reward-box.unlocked .box-sparkle.sp4 { top: 50%; left: -10px; animation-delay: 0.9s; }
                @keyframes boxGlow {
                    0%, 100% { box-shadow: 0 3px 0 #D97706, 0 4px 12px rgba(251,191,36,0.4); }
                    50% { box-shadow: 0 3px 0 #D97706, 0 4px 20px rgba(251,191,36,0.7), 0 0 30px rgba(251,191,36,0.3); }
                }
                @keyframes boxBounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-4px); }
                }
                @keyframes pulseGlow {
                    0%, 100% { opacity: 0.5; transform: scale(1); }
                    50% { opacity: 1; transform: scale(1.1); }
                }
                @keyframes boxSparkle {
                    0%, 100% { opacity: 0; transform: scale(0.5); }
                    50% { opacity: 1; transform: scale(1.2); }
                }
                /* 열림 상태 (이미 획득) */
                .reward-box.claimed {
                    background: linear-gradient(145deg, #D1FAE5, #A7F3D0);
                    border: 2px solid #10B981;
                    box-shadow: 0 3px 0 #059669, 0 4px 8px rgba(16,185,129,0.2);
                    filter: none;
                    animation: none;
                }
                .reward-box.claimed::after {
                    content: '✓';
                    position: absolute;
                    bottom: -4px;
                    right: -4px;
                    font-size: 12px;
                    background: #10B981;
                    color: white;
                    border-radius: 50%;
                    width: 18px;
                    height: 18px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                }
                /* 클릭/획득 애니메이션 */
                .reward-box.claiming {
                    animation: boxClaim 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
                }
                @keyframes boxClaim {
                    0% { transform: scale(1); }
                    30% { transform: scale(1.3) rotate(-10deg); }
                    50% { transform: scale(0.9) rotate(5deg); }
                    70% { transform: scale(1.15) rotate(-3deg); }
                    100% { transform: scale(1) rotate(0deg); }
                }
                /* 티켓 획득 플로팅 */
                .ticket-float {
                    position: absolute;
                    font-size: 22px;
                    font-weight: 800;
                    color: #D97706;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    animation: ticketFloat 1.2s ease-out forwards;
                    pointer-events: none;
                    z-index: 100;
                    white-space: nowrap;
                }
                @keyframes ticketFloat {
                    0% { opacity: 1; transform: translateY(0) scale(0.5); }
                    20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
                    100% { opacity: 0; transform: translateY(-60px) scale(0.8); }
                }
                /* 헤더 보상 버튼 카운트 증가 효과 */
                .bingo-reward-item.counting {
                    animation: countPop 0.4s ease-out;
                }
                @keyframes countPop {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.3); color: #16a34a; }
                    100% { transform: scale(1); }
                }
                /* 토스트 애니메이션 */
                @keyframes toastSlideUp {
                    0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                    100% { opacity: 1; transform: translateX(-50%) translateY(0); }
                }
                @keyframes toastSlideDown {
                    0% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                }

                /* === 별딱지 빙고 - Duolingo/말해보카 Style === */

                /* 딱지 카드 */
                .bingo-card {
                    width:100%; aspect-ratio:1/1; cursor:pointer; position:relative;
                }
                .bingo-card-inner {
                    position:relative; width:100%; height:100%;
                    transform-style: preserve-3d;
                    transition: transform 0.15s ease;
                }
                /* 뒤집기 전: 들어올린 상태 */
                .bingo-card:not(.flipped):hover .bingo-card-inner {
                    transform: translateY(-4px);
                }
                .bingo-card:not(.flipped):active .bingo-card-inner {
                    transform: translateY(2px) scale(0.96);
                }
                /* 화투 탁! 뒤집기 애니메이션 */
                .bingo-card.flipping .bingo-card-inner {
                    animation: hwatu-flip 0.45s cubic-bezier(0.22, 1, 0.36, 1) forwards;
                }
                @keyframes hwatu-flip {
                    0% { transform: rotateY(0deg) scale(1); }
                    30% { transform: rotateY(100deg) scale(0.85) translateY(-12px); }
                    55% { transform: rotateY(180deg) scale(1.12) translateY(-6px); }
                    70% { transform: rotateY(180deg) scale(1.04) translateY(3px); }
                    85% { transform: rotateY(180deg) scale(1.01) translateY(-1px); }
                    100% { transform: rotateY(180deg) scale(1) translateY(0); }
                }
                /* 탁! 착지 임팩트 링 */
                .bingo-card.slap-impact::after {
                    content: '';
                    position: absolute;
                    inset: -8px;
                    border-radius: 20px;
                    border: 3px solid rgba(245,158,11,0.7);
                    animation: slap-ring 0.4s ease-out forwards;
                    pointer-events: none;
                    z-index: 10;
                }
                @keyframes slap-ring {
                    0% { transform: scale(0.8); opacity: 1; border-width: 3px; }
                    100% { transform: scale(1.15); opacity: 0; border-width: 1px; }
                }
                /* 플립 완료 후 고정 */
                .bingo-card.flipped .bingo-card-inner {
                    transform: rotateY(180deg);
                }
                .bingo-card-front, .bingo-card-back {
                    position:absolute; inset:0; border-radius:16px;
                    backface-visibility: hidden; -webkit-backface-visibility: hidden;
                    display:flex; align-items:center; justify-content:center; flex-direction:column;
                }
                /* 앞면: 뒤집기 전 - 빨간 딱지 (화투 뒷면 느낌) */
                .bingo-card-front {
                    background: linear-gradient(145deg, #DC2626, #B91C1C);
                    border: 3px solid #991B1B;
                    box-shadow: 0 6px 0 #7F1D1D, 0 8px 16px rgba(0,0,0,0.2);
                    font-size:32px;
                    color:white;
                    font-weight:900;
                }
                .bingo-card-front::before {
                    content: '';
                    position:absolute; inset:6px;
                    border: 1.5px solid rgba(255,255,255,0.2);
                    border-radius:12px;
                    pointer-events:none;
                }
                .bingo-card:not(.flipped):hover .bingo-card-front {
                    background: linear-gradient(145deg, #EF4444, #DC2626);
                    box-shadow: 0 8px 0 #7F1D1D, 0 12px 24px rgba(0,0,0,0.25);
                }
                /* 뒷면: 뒤집은 후 (별 결과) - 밝은 화이트/골드 */
                .bingo-card-back {
                    transform: rotateY(180deg);
                    border: 3px solid #F59E0B;
                    box-shadow: 0 4px 0 #D97706, 0 6px 16px rgba(0,0,0,0.12);
                    overflow: hidden;
                    padding: 4px;
                }
                .bingo-card.flipped.disabled { cursor:default; }

                /* 별 등급별 카드 뒷면 - 밝은 테마 */
                .star-1 .bingo-card-back { background: linear-gradient(145deg, #FFFFFF, #F9FAFB); border-color: #D1D5DB; box-shadow: 0 4px 0 #E5E7EB, 0 4px 12px rgba(0,0,0,0.08); }
                .star-2 .bingo-card-back { background: linear-gradient(145deg, #FFFBEB, #FEF3C7); border-color: #FCD34D; box-shadow: 0 4px 0 #FBBF24, 0 4px 12px rgba(0,0,0,0.08); }
                .star-3 .bingo-card-back { background: linear-gradient(145deg, #FFF7ED, #FFEDD5); border-color: #FB923C; box-shadow: 0 4px 0 #F97316, 0 0 16px rgba(251,146,60,0.2); }
                .star-4 .bingo-card-back { background: linear-gradient(145deg, #FEF3C7, #FDE68A); border-color: #F59E0B; box-shadow: 0 4px 0 #D97706, 0 0 24px rgba(245,158,11,0.3); }
                .star-5 .bingo-card-back { background: linear-gradient(145deg, #FEF2F2, #FECACA, #FDE68A); border-color: #EF4444; box-shadow: 0 4px 0 #DC2626, 0 0 30px rgba(239,68,68,0.3); animation: jackpotGlow 1.5s ease infinite; }
                @keyframes jackpotGlow {
                    0%, 100% { box-shadow: 0 4px 0 #DC2626, 0 0 20px rgba(239,68,68,0.3); }
                    50% { box-shadow: 0 4px 0 #DC2626, 0 0 40px rgba(239,68,68,0.5), 0 0 60px rgba(245,158,11,0.2); }
                }

                /* 별 텍스트 스타일 */
                .star-reveal { font-weight:900; letter-spacing: -0.5px; }

                /* 탁! 후 바운스 이펙트 */
                .bingo-card.effect-bounce .bingo-card-inner {
                    animation: card-bounce 0.3s cubic-bezier(0.34,1.56,0.64,1);
                }
                @keyframes card-bounce {
                    0% { transform: rotateY(180deg) scale(1); }
                    50% { transform: rotateY(180deg) scale(1.08); }
                    100% { transform: rotateY(180deg) scale(1); }
                }
                /* JACKPOT 화면 흔들림 */
                .bingo-card.effect-jackpot .bingo-card-inner {
                    animation: jackpot-shake 0.5s ease;
                }
                @keyframes jackpot-shake {
                    0%, 100% { transform: rotateY(180deg) translateX(0); }
                    15% { transform: rotateY(180deg) translateX(-4px) rotate(-1deg); }
                    30% { transform: rotateY(180deg) translateX(4px) rotate(1deg); }
                    45% { transform: rotateY(180deg) translateX(-3px) rotate(-0.5deg); }
                    60% { transform: rotateY(180deg) translateX(3px) rotate(0.5deg); }
                    75% { transform: rotateY(180deg) translateX(-2px); }
                }

                /* 빙고 라인 SVG 스타일 */
                .bingo-line {
                    stroke: #EF4444;
                    stroke-width: 5;
                    stroke-linecap: round;
                    fill: none;
                    filter: drop-shadow(0 0 6px rgba(239,68,68,0.5));
                    stroke-dasharray: 500;
                    stroke-dashoffset: 500;
                    animation: draw-line 0.6s ease forwards;
                }
                @keyframes draw-line {
                    to { stroke-dashoffset: 0; }
                }

                /* 빙고 라인 카드 하이라이트 */
                .bingo-card.bingo-line-highlight .bingo-card-back {
                    box-shadow: 0 4px 0 #DC2626, 0 0 20px rgba(239,68,68,0.4);
                    border-color: #EF4444;
                }

                /* 빙고 축하 알림 팝업 */
                @keyframes bingoCelebPop {
                    0% { transform: translate(-50%, 60px) scale(0.8); opacity: 0; }
                    70% { transform: translate(-50%, -54%) scale(1.05); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                }
                @keyframes bingoCelebFadeOut {
                    0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    100% { transform: translate(-50%, -50%) translateY(-30px) scale(0.9); opacity: 0; }
                }

                /* 그랜드 셀레브레이션 */
                @keyframes grandAppear {
                    0% { transform:scale(0) rotate(-20deg); opacity:0; }
                    60% { transform:scale(1.1) rotate(5deg); opacity:1; }
                    100% { transform:scale(1) rotate(0deg); opacity:1; }
                }
                @keyframes grandSpin {
                    0%, 100% { transform:rotate(0deg) scale(1); }
                    25% { transform:rotate(-10deg) scale(1.1); }
                    75% { transform:rotate(10deg) scale(1.1); }
                }

                /* 플로팅 보상 텍스트 */
                @keyframes floatUp {
                    0% { transform: translateX(-50%) translateY(0) scale(1); opacity:1; }
                    100% { transform: translateX(-50%) translateY(-70px) scale(1.3); opacity:0; }
                }
                .bingo-float-reward {
                    position:absolute; font-size:20px; font-weight:900; pointer-events:none;
                    animation: floatUp 1.2s ease-out forwards; z-index:30;
                    text-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    color: #92400E;
                }

                /* 폭죽 파티클 */
                @keyframes bingoConfetti {
                    0% { transform:translate(0,0) scale(0) rotate(0deg); opacity:1; }
                    100% { transform:translate(var(--tx), var(--ty)) scale(1) rotate(var(--tr)); opacity:0; }
                }
                .bingo-confetti {
                    position:absolute; width:8px; height:8px; border-radius:2px;
                    animation: bingoConfetti 1s ease-out forwards;
                }

                /* 빙고 토스트 알림 */
                .bingo-toast {
                    display: none;
                    position: fixed;
                    z-index: 9999;
                    padding: 10px 18px;
                    border-radius: 14px;
                    background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
                    border: 1.5px solid #F59E0B;
                    box-shadow: 0 6px 24px rgba(245,158,11,0.25), 0 2px 6px rgba(0,0,0,0.08);
                    font-family: 'Noto Sans KR', sans-serif;
                    font-size: 13px;
                    font-weight: 800;
                    color: #92400E;
                    white-space: nowrap;
                    pointer-events: none;
                }
                .bingo-toast.show {
                    display: block;
                    animation: bingoToastIn 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards;
                }
                .bingo-toast.hide {
                    animation: bingoToastOut 0.35s ease-out forwards;
                }
                @keyframes bingoToastIn {
                    0% { opacity: 0; transform: translateX(-50%) translateY(-8px) scale(0.9); }
                    100% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
                }
                @keyframes bingoToastOut {
                    0% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(6px) scale(0.95); }
                }

                /* 딱지 부족 흔들림 */
                @keyframes noOrbShake {
                    0%, 100% { transform:translateX(0); }
                    20% { transform:translateX(-6px); }
                    40% { transform:translateX(6px); }
                    60% { transform:translateX(-4px); }
                    80% { transform:translateX(4px); }
                }

                /* 스타트 보너스 애니메이션 */
                @keyframes bonusGiftBounce {
                    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
                    50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
                    70% { transform: scale(0.9) rotate(-3deg); }
                    100% { transform: scale(1) rotate(0deg); opacity: 1; }
                }
                @keyframes bonusTextFadeIn {
                    0% { opacity: 0; transform: translateY(12px); }
                    100% { opacity: 1; transform: translateY(0); }
                }
                @keyframes bonusTwinkle {
                    0%, 100% { opacity: 0.3; transform: scale(0.8); }
                    50% { opacity: 1; transform: scale(1.2); }
                }
                @keyframes bonusBoxAppear {
                    0% { transform: scale(0.7); opacity: 0; }
                    100% { transform: scale(1); opacity: 1; }
                }
                .start-bonus-box {
                    animation: bonusBoxAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
                }
            </style>

            <!-- Elegant Recommendations Section -->
            <section class="netflix-recommendations" id="recommend-section">
                <!-- Section Header -->
                <div class="netflix-header">
                    <div class="netflix-title-wrapper">
                        <div class="title-icon-wrapper">
                            <span class="title-sparkle">✨</span>
                            <h2 class="netflix-title">우희를 위한 추천 도서</h2>
                        </div>
                        <p class="netflix-subtitle">AI가 학습 패턴을 분석해 골라낸 맞춤 책</p>
                    </div>
                    <button class="netflix-view-all" onclick="alert('전체 추천 도서 보기 (준비중)')">
                        모두 보기
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Books Grid Container -->
                <div class="netflix-books-grid">
                    <!-- Book Card 1 -->
                    <div class="netflix-book-card-horizontal">
                        <div class="netflix-card-thumbnail">
                            <img src="../img/book-recommend-1.svg" alt="숲속 친구들">
                            <div class="netflix-card-match">
                                <i class="fa-solid fa-heart"></i>
                                <span>92%</span>
                            </div>
                        </div>
                        <div class="netflix-card-info">
                            <div class="netflix-card-ai-reason">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                <span>코어북 주제와 연결된 책이에요</span>
                            </div>
                            <div class="netflix-card-header">
                                <h3>숲속 친구들</h3>
                                <div class="netflix-card-meta">
                                    <span class="meta-badge orange">
                                        <i class="fa-solid fa-clock"></i>
                                        15분
                                    </span>
                                    <span class="meta-badge green">
                                        <i class="fa-solid fa-tag"></i>
                                        자연·동물
                                    </span>
                                </div>
                            </div>
                            <p class="netflix-card-desc">동물 친구들의 따뜻한 우정 이야기. 이번 주 코어북의 '우정' 주제를 더 깊이 탐구해보세요.</p>
                            <div class="netflix-card-tags">
                                <span>우정</span>
                                <span>감성</span>
                                <span>자연</span>
                            </div>
                            <div class="netflix-card-actions">
                                <a href="book-viewer-clean.html" class="netflix-btn-primary">
                                    <i class="fa-solid fa-book-open"></i>
                                    <span>읽기 시작</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Book Card 2 -->
                    <div class="netflix-book-card-horizontal">
                        <div class="netflix-card-thumbnail">
                            <img src="../img/book-recommend-2.svg" alt="우주 탐험대">
                            <div class="netflix-card-match purple">
                                <i class="fa-solid fa-star"></i>
                                <span>88%</span>
                            </div>
                        </div>
                        <div class="netflix-card-info">
                            <div class="netflix-card-ai-reason purple">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                <span>모험을 좋아하는 우희에게 추천해요</span>
                            </div>
                            <div class="netflix-card-header">
                                <h3>우주 탐험대</h3>
                                <div class="netflix-card-meta">
                                    <span class="meta-badge purple">
                                        <i class="fa-solid fa-clock"></i>
                                        20분
                                    </span>
                                    <span class="meta-badge blue">
                                        <i class="fa-solid fa-tag"></i>
                                        과학·모험
                                    </span>
                                </div>
                            </div>
                            <p class="netflix-card-desc">신비로운 우주를 여행하는 모험 이야기. 상상력을 키우고 과학 지식도 함께 배워요.</p>
                            <div class="netflix-card-tags">
                                <span>모험</span>
                                <span>상상력</span>
                                <span>과학</span>
                            </div>
                            <div class="netflix-card-actions">
                                <a href="book-viewer-clean.html" class="netflix-btn-primary purple">
                                    <i class="fa-solid fa-book-open"></i>
                                    <span>읽기 시작</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Book Card 3 - Hidden by default, shown when week is collapsed -->
                    <div class="netflix-book-card-horizontal extra-book" style="display: none;">
                        <div class="netflix-card-thumbnail">
                            <img src="../img/book-recommend-3.svg" alt="마법의 정원">
                            <div class="netflix-card-match pink">
                                <i class="fa-solid fa-sparkles"></i>
                                <span>85%</span>
                            </div>
                        </div>
                        <div class="netflix-card-info">
                            <div class="netflix-card-ai-reason pink">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                <span>창의력을 키우는 환상 동화예요</span>
                            </div>
                            <div class="netflix-card-header">
                                <h3>마법의 정원</h3>
                                <div class="netflix-card-meta">
                                    <span class="meta-badge pink">
                                        <i class="fa-solid fa-clock"></i>
                                        18분
                                    </span>
                                    <span class="meta-badge purple">
                                        <i class="fa-solid fa-tag"></i>
                                        판타지·마법
                                    </span>
                                </div>
                            </div>
                            <p class="netflix-card-desc">신비로운 마법 정원에서 펼쳐지는 모험. 상상력과 창의력이 자라나는 이야기예요.</p>
                            <div class="netflix-card-tags">
                                <span>판타지</span>
                                <span>창의력</span>
                                <span>마법</span>
                            </div>
                            <div class="netflix-card-actions">
                                <a href="book-viewer-clean.html" class="netflix-btn-primary pink">
                                    <i class="fa-solid fa-book-open"></i>
                                    <span>읽기 시작</span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Book Card 4 - Hidden by default, shown when week is collapsed -->
                    <div class="netflix-book-card-horizontal extra-book" style="display: none;">
                        <div class="netflix-card-thumbnail">
                            <img src="../img/book-recommend-4.svg" alt="바다 탐험가">
                            <div class="netflix-card-match teal">
                                <i class="fa-solid fa-fish"></i>
                                <span>82%</span>
                            </div>
                        </div>
                        <div class="netflix-card-info">
                            <div class="netflix-card-ai-reason teal">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                <span>자연을 사랑하는 우희에게 추천해요</span>
                            </div>
                            <div class="netflix-card-header">
                                <h3>바다 탐험가</h3>
                                <div class="netflix-card-meta">
                                    <span class="meta-badge teal">
                                        <i class="fa-solid fa-clock"></i>
                                        16분
                                    </span>
                                    <span class="meta-badge blue">
                                        <i class="fa-solid fa-tag"></i>
                                        자연·해양
                                    </span>
                                </div>
                            </div>
                            <p class="netflix-card-desc">깊고 넓은 바다 속 세계를 탐험하는 이야기. 해양 생물과 환경을 배워요.</p>
                            <div class="netflix-card-tags">
                                <span>자연</span>
                                <span>해양</span>
                                <span>탐험</span>
                            </div>
                            <div class="netflix-card-actions">
                                <a href="book-viewer-clean.html" class="netflix-btn-primary teal">
                                    <i class="fa-solid fa-book-open"></i>
                                    <span>읽기 시작</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <style>
            /* ===== Elegant Recommendations Section ===== */
            .netflix-recommendations {
                margin-bottom: 3rem;
                padding: 0;
            }

            /* Section Header */
            .netflix-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 2rem;
                padding: 0 4px;
            }

            .netflix-title-wrapper {
                flex: 1;
            }

            .title-icon-wrapper {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 6px;
            }

            .title-sparkle {
                font-size: 24px;
                animation: sparkle 2s ease-in-out infinite;
            }

            @keyframes sparkle {
                0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
                50% { opacity: 0.7; transform: scale(1.1) rotate(15deg); }
            }

            .netflix-title {
                font-family: 'Noto Sans KR', sans-serif;
                font-size: 26px;
                font-weight: 800;
                color: #1a1a2e;
                margin: 0;
                letter-spacing: -0.5px;
                background: linear-gradient(135deg, #FF9F43 0%, #f97316 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .netflix-subtitle {
                font-size: 14px;
                color: #9ca3af;
                margin: 0;
                font-weight: 500;
            }

            .netflix-view-all {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 10px 18px;
                background: linear-gradient(135deg, #FFF5EB 0%, #FFE4CC 100%);
                border: 2px solid #FFD4A3;
                border-radius: 24px;
                font-size: 14px;
                font-weight: 700;
                color: #FF9F43;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .netflix-view-all:hover {
                background: linear-gradient(135deg, #FFE4CC 0%, #FFD4A3 100%);
                border-color: #FFBA7A;
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(255, 159, 67, 0.2);
            }

            /* Books Grid Container */
            .netflix-books-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                padding: 0 4px;
            }

            /* When only 2 books (default state) - 1x2 layout */
            .netflix-books-grid:not(.expanded) {
                grid-template-columns: repeat(2, 1fr);
            }

            /* When 4 books (expanded state) - 2x2 layout */
            .netflix-books-grid.expanded {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Book Card - Elegant Horizontal Layout */
            .netflix-book-card-horizontal {
                display: flex;
                flex: 1;
                background: white;
                border-radius: 24px;
                overflow: hidden;
                border: 2px solid transparent;
                box-shadow: 0 6px 24px rgba(0, 0, 0, 0.06);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                height: 260px;
                min-width: 0;
                position: relative;
            }

            .netflix-book-card-horizontal::before {
                content: '';
                position: absolute;
                inset: 0;
                border-radius: 24px;
                padding: 2px;
                background: linear-gradient(135deg, #FFE4CC 0%, #C7D2FE 100%);
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: xor;
                mask-composite: exclude;
                opacity: 0;
                transition: opacity 0.4s;
            }

            .netflix-book-card-horizontal:hover {
                transform: translateY(-6px);
                box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
            }

            .netflix-book-card-horizontal:hover::before {
                opacity: 1;
            }

            /* Thumbnail Area */
            .netflix-card-thumbnail {
                position: relative;
                flex: 0 0 160px;
                overflow: hidden;
            }

            .netflix-card-thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .netflix-book-card-horizontal:hover .netflix-card-thumbnail img {
                transform: scale(1.05);
            }

            /* Match Badge */
            .netflix-card-match {
                position: absolute;
                top: 12px;
                right: 12px;
                display: flex;
                align-items: center;
                gap: 4px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(12px);
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 800;
                color: #FF9F43;
                box-shadow: 0 4px 12px rgba(255, 159, 67, 0.2);
            }

            .netflix-card-match i {
                font-size: 11px;
            }

            .netflix-card-match.purple {
                color: #8b5cf6;
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
            }

            .netflix-card-match.pink {
                color: #F472B6;
                box-shadow: 0 4px 12px rgba(244, 114, 182, 0.2);
            }

            .netflix-card-match.teal {
                color: #14B8A6;
                box-shadow: 0 4px 12px rgba(20, 184, 166, 0.2);
            }

            /* Card Info Area */
            .netflix-card-info {
                flex: 1;
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                overflow: hidden;
            }

            /* AI Reason Badge */
            .netflix-card-ai-reason {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 12px;
                background: linear-gradient(135deg, #FFF5EB 0%, #FFE4CC 100%);
                border-radius: 12px;
                border: 1px solid #FFD4A3;
            }

            .netflix-card-ai-reason.purple {
                background: linear-gradient(135deg, #F0F4FF 0%, #E0E7FF 100%);
                border-color: #C7D2FE;
            }

            .netflix-card-ai-reason.pink {
                background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E6 100%);
                border-color: #FFC1CC;
            }

            .netflix-card-ai-reason.teal {
                background: linear-gradient(135deg, #F0FDFA 0%, #CCFBF1 100%);
                border-color: #99F6E4;
            }

            .netflix-card-ai-reason i {
                color: #FF9F43;
                font-size: 14px;
                flex-shrink: 0;
            }

            .netflix-card-ai-reason.purple i {
                color: #8b5cf6;
            }

            .netflix-card-ai-reason.pink i {
                color: #F472B6;
            }

            .netflix-card-ai-reason.teal i {
                color: #14B8A6;
            }

            .netflix-card-ai-reason span {
                font-size: 11px;
                font-weight: 700;
                color: #92400e;
                line-height: 1.4;
            }

            .netflix-card-ai-reason.purple span {
                color: #5b21b6;
            }

            .netflix-card-ai-reason.pink span {
                color: #831843;
            }

            .netflix-card-ai-reason.teal span {
                color: #134e4a;
            }

            /* Card Header */
            .netflix-card-header h3 {
                font-family: 'Noto Sans KR', sans-serif;
                font-size: 19px;
                font-weight: 800;
                color: #1a1a2e;
                margin: 0 0 8px 0;
                line-height: 1.3;
            }

            .netflix-card-meta {
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
                margin-bottom: 6px;
            }

            /* Meta Badges */
            .meta-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 5px 10px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 700;
                border: 1.5px solid;
            }

            .meta-badge i {
                font-size: 10px;
            }

            .meta-badge.orange {
                background: #FFF5EB;
                color: #FF9F43;
                border-color: #FFD4A3;
            }

            .meta-badge.green {
                background: #F0FDF4;
                color: #10b981;
                border-color: #86efac;
            }

            .meta-badge.purple {
                background: #F0F4FF;
                color: #8b5cf6;
                border-color: #C7D2FE;
            }

            .meta-badge.blue {
                background: #EFF6FF;
                color: #3b82f6;
                border-color: #93C5FD;
            }

            .meta-badge.pink {
                background: #FFF0F5;
                color: #F472B6;
                border-color: #FFC1CC;
            }

            .meta-badge.teal {
                background: #F0FDFA;
                color: #14B8A6;
                border-color: #99F6E4;
            }

            /* Description */
            .netflix-card-desc {
                font-size: 12px;
                line-height: 1.6;
                color: #6b7280;
                margin: 0;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            /* Tags */
            .netflix-card-tags {
                display: flex;
                gap: 6px;
                flex-wrap: wrap;
            }

            .netflix-card-tags span {
                padding: 4px 10px;
                background: #f9fafb;
                color: #6b7280;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                font-size: 10px;
                font-weight: 600;
                transition: all 0.2s;
            }

            .netflix-card-tags span:hover {
                background: #f3f4f6;
                border-color: #d1d5db;
            }

            /* Action Buttons */
            .netflix-card-actions {
                display: flex;
                gap: 8px;
                margin-top: auto;
            }

            .netflix-btn-primary {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 12px 20px;
                background: linear-gradient(135deg, #FF9F43 0%, #f97316 100%);
                color: white;
                border: none;
                border-radius: 14px;
                font-size: 13px;
                font-weight: 800;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                text-decoration: none;
                box-shadow: 0 4px 16px rgba(255, 159, 67, 0.3);
            }

            .netflix-btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 24px rgba(255, 159, 67, 0.4);
                background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            }

            .netflix-btn-primary.purple {
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
            }

            .netflix-btn-primary.purple:hover {
                background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
                box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
            }

            .netflix-btn-primary.pink {
                background: linear-gradient(135deg, #F472B6 0%, #EC4899 100%);
                box-shadow: 0 4px 16px rgba(244, 114, 182, 0.3);
            }

            .netflix-btn-primary.pink:hover {
                background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%);
                box-shadow: 0 8px 24px rgba(244, 114, 182, 0.4);
            }

            .netflix-btn-primary.teal {
                background: linear-gradient(135deg, #2DD4BF 0%, #14B8A6 100%);
                box-shadow: 0 4px 16px rgba(20, 184, 166, 0.3);
            }

            .netflix-btn-primary.teal:hover {
                background: linear-gradient(135deg, #14B8A6 0%, #0F766E 100%);
                box-shadow: 0 8px 24px rgba(20, 184, 166, 0.4);
            }

            .netflix-btn-primary i {
                font-size: 13px;
            }

            @media (max-width: 768px) {
                .netflix-title {
                    font-size: 20px;
                }

                .netflix-subtitle {
                    font-size: 12px;
                }

                /* 모바일에서 세로 배치 (1열) */
                .netflix-books-grid,
                .netflix-books-grid.expanded {
                    grid-template-columns: 1fr;
                }

                .netflix-book-card-horizontal {
                    height: 210px;
                }

                .netflix-card-thumbnail {
                    flex: 0 0 120px;
                }

                .netflix-card-info {
                    padding: 14px;
                }

                .netflix-card-header h3 {
                    font-size: 15px;
                }

                .netflix-card-desc {
                    font-size: 11px;
                    -webkit-line-clamp: 1;
                    line-clamp: 1;
                }

                .netflix-btn-primary {
                    font-size: 11px;
                    padding: 8px 12px;
                }

                .netflix-btn-secondary {
                    width: 32px;
                    height: 32px;
                    font-size: 13px;
                }
            }
            </style>

                      </div>
        </main>
    </div>

    <!-- 또또 캐릭터 팝업 (우측 하단, 큰 캐릭터) -->
    <div id="ttotto-popup" class="hidden" onclick="hideTtottoPopup()" style="position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.25);display:none;align-items:flex-end;justify-content:flex-end;padding:24px;">
        <div class="ttotto-container" onclick="event.stopPropagation()" style="position:relative;display:flex;flex-direction:column;align-items:center;animation:ttottoPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
            <!-- 말풍선 (캐릭터 위에 표시) -->
            <div class="ttotto-speech" style="position:relative;background:white;border-radius:24px;padding:18px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);max-width:260px;margin-bottom:16px;animation:speechFadeIn 0.4s ease 0.2s both;">
                <!-- 말풍선 꼬리 (아래 방향) -->
                <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:14px solid white;"></div>
                <p style="font-family:'Noto Sans KR',sans-serif;font-size:16px;font-weight:600;color:#374151;line-height:1.6;margin:0;text-align:center;">안녕, 반가워!<br>코어북을 먼저 읽어보자!</p>
            </div>
            <!-- 또또 캐릭터 (화면 35% 크기) -->
            <div class="ttotto-character" style="width:35vh;height:35vh;min-width:200px;min-height:200px;max-width:380px;max-height:380px;filter:drop-shadow(0 12px 36px rgba(0,0,0,0.25));animation:ttottoBounce 2s ease-in-out infinite;">
                <img src="../img/EHEH.png" alt="또또" style="width:100%;height:100%;object-fit:contain;" onerror="this.innerHTML='🐿️'">
            </div>
        </div>
    </div>

    <!-- 추천 도서 4권 EHEH 캐릭터 팝업 -->
    <div id="ttotto-recommend-popup" class="hidden" onclick="hideTtottoRecommendPopup()" style="position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.25);display:none;align-items:flex-end;justify-content:flex-end;padding:24px;">
        <div class="ttotto-container" onclick="event.stopPropagation()" style="position:relative;display:flex;flex-direction:column;align-items:center;animation:ttottoPopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
            <!-- 말풍선 (캐릭터 위에 표시) -->
            <div class="ttotto-speech" style="position:relative;background:white;border-radius:24px;padding:18px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);max-width:280px;margin-bottom:16px;animation:speechFadeIn 0.4s ease 0.2s both;">
                <!-- 말풍선 꼬리 (아래 방향) -->
                <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:14px solid white;"></div>
                <p style="font-family:'Noto Sans KR',sans-serif;font-size:16px;font-weight:600;color:#374151;line-height:1.6;margin:0;text-align:center;">우와~ 추천 책이 많아졌는걸~?<br>이제부터는 자유롭게<br>책을 읽어보자!</p>
            </div>
            <!-- 또또 캐릭터 (화면 35% 크기) -->
            <div class="ttotto-character" style="width:35vh;height:35vh;min-width:200px;min-height:200px;max-width:380px;max-height:380px;filter:drop-shadow(0 12px 36px rgba(0,0,0,0.25));animation:ttottoBounce 2s ease-in-out infinite;">
                <img src="../img/EHEH.png" alt="EHEH" style="width:100%;height:100%;object-fit:contain;" onerror="this.innerHTML='🐿️'">
            </div>
        </div>
    </div>
    <style>
        @keyframes ttottoPopIn {
            0% { opacity:0; transform:translateY(100px) scale(0.3); }
            60% { transform:translateY(-20px) scale(1.05); }
            100% { opacity:1; transform:translateY(0) scale(1); }
        }
        @keyframes ttottoBounce {
            0%, 100% { transform:translateY(0); }
            50% { transform:translateY(-12px); }
        }
        @keyframes speechFadeIn {
            0% { opacity:0; transform:translateY(10px); }
            100% { opacity:1; transform:translateY(0); }
        }
        #ttotto-popup.hidden { display:none !important; }
    </style>

    <!-- Logout Modal Container -->
    <div id="logout-modal-container"></div>

    <!-- Scripts -->
    <script src="../js/common.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
        // ===== 주차별 커리큘럼 데이터 =====
        const weeklyData = {
            1: {
                // 코어북/관리이북 (메인)
                core: {
                    type: 'core', bookType: '코어북',
                    book: { title: '오즈의 마법사', author: '바움', desc: '회오리바람에 날려간 도로시의 신비로운 모험 이야기', level: 'K2-1' },
                    excerpt: '쿵! 마침내 회오리바람이 멈추고 집이 땅에 떨어졌어요.\n도로시가 집 밖으로 나오자 지팡이를 든 할머니가 다가왔어요.\n"여기는 오즈의 나라란다. 넌 나쁜 마녀를 물리쳤어!"',
                    coverImg: '../img/book1.jpg',
                    steps: ['book', 'quiz', 'vocab'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 4
                },
                // 교과서 짝꿍책 (어휘챌린지 없음)
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '오늘은 용돈 받는 날', author: '연유진', desc: '국어 2-1 1단원 연계 · 용돈 관리의 첫걸음 경제 동화', level: 'K2-1' },
                    excerpt: '현우는 처음으로 용돈을 받았어요.\n"와, 이 돈으로 뭘 살까?" 눈이 반짝반짝!\n인형 뽑기에 돈을 쓰고, 과자도 사고...\n그런데 친구 생일에 선물을 살 돈이 없었어요!',
                    coverImg: '../img/book1-1.jpg',
                    subject: '국어 2-1', unit: '1단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 4
                }
            },
            2: {
                core: {
                    type: 'managed', bookType: '관리이북',
                    book: { title: '약속은 즐거워', author: '박은경', desc: '약속과 규칙의 소중함을 배우는 생활 동화', level: 'K1-1' },
                    excerpt: '은지는 친구들과 함께 유치원에서 즐거운 하루를 보내요.\n"우리 모두 차례차례 줄을 서자!" 약속을 지키니까\n놀이시간이 더 즐거워졌어요.',
                    coverImg: '../img/book2.jpg',
                    steps: ['book', 'quiz', 'retelling', 'vocab'], hasRetelling: true,
                    currentBookPage: 1, totalPages: 4
                },
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '젓가락 달인', author: '유타루', desc: '국어 2-1 2단원 연계 · 젓가락 달인 대회 도전기', level: 'K2-1' },
                    excerpt: '우리 반에서 젓가락 달인 대회가 열렸어요!\n30초 안에 콩을 열 개 옮기면 달인이 되는 거예요.\n우봉이는 투덜거렸어요. "에이, 포크가 더 편한데..."\n그때 할아버지의 멋진 젓가락질을 보고 깜짝 놀랐어요!',
                    coverImg: '../img/book2-1.jpg',
                    subject: '국어 2-1', unit: '2단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 4
                }
            },
            3: {
                core: {
                    type: 'core', bookType: '코어북',
                    book: { title: '숭숭이와 나', author: '지윤경', desc: '특별한 친구와 함께 자라는 우정 이야기', level: 'K3-1' },
                    excerpt: '숭숭이는 나만 알아보는 특별한 친구예요.\n오늘도 숭숭이와 나란히 걸으며 이야기를 나눴어요.\n"우리 내일도 같이 놀자!" 숭숭이가 고개를 끄덕였어요.',
                    coverImg: '../img/book3.jpg',
                    steps: ['book', 'quiz', 'vocab'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 4
                },
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '감자꽃', author: '권태응', desc: '국어 2-1 3단원 연계 · 자연과 동심을 노래한 동시집', level: 'K2-1' },
                    excerpt: '자주꽃 핀 건 자주 감자\n파 보나 마나 자주 감자\n하얀꽃 핀 건 하얀 감자\n파 보나 마나 하얀 감자',
                    coverImg: '../img/book3-1.jpg',
                    subject: '국어 2-1', unit: '3단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 4
                }
            },
            4: {
                core: {
                    type: 'managed', bookType: '관리이북',
                    book: { title: '빨간머리 앤', author: '몽고메리', desc: '상상력 넘치는 소녀 앤의 초록 지붕 집 이야기', level: 'K5' },
                    excerpt: '매슈 아저씨가 데려온 건 남자아이가 아니라 빨간 머리 소녀였어요!\n"저를 앤이라고 불러주세요. e가 붙은 Anne요!"\n앤은 초록 지붕 집에서 새로운 가족과 생활을 시작했어요.',
                    coverImg: '../img/book4.jpg',
                    steps: ['book', 'quiz', 'retelling', 'vocab'], hasRetelling: true,
                    currentBookPage: 1, totalPages: 4
                },
                textbook: {
                    type: 'textbook', bookType: '교과서 짝꿍책',
                    book: { title: '퍼펙트 아이돌 클럽', author: '신지영', desc: '국어 2-1 4단원 연계 · 진정한 우정과 관계 맺기', level: 'K2-1' },
                    excerpt: '서영이는 할 말은 꼭 하는 직설녀예요.\n"그건 아니야!" 거침없이 말해 버리죠.\n승한이는 뭐든 들어주는 예스맨이에요.\n그런 두 사람이 반에서 왕따가 되다니...',
                    coverImg: '../img/book4-1.jpg',
                    subject: '국어 2-1', unit: '4단원',
                    steps: ['book', 'quiz'], hasRetelling: false,
                    currentBookPage: 1, totalPages: 4
                }
            }
        };

        let currentWeek = 1;
        let currentPage = 0;
        let currentBookType = 'core'; // 'core' or 'textbook'
        let hasAutoSwitchedWeeks = {}; // 주차별 자동전환 여부 기록
        let isReReadingMode = false; // 다시 읽기 모드

        // ===== 현재 선택된 책 데이터 가져오기 =====
        function getCurrentBookData() {
            return weeklyData[currentWeek][currentBookType];
        }

        // ===== Book Type Switching =====
        function switchBookType(bookType) {
            if (currentBookType === bookType) return;

            // 교과서 짝꿍책은 항상 선택 가능 (단, 읽기 버튼만 잠금)
            currentBookType = bookType;
            currentPage = 0;

            // 탭 활성화 상태 업데이트
            document.querySelectorAll('.book-type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.bookType === bookType);
            });

            // 배경색 변경 (코어북: 주황, 교과서짝꿍책: 초록)
            const carouselWrapper = document.getElementById('carousel-wrapper');
            if (bookType === 'textbook') {
                carouselWrapper.style.background = '#F0FDF4'; // 연한 초록
            } else {
                carouselWrapper.style.background = '#FFF8F0'; // 연한 주황
            }

            // 프로그래스바 즉시 리셋 (전환 효과 제거 후 0%로) - 모든 페이지
            document.querySelectorAll('.step-gauge').forEach(g => {
                g.classList.add('instant-reset');
                g.style.width = '0%';
            });

            // 다음 프레임에서 전환 효과 복원 후 새 진행률 적용
            requestAnimationFrame(() => {
                setTimeout(() => {
                    document.querySelectorAll('.step-gauge').forEach(g => {
                        g.classList.remove('instant-reset');
                    });
                    // 책 정보 업데이트
                    updateBookDisplay();
                    updateLearningProgress();
                }, 50);
            });
        }

        function updateBookTypeTabs() {
            const coreData = weeklyData[currentWeek].core;
            const textbookData = weeklyData[currentWeek].textbook;

            // 탭 제목 업데이트
            document.getElementById('core-book-title').textContent = coreData.book.title;
            document.getElementById('textbook-book-title').textContent = textbookData.subject + ' 연계';

            // 탭 라벨 업데이트 (코어북 vs 관리이북)
            const coreTab = document.querySelector('.book-type-tab.core');
            coreTab.querySelector('.tab-label').textContent = coreData.bookType;

            // 활성화 상태 업데이트
            document.querySelectorAll('.book-type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.bookType === currentBookType);
            });

            // 교과서 짝꿍책 탭은 항상 활성화 (읽기 버튼만 잠금 처리)
            const textbookTab = document.querySelector('.book-type-tab.textbook');
            textbookTab.style.opacity = '1';
            textbookTab.style.cursor = 'pointer';
            const lockIndicator = textbookTab.querySelector('.tab-lock');
            if (lockIndicator) lockIndicator.remove();

            // 진행 상태 배지 업데이트
            updateBookTypeBadges();
        }

        function updateBookTypeBadges() {
            const coreProgress = getWeekProgress(currentWeek + '_core') || {};
            const textbookProgress = getWeekProgress(currentWeek + '_textbook') || {};

            const coreBadge = document.getElementById('core-badge');
            const textbookBadge = document.getElementById('textbook-badge');

            // 코어북 배지
            if (coreProgress.allComplete) {
                coreBadge.innerHTML = '<i class="fa-solid fa-check"></i>';
                coreBadge.classList.remove('incomplete');
                coreBadge.style.display = 'flex';
            } else {
                coreBadge.innerHTML = '<i class="fa-solid fa-ellipsis"></i>';
                coreBadge.classList.add('incomplete');
                coreBadge.style.display = 'flex';
            }

            // 교과서 짝꿍책 배지
            if (textbookProgress.allComplete) {
                textbookBadge.innerHTML = '<i class="fa-solid fa-check"></i>';
                textbookBadge.classList.remove('incomplete');
                textbookBadge.style.display = 'flex';
            } else {
                textbookBadge.style.display = 'none';
            }
        }

        function updateBookDisplay() {
            const data = getCurrentBookData();
            const progressKey = currentWeek + '_' + currentBookType;
            const bookData = getWeekBookData(progressKey);

            // bookData에서 currentBookPage 가져오기 (저장된 진행 상태 반영)
            if (bookData.currentBookPage !== undefined) {
                data.currentBookPage = bookData.currentBookPage;
            }

            // Book spread: cover image
            const coverImg = document.getElementById('book-cover-img');
            coverImg.style.display = 'block';
            coverImg.src = data.coverImg;
            coverImg.onerror = function() {
                // 이미지 로드 실패 시 그라디언트 배경으로 대체
                this.style.display = 'none';
                this.parentElement.style.background = data.type === 'textbook'
                    ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
                    : 'linear-gradient(135deg, #FF9F43 0%, #f97316 100%)';
            };
            // 이미지 로드 성공 시 부모 배경 초기화
            coverImg.onload = function() {
                this.style.display = 'block';
                this.parentElement.style.background = '#2c1810';
            };

            // Book spread: info
            const typeBadge = document.getElementById('book-type-badge');
            if (data.type === 'textbook') {
                typeBadge.innerHTML = '<i class="fa-solid fa-book text-[9px]"></i> ' + data.subject + ' ' + data.unit;
                typeBadge.className = 'book-tag bg-green-50 text-green-600';
            } else {
                typeBadge.innerHTML = '<i class="fa-solid fa-bookmark text-[9px]"></i> ' + data.bookType;
                typeBadge.className = 'book-tag bg-orange-50 text-orange-500';
            }

            document.getElementById('main-book-level').textContent = data.book.level;
            document.getElementById('main-book-title').textContent = data.book.title;
            document.getElementById('main-book-desc').textContent = data.book.desc;
            document.getElementById('book-excerpt').innerHTML = data.excerpt.replace(/\n/g, '<br>');

            // Page indicator
            document.getElementById('book-pg-current').textContent = data.currentBookPage;
            document.getElementById('book-pg-total').textContent = data.totalPages;

            // Segment label for book step
            if (data.type === 'textbook') {
                document.getElementById('seg-book-label').textContent = '도서읽기';
            } else {
                document.getElementById('seg-book-label').textContent = data.bookType === '관리이북' ? '이북읽기' : '도서읽기';
            }

            // Show/hide retelling segment & page
            const retPage = document.getElementById('page-retelling');
            const retSeg = document.getElementById('seg-retelling');
            if (data.hasRetelling) {
                retPage.classList.remove('hidden');
                retSeg.classList.remove('hidden');
            } else {
                retPage.classList.add('hidden');
                retSeg.classList.add('hidden');
            }

            // Show/hide vocab segment & page (교과서 짝꿍책은 어휘챌린지 없음)
            const vocabPage = document.querySelector('.story-page[data-page="vocab"]');
            const vocabSeg = document.getElementById('seg-vocab');
            if (data.type === 'textbook') {
                // 교과서 짝꿍책: 어휘챌린지 숨김
                if (vocabPage) vocabPage.classList.add('hidden');
                if (vocabSeg) vocabSeg.classList.add('hidden');
            } else {
                // 코어북/관리이북: 어휘챌린지 표시
                if (vocabPage) vocabPage.classList.remove('hidden');
                if (vocabSeg) vocabSeg.classList.remove('hidden');
            }

            // 배경색 업데이트
            const carouselWrapper = document.getElementById('carousel-wrapper');
            if (data.type === 'textbook') {
                carouselWrapper.style.background = '#F0FDF4'; // 연한 초록
            } else {
                carouselWrapper.style.background = '#FFF8F0'; // 연한 주황
            }

            // Reset to first page
            goToPage(0);
        }

        // ===== Page Navigation =====
        function getTotalPages() { return getCurrentBookData().steps.length; }
        function getLastPageIndex() { return getTotalPages() - 1; }

        function goToPage(idx) {
            const total = getTotalPages();
            if (idx < 0 || idx >= total) return;
            currentPage = idx;

            // 모든 페이지 숨기고 현재 페이지만 표시
            const pages = document.querySelectorAll('.story-page');
            const steps = getCurrentBookData().steps;
            let visibleIdx = 0;
            pages.forEach(p => {
                const pageType = p.dataset.page;
                // hidden 클래스가 있는 페이지는 건너뜀
                if (p.classList.contains('hidden')) {
                    p.classList.remove('active-page');
                    return;
                }
                if (visibleIdx === idx) {
                    p.classList.add('active-page');
                } else {
                    p.classList.remove('active-page');
                }
                visibleIdx++;
            });

            updatePageIndicators();
            updatePageNavButtons();
        }

        function nextPage() { if (currentPage < getTotalPages() - 1) goToPage(currentPage + 1); }
        function prevPage() { if (currentPage > 0) goToPage(currentPage - 1); }

        function updatePageIndicators() {
            // 책 페이지 인디케이터는 selectWeek/updateLearningProgress에서 별도 관리
        }

        function updatePageNavButtons() {
            // 책 페이지의 화살표 버튼은 제거됨 - 다른 페이지(퀴즈 등)의 화살표는 자체 inline으로 동작
        }

        // ===== 주차별 sessionStorage 키 헬퍼 =====
        function getProgressKey(week) { return 'learningProgress_w' + (week || currentWeek); }
        function getBookKey(week) { return 'currentBook_w' + (week || currentWeek); }
        function getWeekProgress(week) { return JSON.parse(sessionStorage.getItem(getProgressKey(week)) || '{}'); }
        function getWeekBookData(week) { return JSON.parse(sessionStorage.getItem(getBookKey(week)) || '{}'); }
        function saveWeekProgress(data, week) { sessionStorage.setItem(getProgressKey(week), JSON.stringify(data)); }
        function saveWeekBookData(data, week) { sessionStorage.setItem(getBookKey(week), JSON.stringify(data)); }

        // ===== Book Viewer =====
        function openBookViewer() {
            const data = getCurrentBookData();
            const bookPayload = {
                title: data.book.title, type: data.bookType, level: data.book.level,
                currentBookPage: data.currentBookPage, totalPages: data.totalPages,
                week: currentWeek,
                bookType: currentBookType // 코어북/교과서짝꿍책 구분
            };
            // 주차별 + 책타입별 키에 저장
            saveWeekBookData(bookPayload, currentWeek + '_' + currentBookType);
            // book-viewer는 기존 'currentBook' 키를 읽으므로 호환용으로도 저장
            sessionStorage.setItem('currentBook', JSON.stringify(bookPayload));

            // 페이지 넘김 애니메이션 후 이동
            const bookCard = document.getElementById('book-card');
            if (bookCard) {
                bookCard.classList.add('page-turning');
                setTimeout(() => { window.location.href = 'book-viewer-clean.html'; }, 650);
            } else {
                window.location.href = 'book-viewer-clean.html';
            }
        }

        // ===== 다시 읽기 =====
        function reReadBook() {
            const data = getCurrentBookData();
            const bookPayload = {
                title: data.book.title, type: data.bookType, level: data.book.level,
                currentBookPage: 1, totalPages: data.totalPages,
                week: currentWeek,
                bookType: currentBookType,
                reReading: true  // 다시 읽기 플래그 - 프로그래스바에 영향 없음
            };
            sessionStorage.setItem('currentBook', JSON.stringify(bookPayload));
            window.location.href = 'book-viewer-clean.html';
        }

        // ===== Week Navigation =====
        function prevWeek() { if (currentWeek > 1) selectWeek(currentWeek - 1); }
        function nextWeek() { if (currentWeek < 4) selectWeek(currentWeek + 1); }

        function selectWeek(week) {
            currentWeek = week;
            currentPage = 0;
            currentBookType = 'core'; // 주차 변경 시 코어북으로 초기화

            // Week header - [K2-1] 1주차 형식 (1~4주차)
            const levelLabels = { 1: 'K2-1', 2: 'K2-1', 3: 'K2-1', 4: 'K2-1' };
            document.getElementById('week-label').innerHTML = '<span class="level-badge-inline">' + levelLabels[week] + '</span> ' + week + '주차';

            // 책 타입 탭 업데이트
            updateBookTypeTabs();

            // 책 정보 표시 업데이트
            updateBookDisplay();

            // 먼저 기본 페이지로 초기화
            currentPage = -1;
            goToPage(0);

            // 진행 상태 업데이트 (내부에서 autoFocusNextStep이 다음 단계로 이동)
            updateLearningProgress();

            // 주차 완료 상태 체크 및 자동 접기
            setTimeout(() => checkAndAutoCollapse(), 600);
        }

        // ===== Step Progress Gauge =====
        function updateStepGauge() {
            const progressKey = currentWeek + '_' + currentBookType;
            const progress = getWeekProgress(progressKey);
            const bookData = getWeekBookData(progressKey);
            const sharedBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            const data = getCurrentBookData();
            const steps = data.steps;
            const segmentWidth = 100 / steps.length;

            const bookDone = bookData.completed === true || (sharedBook.week === currentWeek && sharedBook.completed === true);
            const quizDone = progress.quizCompleted === true;
            const retellDone = progress.retellingCompleted === true;
            const vocabDone = progress.vocabCompleted === true;

            // 독서 읽기 진행률: 현재 페이지 / 전체 페이지
            const readPct = bookDone ? 100 : ((data.currentBookPage / data.totalPages) * 100);

            // 각 단계별 완료 여부 → 세그먼트 수로 환산
            let filledSegments = 0;
            let partialFill = 0;

            // 1단계: 도서읽기
            if (bookDone) {
                filledSegments = 1;
                // 2단계: 독후퀴즈
                if (quizDone) {
                    filledSegments = 2;
                    // 교과서 짝꿍책은 퀴즈까지만
                    if (data.type !== 'textbook') {
                        // 3단계: 리텔링 (있을 경우)
                        if (data.hasRetelling) {
                            if (retellDone) {
                                filledSegments = 3;
                                if (vocabDone) filledSegments = 4;
                            }
                        } else {
                            if (vocabDone) filledSegments = 3;
                        }
                    }
                }
            } else {
                // 도서 읽기 진행 중 → 부분 채움
                partialFill = (readPct / 100) * segmentWidth;
            }

            const totalWidth = bookDone
                ? (filledSegments * segmentWidth)
                : partialFill;

            const widthStr = Math.min(totalWidth, 100) + '%';
            const isTextbook = data.type === 'textbook';
            const allDone = isTextbook
                ? (bookDone && quizDone)
                : (vocabDone && quizDone && bookDone && (!data.hasRetelling || retellDone));

            // 모든 페이지의 게이지에 동일한 너비/클래스 적용
            document.querySelectorAll('.step-gauge').forEach(gauge => {
                gauge.style.width = widthStr;
                gauge.classList.toggle('textbook-gauge', isTextbook);
                gauge.classList.toggle('full-complete', allDone);
            });

            // 게이지 위치 기반 텍스트 색상 업데이트
            updateSegmentColors();

            // 보상 상자 상태 업데이트
            updateRewardBoxState(allDone);
        }

        // ===== 보상 상자 시스템 =====
        // ===== 헤더 선물상자 상태 관리 =====
        function updateHeaderRewardBoxState() {
            const rewardBox = document.getElementById('header-reward-box');
            if (!rewardBox) return;

            // 코어북 완료 여부 체크
            const coreProgressKey = currentWeek + '_core';
            const coreProgress = getWeekProgress(coreProgressKey);
            const coreBookData = getWeekBookData(coreProgressKey);
            const coreData = weeklyData[currentWeek]?.core;

            const coreBookDone = coreBookData.completed === true;
            const coreQuizDone = coreProgress.quizCompleted === true;
            const coreVocabDone = coreProgress.vocabCompleted === true;
            const coreRetellDone = !coreData?.hasRetelling || coreProgress.retellingCompleted === true;
            const coreAllDone = coreBookDone && coreQuizDone && coreVocabDone && coreRetellDone;

            // 교과서 짝꿍책 완료 여부 체크
            const textbookProgressKey = currentWeek + '_textbook';
            const textbookProgress = getWeekProgress(textbookProgressKey);
            const textbookBookData = getWeekBookData(textbookProgressKey);
            const textbookBookDone = textbookBookData.completed === true;
            const textbookQuizDone = textbookProgress.quizCompleted === true;
            const textbookAllDone = textbookBookDone && textbookQuizDone;

            // 보상 수령 여부 (주차별)
            const rewardKey = 'header_reward_claimed_week_' + currentWeek;
            const claimedCount = parseInt(localStorage.getItem(rewardKey) || '0');

            rewardBox.classList.remove('locked', 'unlocked', 'claimed');

            // 둘 다 완료했는데 아직 안 받음 → 언락 (2개 받을 수 있음)
            if (coreAllDone && textbookAllDone && claimedCount < 2) {
                rewardBox.classList.add('unlocked');
                rewardBox.innerHTML = `🎁
                    <span class="box-sparkle sp1">✦</span>
                    <span class="box-sparkle sp2">✦</span>
                    <span class="box-sparkle sp3">✧</span>
                    <span class="box-sparkle sp4">✦</span>`;
            }
            // 코어북만 완료 & 아직 안 받음 → 언락 (1개)
            else if (coreAllDone && claimedCount < 1) {
                rewardBox.classList.add('unlocked');
                rewardBox.innerHTML = `🎁
                    <span class="box-sparkle sp1">✦</span>
                    <span class="box-sparkle sp2">✦</span>
                    <span class="box-sparkle sp3">✧</span>
                    <span class="box-sparkle sp4">✦</span>`;
            }
            // 교과서만 완료 (코어북 보상 받은 후) → 언락 (1개 더)
            else if (coreAllDone && textbookAllDone && claimedCount === 1) {
                rewardBox.classList.add('unlocked');
                rewardBox.innerHTML = `🎁
                    <span class="box-sparkle sp1">✦</span>
                    <span class="box-sparkle sp2">✦</span>
                    <span class="box-sparkle sp3">✧</span>
                    <span class="box-sparkle sp4">✦</span>`;
            }
            // 모든 보상 수령 완료
            else if (claimedCount >= 2 || (claimedCount >= 1 && !textbookAllDone && coreAllDone)) {
                // 코어북만 있는 경우 1개면 완료, 둘 다 있으면 2개여야 완료
                const maxRewards = textbookAllDone ? 2 : 1;
                if (claimedCount >= maxRewards) {
                    rewardBox.classList.add('claimed');
                    rewardBox.innerHTML = '🎁';
                } else {
                    rewardBox.classList.add('locked');
                    rewardBox.innerHTML = '🎁';
                }
            }
            // 아직 아무것도 완료 안됨
            else {
                rewardBox.classList.add('locked');
                rewardBox.innerHTML = '🎁';
            }
        }

        function claimHeaderRewardBox(box) {
            // 잠금 상태면 안내
            if (box.classList.contains('locked')) {
                showToast('코어북을 완료하면 보상을 받을 수 있어요!', 'warning');
                return;
            }

            // 이미 완료 상태
            if (box.classList.contains('claimed')) {
                showToast('이 주차의 보상을 모두 받았어요!', 'info');
                return;
            }

            // 완료 상태 체크
            const coreProgressKey = currentWeek + '_core';
            const coreProgress = getWeekProgress(coreProgressKey);
            const coreBookData = getWeekBookData(coreProgressKey);
            const coreData = weeklyData[currentWeek]?.core;

            const coreBookDone = coreBookData.completed === true;
            const coreQuizDone = coreProgress.quizCompleted === true;
            const coreVocabDone = coreProgress.vocabCompleted === true;
            const coreRetellDone = !coreData?.hasRetelling || coreProgress.retellingCompleted === true;
            const coreAllDone = coreBookDone && coreQuizDone && coreVocabDone && coreRetellDone;

            const textbookProgressKey = currentWeek + '_textbook';
            const textbookProgress = getWeekProgress(textbookProgressKey);
            const textbookBookData = getWeekBookData(textbookProgressKey);
            const textbookBookDone = textbookBookData.completed === true;
            const textbookQuizDone = textbookProgress.quizCompleted === true;
            const textbookAllDone = textbookBookDone && textbookQuizDone;

            const rewardKey = 'header_reward_claimed_week_' + currentWeek;
            const claimedCount = parseInt(localStorage.getItem(rewardKey) || '0');

            // 지급할 딱지 수 계산
            let ticketsToGive = 0;
            if (coreAllDone && textbookAllDone && claimedCount === 0) {
                // 둘 다 완료 상태에서 처음 열기 → 2장
                ticketsToGive = 2;
            } else if (coreAllDone && claimedCount === 0) {
                // 코어북만 완료 → 1장
                ticketsToGive = 1;
            } else if (textbookAllDone && claimedCount === 1) {
                // 교과서 짝꿍책 완료 (코어북 이미 받음) → 1장
                ticketsToGive = 1;
            }

            if (ticketsToGive === 0) {
                showToast('받을 수 있는 보상이 없어요!', 'info');
                return;
            }

            // 클레임 애니메이션
            box.classList.add('claiming');

            // 티켓 플로팅 효과
            const ticketFloat = document.createElement('div');
            ticketFloat.className = 'ticket-float';
            ticketFloat.textContent = '🎟️ +' + ticketsToGive;
            ticketFloat.style.left = '50%';
            ticketFloat.style.top = '-10px';
            ticketFloat.style.transform = 'translateX(-50%)';
            ticketFloat.style.position = 'absolute';
            ticketFloat.style.fontSize = '16px';
            ticketFloat.style.fontWeight = 'bold';
            ticketFloat.style.color = '#D97706';
            ticketFloat.style.animation = 'floatUp 0.8s ease-out forwards';
            ticketFloat.style.zIndex = '100';
            box.appendChild(ticketFloat);

            // 티켓 카운트 증가
            setTimeout(() => {
                const orbCountEl = document.getElementById('bingo-orb-count');
                const currentOrbs = parseInt(orbCountEl.textContent) || 10;
                orbCountEl.textContent = currentOrbs + ticketsToGive;

                // 헤더 보상 버튼 강조 효과
                const orbItem = orbCountEl.closest('.bingo-reward-item');
                if (orbItem) {
                    orbItem.classList.add('counting');
                    setTimeout(() => orbItem.classList.remove('counting'), 400);
                }

                // localStorage에 티켓 수 저장
                localStorage.setItem('bingo_orbs', currentOrbs + ticketsToGive);
            }, 300);

            // 상태 저장 및 UI 업데이트
            setTimeout(() => {
                const newClaimedCount = claimedCount + ticketsToGive;
                localStorage.setItem(rewardKey, newClaimedCount.toString());

                box.classList.remove('claiming');
                ticketFloat.remove();

                // 상태 업데이트
                updateHeaderRewardBoxState();

                const message = ticketsToGive === 2
                    ? '🎟️ 딱지 2장 획득! 코어북 + 교과서 보상!'
                    : '🎟️ 딱지 1장 획득! 빙고판을 열어보세요!';
                showToast(message, 'success');
            }, 600);
        }

        // 기존 함수 유지 (하위 호환)
        function updateRewardBoxState(allDone) {
            // 헤더 선물상자 상태 업데이트로 대체
            updateHeaderRewardBoxState();
        }

        function claimRewardBox(box) {
            // 헤더 선물상자로 리다이렉트
            const headerBox = document.getElementById('header-reward-box');
            if (headerBox) {
                claimHeaderRewardBox(headerBox);
            }
        }

        // 토스트 메시지 (간단 버전)
        function showToast(message, type) {
            // 기존 토스트 제거
            const existingToast = document.querySelector('.reward-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'reward-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                border-radius: 24px;
                font-size: 14px;
                font-weight: 600;
                color: white;
                z-index: 9999;
                animation: toastSlideUp 0.3s ease-out;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            `;

            if (type === 'success') {
                toast.style.background = 'linear-gradient(135deg, #10B981, #059669)';
            } else if (type === 'warning') {
                toast.style.background = 'linear-gradient(135deg, #F59E0B, #D97706)';
            } else {
                toast.style.background = 'linear-gradient(135deg, #6B7280, #4B5563)';
            }

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastSlideDown 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        function updateSegmentColors() {
            // 모든 페이지의 프로그래스바에 대해 세그먼트 색상 업데이트
            document.querySelectorAll('.step-progress-bar').forEach(bar => {
                const gauge = bar.querySelector('.step-gauge');
                if (!gauge) return;
                const barRect = bar.getBoundingClientRect();
                if (barRect.width === 0) return; // hidden 상태면 스킵
                const gaugeRight = barRect.left + (bar.offsetWidth * parseFloat(gauge.style.width || '0') / 100);

                bar.querySelectorAll('.step-segment').forEach(seg => {
                    if (seg.classList.contains('hidden')) return;
                    const segRect = seg.getBoundingClientRect();
                    const segCenter = segRect.left + segRect.width / 2;
                    seg.classList.toggle('gauge-covered', segCenter <= gaugeRight);
                });
            });
        }

        // ===== 뷰어에서 돌아왔을 때 진행률 체크 =====
        function checkViewerProgress() {
            const readingProgress = sessionStorage.getItem('readingProgress');
            const bookJustCompleted = sessionStorage.getItem('bookJustCompleted');

            if (readingProgress) {
                const progress = JSON.parse(readingProgress);
                console.log('[Home] Reading progress detected:', progress);

                // 현재 책 정보 업데이트
                const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
                if (currentBook.id === progress.bookId) {
                    // 진행률 표시 업데이트
                    const progressFill = document.getElementById('progress-fill');
                    if (progressFill) {
                        progressFill.style.width = `${progress.percentage}%`;
                    }

                    // 페이지 정보 업데이트
                    const currentPageEl = document.getElementById('current-page');
                    const totalPagesEl = document.getElementById('total-pages');
                    if (currentPageEl) currentPageEl.textContent = progress.currentPage;
                    if (totalPagesEl) totalPagesEl.textContent = progress.totalPages;

                    console.log('[Home] Progress updated on UI');
                }
            }

            if (bookJustCompleted === 'true') {
                const completedBook = JSON.parse(sessionStorage.getItem('lastCompletedBook') || '{}');
                console.log('[Home] Book just completed:', completedBook);

                // 완독 플래그 제거
                sessionStorage.removeItem('bookJustCompleted');

                // 완독 뱃지 표시
                showCompletionBadge();

                // 완독 알림 표시 (옵션)
                setTimeout(() => {
                    alert(`🎉 "${completedBook.bookTitle}" 완독을 축하합니다!`);
                }, 500);
            }

            // 기존 완독 상태 체크 (페이지 로드 시)
            checkExistingCompletion();
        }

        // ===== 완독 뱃지 표시 =====
        function showCompletionBadge() {
            const spreadCover = document.getElementById('spread-cover');
            if (!spreadCover) return;

            // 기존 뱃지 제거
            const existingBadge = spreadCover.querySelector('.completion-badge');
            if (existingBadge) {
                existingBadge.remove();
            }

            // 새 뱃지 추가
            const badge = document.createElement('div');
            badge.className = 'completion-badge';
            badge.innerHTML = '<i class="fa-solid fa-circle-check"></i><span>완독</span>';
            spreadCover.appendChild(badge);

            console.log('[Home] Completion badge added');
        }

        // ===== 기존 완독 상태 체크 =====
        function checkExistingCompletion() {
            const bookCompletions = JSON.parse(sessionStorage.getItem('bookCompletions') || '[]');
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');

            // 현재 책이 완독 목록에 있는지 확인
            const isCompleted = bookCompletions.some(comp => comp.bookId === currentBook.id);

            if (isCompleted) {
                showCompletionBadge();
            }
        }

        // 게이지 트랜지션 완료 후 세그먼트 색상 재계산
        document.addEventListener('DOMContentLoaded', () => {
            // 진행률 체크
            checkViewerProgress();

            document.querySelectorAll('.step-gauge').forEach(gauge => {
                gauge.addEventListener('transitionend', updateSegmentColors);
            });
        });

        // 주 프로그래스바(ID 기반) 세그먼트 상태를 모든 보조 프로그래스바에 동기화
        function syncAllProgressBars() {
            const primaryBar = document.getElementById('step-progress-bar');
            if (!primaryBar) return;
            const primarySegments = primaryBar.querySelectorAll('.step-segment');
            const allBars = document.querySelectorAll('.step-progress-bar');

            allBars.forEach(bar => {
                if (bar === primaryBar) return;
                const segments = bar.querySelectorAll('.step-segment');
                segments.forEach((seg, i) => {
                    if (i >= primarySegments.length) return;
                    const src = primarySegments[i];
                    // 클래스 동기화 (active, completed, locked, hidden, gauge-covered)
                    seg.classList.remove('active', 'completed', 'locked', 'gauge-covered');
                    if (src.classList.contains('active')) seg.classList.add('active');
                    if (src.classList.contains('completed')) seg.classList.add('completed');
                    if (src.classList.contains('locked')) seg.classList.add('locked');
                    if (src.classList.contains('gauge-covered')) seg.classList.add('gauge-covered');
                    // hidden 상태 동기화
                    if (src.classList.contains('hidden')) {
                        seg.classList.add('hidden');
                    } else {
                        seg.classList.remove('hidden');
                    }
                    // 잠금 아이콘 표시/숨김 동기화
                    const srcLock = src.querySelector('.seg-lock');
                    const segLock = seg.querySelector('.seg-lock');
                    if (segLock) {
                        segLock.style.display = srcLock ? srcLock.style.display : 'none';
                    }
                });
            });
        }

        // ===== Learning Progress =====
        function updateLearningProgress() {
            const progressKey = currentWeek + '_' + currentBookType;
            const progress = getWeekProgress(progressKey);
            const bookData = getWeekBookData(progressKey);
            const data = getCurrentBookData();

            // 뷰어에서 돌아온 경우: 공용 키에서 주차별+책타입별 키로 마이그레이션
            const sharedBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            const sharedBookMatch = sharedBook.week === currentWeek && sharedBook.bookType === currentBookType;
            if (sharedBookMatch && sharedBook.currentBookPage) {
                data.currentBookPage = sharedBook.currentBookPage;
                // 주차+책타입별 키에 동기화 저장
                saveWeekBookData(sharedBook, progressKey);
            } else if (bookData.currentBookPage) {
                data.currentBookPage = bookData.currentBookPage;
            }

            const bookDone = bookData.completed === true || (sharedBookMatch && sharedBook.completed === true);
            const quizDone = progress.quizCompleted === true;
            const retellDone = progress.retellingCompleted === true;
            const vocabDone = progress.vocabCompleted === true;
            const weekDone = progress.weekCompleted === true;

            // Step segments
            setSegState('seg-book', bookDone, !bookDone);
            setSegState('seg-quiz', quizDone, bookDone && !quizDone);

            // 교과서 짝꿍책은 어휘챌린지 없음
            if (data.type !== 'textbook') {
                if (data.hasRetelling) {
                    setSegState('seg-retelling', retellDone, quizDone && !retellDone);
                    setSegState('seg-vocab', vocabDone, retellDone && !vocabDone);
                } else {
                    setSegState('seg-vocab', vocabDone, quizDone && !vocabDone);
                }
            }

            // Lock/unlock cards
            setCardLock('quiz-card', !bookDone);
            if (data.type !== 'textbook') {
                if (data.hasRetelling) {
                    setCardLock('retelling-card', !quizDone);
                    setCardLock('vocab-card', !retellDone);
                } else {
                    setCardLock('vocab-card', !quizDone);
                }
            }

            // 완료 도장 표시 (교과서 짝꿍책은 어휘챌린지 없음)
            updateCompletionStamps(bookDone, quizDone, retellDone, vocabDone, data.hasRetelling, data.type === 'textbook');

            // Book CTA button
            const btn = document.getElementById('main-action-btn');
            const actionTxt = document.getElementById('main-action-text');
            const rereadBtn = document.getElementById('reread-btn');

            // 표지 & 책정보 & 페이지 영역 클릭 핸들러 참조
            const coverEl = document.getElementById('spread-cover');
            const pgArea = document.getElementById('book-pg-area');
            const infoTop = document.getElementById('book-info-top');

            // 교과서 짝꿍책인 경우 코어북 완료 체크
            let textbookReadingLocked = false;
            if (data.type === 'textbook') {
                const coreProgress = getWeekProgress(currentWeek + '_core') || {};
                const coreBookData = getWeekBookData(currentWeek + '_core') || {};
                const coreData = weeklyData[currentWeek].core;
                const coreBookDone = coreBookData.completed === true;
                const coreQuizDone = coreProgress.quizCompleted === true;
                const coreVocabDone = coreProgress.vocabCompleted === true;
                const coreRetellDone = !coreData.hasRetelling || coreProgress.retellingCompleted === true;
                textbookReadingLocked = !(coreBookDone && coreQuizDone && coreVocabDone && coreRetellDone);
            }

            if (bookDone) {
                btn.className = 'cta-btn bg-[#1dd1a1] text-white shadow-md opacity-80';
                btn.querySelector('i').className = 'fa-solid fa-check';
                actionTxt.textContent = '독서 완료';
                btn.onclick = null;
                document.getElementById('book-pg-current').textContent = data.totalPages;
                // 다시 읽기 버튼 표시
                if (rereadBtn) rereadBtn.classList.remove('hidden');
                // 표지 & 책정보 & 페이지 영역 클릭 비활성화
                if (coverEl) { coverEl.onclick = null; coverEl.style.cursor = 'default'; }
                if (infoTop) { infoTop.onclick = null; infoTop.style.cursor = 'default'; }
                if (pgArea) { pgArea.onclick = null; pgArea.style.cursor = 'default'; }
            } else if (textbookReadingLocked) {
                // 교과서 짝꿍책 - 코어북 미완료 시 읽기 버튼만 잠금
                btn.className = 'cta-btn bg-gray-300 text-gray-500 shadow-md cursor-not-allowed';
                btn.querySelector('i').className = 'fa-solid fa-lock';
                actionTxt.textContent = '코어북 완료 후 읽기';
                btn.onclick = function() { alert('코어북 학습을 먼저 완료해주세요!'); };
                // currentBookPage 그대로 표시 (0이면 0% 프로그래스)
                document.getElementById('book-pg-current').textContent = data.currentBookPage || 0;
                // 다시 읽기 버튼 숨김
                if (rereadBtn) rereadBtn.classList.add('hidden');
                // 표지 & 책정보 & 페이지 영역 모두 잠금 처리
                const lockAlert = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('코어북 학습을 먼저 완료해주세요!');
                };
                if (coverEl) { coverEl.onclick = lockAlert; coverEl.style.cursor = 'not-allowed'; }
                if (infoTop) { infoTop.onclick = lockAlert; infoTop.style.cursor = 'not-allowed'; }
                if (pgArea) { pgArea.onclick = lockAlert; pgArea.style.cursor = 'not-allowed'; }
            } else {
                btn.className = 'cta-btn bg-gradient-to-r from-brand-primary to-orange-400 text-white shadow-md';
                btn.querySelector('i').className = 'fa-solid fa-book-open';
                actionTxt.textContent = data.currentBookPage > 1 ? '계속 읽기' : '읽기 시작';
                btn.onclick = openBookViewer;
                document.getElementById('book-pg-current').textContent = data.currentBookPage;
                // 다시 읽기 버튼 숨김
                if (rereadBtn) rereadBtn.classList.add('hidden');
                // 표지 & 책정보 & 페이지 영역 클릭 활성화
                if (coverEl) { coverEl.onclick = openBookViewer; coverEl.style.cursor = 'pointer'; }
                if (infoTop) { infoTop.onclick = openBookViewer; infoTop.style.cursor = 'pointer'; }
                if (pgArea) { pgArea.onclick = openBookViewer; pgArea.style.cursor = 'pointer'; }
            }

            // Step gauge (모든 페이지의 게이지 동기화)
            updateStepGauge();
            syncAllProgressBars();

            // 헤더 선물상자 상태 업데이트
            updateHeaderRewardBoxState();

            // 탭 상태 업데이트 (잠금 표시 등)
            updateBookTypeTabs();

            // 현재 책 타입의 모든 단계 완료 체크
            const allStepsDone = bookDone && quizDone && (!data.hasRetelling || retellDone) && (data.type === 'textbook' || vocabDone);

            // allComplete 상태 저장 (다시 읽기 모드에서는 저장하지 않음)
            if (allStepsDone && !isReReadingMode) {
                const progress = getWeekProgress(currentWeek + '_' + currentBookType) || {};
                progress.allComplete = true;
                saveWeekProgress(progress, currentWeek + '_' + currentBookType);
            }

            // Completion - 개별 책 완료 표시
            if (allStepsDone && currentBookType === 'core') {
                // 코어북 완료 시 교과서 짝꿍책으로 자동 전환
                checkAutoSwitchToTextbook();
            }

            // 완료 상태 처리 (다시 읽기 모드에서는 완료 화면 표시 안함)
            // 다시 읽기 모드에서 모든 단계 완료 시 완료 화면으로 복귀
            if (isReReadingMode && allStepsDone) {
                isReReadingMode = false;
                showCompletedState();
            } else if (allStepsDone && !isReReadingMode) {
                // 개별 책(코어북 또는 교과서 짝꿍책) 완료 시에도 완료 화면 표시
                showCompletedState();
            } else {
                hideCompletedState();
            }

            // 자동 포커싱: 완료된 단계 다음으로 이동
            autoFocusNextStep(bookDone, quizDone, retellDone, vocabDone, data);

            // 주차 완료 상태 체크 및 자동 접기
            setTimeout(() => checkAndAutoCollapse(), 300);
        }

        // ===== 완료 도장 표시 =====
        function updateCompletionStamps(bookDone, quizDone, retellDone, vocabDone, hasRetelling, isTextbook = false) {
            // 도서 읽기 완료 도장
            applyStamp('book-card', bookDone, '독서 완료!');
            applyStamp('quiz-card', quizDone, '퀴즈 완료!');
            if (hasRetelling) applyStamp('retelling-card', retellDone, '리텔링 완료!');
            // 교과서 짝꿍책은 어휘챌린지 없음
            if (!isTextbook) applyStamp('vocab-card', vocabDone, '챌린지 완료!');
        }

        function applyStamp(cardId, isDone, label) {
            const card = document.getElementById(cardId);
            if (!card) return;
            let stamp = card.querySelector('.completion-stamp');
            if (isDone) {
                if (!stamp) {
                    stamp = document.createElement('div');
                    stamp.className = 'completion-stamp';
                    stamp.innerHTML = '<i class="fa-solid fa-circle-check"></i> ' + label;
                    card.style.position = 'relative';
                    card.appendChild(stamp);
                }
                stamp.style.display = '';
            } else {
                if (stamp) stamp.style.display = 'none';
            }
        }

        // ===== 자동 포커싱: 다음 미완료 단계로 이동 =====
        function autoFocusNextStep(bookDone, quizDone, retellDone, vocabDone, data) {
            // 주차 전환 시에만 자동 포커싱 (첫 로드 시)
            if (!bookDone) {
                // 독서 미완료 → 도서읽기 페이지 (기본값이므로 별도 처리 불필요)
                return;
            }
            // 독서 완료 → 퀴즈 미완료면 퀴즈로 포커싱
            if (bookDone && !quizDone) {
                goToPage(1);
                return;
            }
            // 퀴즈 완료
            if (quizDone) {
                if (data.hasRetelling && !retellDone) {
                    goToPage(2); // 리텔링으로
                    return;
                }
                if (!data.hasRetelling && !vocabDone) {
                    goToPage(data.steps.indexOf('vocab')); // 어휘챌린지로
                    return;
                }
                if (data.hasRetelling && retellDone && !vocabDone) {
                    goToPage(data.steps.indexOf('vocab'));
                    return;
                }
            }
        }

        function setSegState(id, isDone, isActive) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('active', 'completed', 'locked');
            const lockIcon = el.querySelector('.seg-lock');
            if (isDone) {
                el.classList.add('completed');
                if (lockIcon) lockIcon.style.display = 'none';
            } else if (isActive) {
                el.classList.add('active');
                if (lockIcon) lockIcon.style.display = 'none';
            } else {
                el.classList.add('locked');
                if (lockIcon) lockIcon.style.display = '';
            }
        }

        function setCardLock(cardId, isLocked) {
            const card = document.getElementById(cardId);
            if (!card) return;
            card.classList.toggle('unlocked', !isLocked);
        }

        // ===== Completion =====
        function showCompletedState() {
            document.getElementById('story-active').classList.add('hidden');
            document.getElementById('story-completed').classList.remove('hidden');

            const data = getCurrentBookData();
            const progressKey = currentWeek + '_' + currentBookType;
            const progress = getWeekProgress(progressKey) || {};

            // 책 제목
            document.getElementById('completed-book-title').textContent = data.book.title;

            // 책 섬네일 (실제 책 커버 이미지 사용)
            const thumbEl = document.getElementById('completed-book-thumb');
            if (data.coverImg) {
                thumbEl.src = data.coverImg;
                thumbEl.alt = data.book.title + ' 표지';
            }

            // 퀴즈 결과 (저장된 점수 기반)
            const quizScore = progress.quizScore || 100;
            const quizCorrect = Math.round(quizScore / 100 * 5); // 5문제 기준
            document.getElementById('completed-quiz-result').textContent = quizCorrect + '문제 정답';

            // 어휘챌린지 결과 (교과서 짝꿍책은 어휘챌린지 없음)
            const vocabResultEl = document.getElementById('completed-vocab-result');
            if (data.type === 'textbook') {
                vocabResultEl.parentElement.style.display = 'none';
            } else {
                vocabResultEl.parentElement.style.display = '';
                vocabResultEl.textContent = '100점!';
            }

            setSegState('seg-book', true, false);
            setSegState('seg-quiz', true, false);
            if (data.hasRetelling) setSegState('seg-retelling', true, false);
            setSegState('seg-vocab', true, false);

            // Gauge full (모든 페이지 게이지 동기화)
            document.querySelectorAll('.step-gauge').forEach(g => {
                g.style.width = '100%';
                g.classList.add('full-complete');
            });
            syncAllProgressBars();
        }

        function hideCompletedState() {
            document.getElementById('story-active').classList.remove('hidden');
            document.getElementById('story-completed').classList.add('hidden');
        }

        function loadNextBook() {
            // 주차별 진행 상태는 유지 (독립적이므로 삭제하지 않음)
            if (currentWeek < 4) { selectWeek(currentWeek + 1); }
            else { alert('이번 달 모든 학습을 완료했어요! 다음 달 커리큘럼을 기대해주세요!'); selectWeek(1); }
        }

        // ===== 다시 읽기 모드 =====
        function startReReading() {
            // 다시 읽기 모드 활성화 (보상 없이 학습만 가능)
            isReReadingMode = true;
            sessionStorage.setItem('isReReadingMode', 'true');

            // 다시 읽기용 임시 진행상태 초기화 (실제 완료 상태는 유지)
            const rereadProgressKey = 'rereadProgress_' + currentWeek + '_' + currentBookType;
            sessionStorage.setItem(rereadProgressKey, JSON.stringify({
                bookCompleted: false,
                quizCompleted: false,
                vocabCompleted: false,
                currentBookPage: 1
            }));

            // 독서 뷰어로 이동 (책 정보 저장)
            const data = getCurrentBookData();
            const bookPayload = {
                title: data.book.title,
                type: data.bookType,
                level: data.book.level,
                currentBookPage: 1, // 처음부터 다시 읽기
                totalPages: data.totalPages,
                week: currentWeek,
                bookType: currentBookType,
                isReReading: true // 다시 읽기 모드 표시
            };

            // 주차별 + 책타입별 키에 저장
            saveWeekBookData(bookPayload, currentWeek + '_' + currentBookType);
            sessionStorage.setItem('currentBook', JSON.stringify(bookPayload));

            // 페이지 넘김 애니메이션 후 독서 뷰어로 이동
            const bookCard = document.getElementById('book-card');
            if (bookCard) {
                bookCard.classList.add('page-turning');
                setTimeout(() => { window.location.href = 'book-viewer-clean.html'; }, 650);
            } else {
                window.location.href = 'book-viewer-clean.html';
            }
        }

        // ===== 별딱지 빙고 시스템 =====
        let bingoBoard = [];           // 9칸 별 값 (1-5)
        let bingoFlipped = [];         // 9칸 플립 상태
        let bingoOrbs = 10;            // 현재 딱지 수
        let bingoStars = 125;          // 현재 별 수
        let bingoCompletedLines = [];  // 이미 보상받은 라인 인덱스
        let bingoFlipping = false;     // 플립 애니메이션 중 잠금
        let bingoStartBonusGiven = false; // 스타트 보너스 지급 여부

        // 빙고 라인 정의 (8방향)
        const BINGO_LINES = [
            [0,1,2], [3,4,5], [6,7,8],  // 가로
            [0,3,6], [1,4,7], [2,5,8],  // 세로
            [0,4,8], [2,4,6]             // 대각
        ];

        // 별 등급 가중치: 1별(35%), 2별(25%), 3별(20%), 4별(13%), 5별(7%)
        function getRandomStarValue() {
            const r = Math.random() * 100;
            if (r < 35) return 1;
            if (r < 60) return 2;
            if (r < 80) return 3;
            if (r < 93) return 4;
            return 5;
        }

        // 보드 초기화
        function initBingoBoard() {
            bingoBoard = [];
            bingoFlipped = Array(9).fill(false);
            bingoCompletedLines = [];
            for (let i = 0; i < 9; i++) {
                bingoBoard.push(getRandomStarValue());
            }
            // SVG 라인 초기화
            const svg = document.getElementById('bingo-lines-svg');
            if (svg) svg.innerHTML = '';
        }

        // 별 이모지 반복
        function starEmojis(count) {
            return '⭐'.repeat(count);
        }

        // 딱지 앞면 - 모두 동일한 디폴트 디자인
        const cardFrontIcon = '⭐';

        // 빙고 모달 표시
        function showBingoModal() {
            if (bingoBoard.length === 0 || bingoFlipped.every(f => f)) {
                initBingoBoard();
            }
            const modal = document.getElementById('bingo-modal');
            // body 직접 자식으로 이동 (부모 overflow/transform이 fixed 포지셔닝 방해 방지)
            if (modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            renderBingoGrid();
            updateBingoDisplay();
            drawCompletedBingoLines();

            // 스타트 보너스 (최초 1회)
            if (!bingoStartBonusGiven) {
                setTimeout(() => {
                    const bonusOverlay = document.getElementById('bingo-start-bonus');
                    bonusOverlay.style.display = 'flex';
                }, 300);
            }
        }

        // 스타트 보너스 받기
        function claimStartBonus() {
            bingoStartBonusGiven = true;
            bingoOrbs += 1;
            updateBingoDisplay();

            // 오버레이 닫기 애니메이션
            const bonusOverlay = document.getElementById('bingo-start-bonus');
            const box = bonusOverlay.querySelector('.start-bonus-box');
            box.style.transition = 'all 0.3s ease';
            box.style.transform = 'scale(0.8)';
            box.style.opacity = '0';
            bonusOverlay.style.transition = 'opacity 0.3s ease';
            bonusOverlay.style.opacity = '0';
            setTimeout(() => {
                bonusOverlay.style.display = 'none';
                bonusOverlay.style.opacity = '';
                box.style.transform = '';
                box.style.opacity = '';
                box.style.transition = '';
                // 토스트 알림 표시
                showBingoToast('🎟️+1개 획득 완료!');
            }, 300);
        }

        // 빙고 그리드 렌더링
        function renderBingoGrid() {
            const grid = document.getElementById('bingo-grid');
            grid.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const starVal = bingoBoard[i];
                const isFlipped = bingoFlipped[i];
                const card = document.createElement('div');
                card.className = 'bingo-card' + (isFlipped ? ' flipped disabled star-' + starVal : '');
                card.dataset.index = i;
                if (!isFlipped) {
                    card.onclick = () => flipBingoCard(i);
                }

                // 별 등급별 텍스트 색상 (밝은 테마)
                const starColor = starVal >= 5 ? '#DC2626' : starVal >= 4 ? '#D97706' : starVal >= 3 ? '#EA580C' : starVal >= 2 ? '#92400E' : '#6B7280';
                const starLabel = starVal >= 5 ? 'JACKPOT!' : '+' + starVal;
                const starSize = starVal >= 5 ? 14 : starVal >= 4 ? 14 : 18;

                card.innerHTML = `
                    <div class="bingo-card-inner">
                        <div class="bingo-card-front">
                            <span style="font-size:28px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.15));">?</span>
                            <span style="font-size:9px;color:rgba(255,255,255,0.5);margin-top:4px;font-weight:700;letter-spacing:1px;">TAP</span>
                        </div>
                        <div class="bingo-card-back">
                            <span style="font-size:${starSize}px;line-height:1.2;text-align:center;word-break:break-all;max-width:90%;display:inline-block;">${starEmojis(starVal)}</span>
                            <span class="star-reveal" style="color:${starColor};font-size:${starVal >= 5 ? 11 : 12}px;margin-top:1px;">
                                ${starLabel}
                            </span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        // 화투 탁! 스타일 카드 뒤집기
        function flipBingoCard(index) {
            if (bingoFlipping) return;
            if (bingoFlipped[index]) return;

            // 딱지 부족 체크
            if (bingoOrbs <= 0) {
                const modal = document.querySelector('.bingo-modal-content');
                modal.style.animation = 'noOrbShake 0.5s ease';
                setTimeout(() => modal.style.animation = '', 500);
                showFloatReward(document.getElementById('bingo-grid'), '🎟️ 딱지가 부족해요!', '#DC2626');
                return;
            }

            bingoFlipping = true;

            // 딱지 소모
            bingoOrbs--;
            updateBingoDisplay();

            const card = document.querySelector(`.bingo-card[data-index="${index}"]`);
            const starVal = bingoBoard[index];
            bingoFlipped[index] = true;

            // 1단계: 화투 탁! 플립 애니메이션
            card.classList.add('flipping', 'star-' + starVal);
            card.onclick = null;

            // 별 획득
            bingoStars += starVal;

            // 2단계: 탁! 착지 임팩트 (플립 중간에)
            setTimeout(() => {
                card.classList.add('slap-impact');
                card.classList.remove('flipping');
                card.classList.add('flipped', 'disabled');

                // 3별 이상: 폭죽
                if (starVal >= 3) {
                    createBingoConfetti(card, starVal);
                }

                // 바운스 이펙트
                setTimeout(() => {
                    card.classList.add(starVal >= 5 ? 'effect-jackpot' : 'effect-bounce');
                    card.classList.remove('slap-impact');
                }, 50);

                // 5별 JACKPOT: 화면 전체 플래시
                if (starVal === 5) {
                    const modal = document.querySelector('.bingo-modal-content');
                    modal.style.boxShadow = 'inset 0 0 120px rgba(239,68,68,0.2)';
                    setTimeout(() => {
                        modal.style.boxShadow = '';
                    }, 1200);
                }

                // 플로팅 보상 텍스트
                showFloatReward(card, '+' + starVal, starVal >= 5 ? '#DC2626' : '#D97706');
                updateBingoDisplay();

                // 빙고 라인 체크
                setTimeout(() => {
                    checkBingoLines();

                    // 8장 보너스
                    const flippedCount = bingoFlipped.filter(f => f).length;
                    if (flippedCount === 8) {
                        checkEightCardBonus();
                    }
                    // 9장 완성
                    if (flippedCount === 9) {
                        setTimeout(() => showGrandCelebration(), 600);
                    }
                    bingoFlipping = false;
                }, 350);
            }, 400);
        }

        // 빙고 라인 SVG 그리기
        function drawBingoLine(lineIdx) {
            const svg = document.getElementById('bingo-lines-svg');
            const grid = document.getElementById('bingo-grid');
            if (!svg || !grid) return;

            const line = BINGO_LINES[lineIdx];
            const cards = grid.querySelectorAll('.bingo-card');
            if (cards.length < 9) return;

            const gridRect = grid.getBoundingClientRect();

            // 라인의 시작과 끝 카드 중심점 계산
            const startCard = cards[line[0]];
            const endCard = cards[line[2]];
            const startRect = startCard.getBoundingClientRect();
            const endRect = endCard.getBoundingClientRect();

            const x1 = startRect.left - gridRect.left + startRect.width / 2;
            const y1 = startRect.top - gridRect.top + startRect.height / 2;
            const x2 = endRect.left - gridRect.left + endRect.width / 2;
            const y2 = endRect.top - gridRect.top + endRect.height / 2;

            // SVG viewBox 업데이트
            svg.setAttribute('viewBox', `0 0 ${gridRect.width} ${gridRect.height}`);

            const svgLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            svgLine.setAttribute('x1', x1);
            svgLine.setAttribute('y1', y1);
            svgLine.setAttribute('x2', x2);
            svgLine.setAttribute('y2', y2);
            svgLine.setAttribute('class', 'bingo-line');
            svgLine.dataset.lineIdx = lineIdx;
            svg.appendChild(svgLine);
        }

        // 이미 완성된 라인들 다시 그리기 (모달 재오픈 시)
        function drawCompletedBingoLines() {
            const svg = document.getElementById('bingo-lines-svg');
            if (svg) svg.innerHTML = '';
            // 약간의 딜레이 후 그리기 (렌더링 완료 대기)
            setTimeout(() => {
                bingoCompletedLines.forEach(lineIdx => {
                    drawBingoLine(lineIdx);
                });
            }, 100);
        }

        // 빙고 라인 체크
        function checkBingoLines() {
            let newLineCount = 0;
            BINGO_LINES.forEach((line, lineIdx) => {
                if (bingoCompletedLines.includes(lineIdx)) return;
                const allFlipped = line.every(i => bingoFlipped[i]);
                if (allFlipped) {
                    bingoCompletedLines.push(lineIdx);
                    newLineCount++;

                    // 라인 카드 하이라이트
                    line.forEach(i => {
                        const card = document.querySelector(`.bingo-card[data-index="${i}"]`);
                        card.classList.add('bingo-line-highlight');
                    });

                    // SVG 빙고 라인 그리기
                    setTimeout(() => drawBingoLine(lineIdx), 200);

                    // +5별 보상
                    bingoStars += 5;
                    updateBingoDisplay();
                }
            });

            if (newLineCount > 0) {
                // 빙고 축하 알림 (중앙 팝업, 자동 사라짐)
                const banner = document.getElementById('bingo-line-banner');
                const total = bingoCompletedLines.length;
                banner.innerHTML = `🎯 ${total}빙고 완성! +${newLineCount * 5}⭐`;
                banner.style.display = 'block';
                banner.style.animation = 'none';
                banner.offsetHeight; // reflow
                banner.style.animation = 'bingoCelebPop 0.6s cubic-bezier(0.34,1.56,0.64,1) forwards';
                // 페이드아웃 후 숨김
                setTimeout(() => {
                    banner.style.animation = 'bingoCelebFadeOut 0.4s ease-out forwards';
                    setTimeout(() => { banner.style.display = 'none'; }, 400);
                }, 2000);

                showFloatReward(document.getElementById('bingo-grid'), `+${newLineCount * 5}`, '#DC2626');
            }

            document.getElementById('bingo-line-count').textContent = bingoCompletedLines.length;
        }

        // 8장 플립 보너스 (+1 딱지)
        function checkEightCardBonus() {
            bingoOrbs += 1;
            updateBingoDisplay();
            setTimeout(() => {
                showFloatReward(document.getElementById('bingo-grid'), '+1🎟️ 보너스!', '#D97706');
            }, 200);
        }

        // 그랜드 셀레브레이션 (9장 완성)
        function showGrandCelebration() {
            bingoStars += 10;
            updateBingoDisplay();

            const overlay = document.getElementById('bingo-grand-overlay');
            overlay.style.display = 'flex';

            // 대형 폭죽
            const modal = document.querySelector('.bingo-modal-content');
            for (let wave = 0; wave < 3; wave++) {
                setTimeout(() => createBingoConfetti(modal, 5, 30), wave * 400);
            }
        }

        function closeGrandCelebration() {
            document.getElementById('bingo-grand-overlay').style.display = 'none';
        }

        // 폭죽 파티클 생성
        function createBingoConfetti(container, intensity, count) {
            const colors = ['#FFD700', '#FF6B6B', '#FF9F43', '#EC4899', '#10B981', '#3B82F6', '#F59E0B'];
            const numParticles = count || (intensity * 4 + 4);
            const rect = container.getBoundingClientRect();
            const gridRect = document.getElementById('bingo-grid').getBoundingClientRect();

            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'bingo-confetti';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = (rect.left - gridRect.left + rect.width / 2) + 'px';
                particle.style.top = (rect.top - gridRect.top + rect.height / 2) + 'px';
                particle.style.setProperty('--tx', (Math.random() - 0.5) * 250 + 'px');
                particle.style.setProperty('--ty', (Math.random() - 0.5) * 250 + 'px');
                particle.style.setProperty('--tr', (Math.random() * 720 - 360) + 'deg');
                particle.style.animationDelay = Math.random() * 0.3 + 's';
                particle.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                document.getElementById('bingo-grid').appendChild(particle);
                setTimeout(() => particle.remove(), 1300);
            }
        }

        // 플로팅 보상 텍스트
        // 빙고 토스트 알림 (헤더 버튼 아래)
        let bingoToastTimer = null;
        function showBingoToast(msg) {
            const toast = document.getElementById('bingo-toast');
            const btn = document.getElementById('bingo-orb-count');
            if (!toast || !btn) return;
            clearTimeout(bingoToastTimer);
            toast.className = 'bingo-toast';
            toast.textContent = msg;
            // 🎟️ 영역 기준으로 fixed 좌표 계산
            const orbItem = btn.closest('.bingo-reward-item');
            const rect = orbItem.getBoundingClientRect();
            toast.style.top = (rect.bottom + 10) + 'px';
            toast.style.left = (rect.left + rect.width / 2) + 'px';
            toast.style.right = 'auto';
            toast.style.transform = 'translateX(-50%)';
            toast.offsetHeight; // reflow
            toast.style.display = 'block';
            toast.className = 'bingo-toast show';
            bingoToastTimer = setTimeout(() => {
                toast.className = 'bingo-toast show hide';
                setTimeout(() => { toast.style.display = 'none'; toast.className = 'bingo-toast'; }, 350);
            }, 2200);
        }

        function showFloatReward(container, text, color) {
            const el = document.createElement('div');
            el.className = 'bingo-float-reward';
            el.textContent = text;
            el.style.color = color;
            el.style.left = '50%';
            el.style.top = '40%';
            container.style.position = container.style.position || 'relative';
            container.appendChild(el);
            setTimeout(() => el.remove(), 1200);
        }

        // 디스플레이 업데이트
        function updateBingoDisplay() {
            const orbEl = document.getElementById('bingo-orb-count');
            const starEl = document.getElementById('bingo-star-count');
            if (orbEl) orbEl.textContent = bingoOrbs;
            if (starEl) starEl.textContent = bingoStars;

            const modalOrbs = document.getElementById('bingo-modal-orbs');
            const modalStars = document.getElementById('bingo-modal-stars');
            const lineCount = document.getElementById('bingo-line-count');
            if (modalOrbs) modalOrbs.textContent = bingoOrbs;
            if (modalStars) modalStars.textContent = bingoStars;
            if (lineCount) lineCount.textContent = bingoCompletedLines.length;
        }

        // 빙고 모달 닫기
        function closeBingoModal() {
            const modal = document.getElementById('bingo-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            closeGrandCelebration();
        }

        // 교과서 짝꿍책 독후퀴즈 완료 시 딱지 지급 + 빙고 모달 표시
        function checkWeekAllComplete() {
            // 다시 읽기 모드에서는 보상 지급 안함
            if (isReReadingMode) return;

            const textbookQuizJustCompleted = sessionStorage.getItem('textbookQuizJustCompleted') === 'true';
            const completedWeek = parseInt(sessionStorage.getItem('textbookQuizCompletedWeek') || '0');

            if (textbookQuizJustCompleted && completedWeek === currentWeek) {
                sessionStorage.removeItem('textbookQuizJustCompleted');
                sessionStorage.removeItem('textbookQuizCompletedWeek');

                const rewardKey = 'bingoReward_week_' + currentWeek;
                if (!localStorage.getItem(rewardKey)) {
                    localStorage.setItem(rewardKey, 'claimed');
                    // 딱지 보너스 지급
                    bingoOrbs += 3;
                    updateBingoDisplay();
                    // 교과서 짝꿍책 탭으로 전환 후 빙고 모달 표시
                    if (currentBookType !== 'textbook') {
                        switchBookType('textbook');
                    }
                    setTimeout(() => {
                        showBingoModal();
                        setTimeout(() => {
                            showFloatReward(document.getElementById('bingo-grid'), '+3🎟️ 학습 보상!', '#D97706');
                        }, 500);
                    }, 300);
                    return true;
                }
            }
            return false;
        }

        // 코어북 완료 시 교과서 짝꿍책으로 자동 전환
        function checkAutoSwitchToTextbook() {
            const coreProgress = getWeekProgress(currentWeek + '_core') || {};
            const coreBookData = getWeekBookData(currentWeek + '_core') || {};
            const coreData = weeklyData[currentWeek].core;

            const coreBookDone = coreBookData.completed === true;
            const coreQuizDone = coreProgress.quizCompleted === true;
            const coreVocabDone = coreProgress.vocabCompleted === true;
            const coreRetellDone = !coreData.hasRetelling || coreProgress.retellingCompleted === true;
            const coreAllDone = coreBookDone && coreQuizDone && coreVocabDone && coreRetellDone;

            // 코어북 완료 && 현재 코어북 선택 중 && 교과서 짝꿍책 미완료 시 자동 전환 (최초 1회만)
            const weekKey = 'week_' + currentWeek + '_core';
            if (coreAllDone && currentBookType === 'core' && !hasAutoSwitchedWeeks[weekKey]) {
                const textbookProgress = getWeekProgress(currentWeek + '_textbook') || {};
                const textbookBookData = getWeekBookData(currentWeek + '_textbook') || {};
                const textbookBookDone = textbookBookData.completed === true;
                const textbookQuizDone = textbookProgress.quizCompleted === true;
                const textbookAllDone = textbookBookDone && textbookQuizDone;

                if (!textbookAllDone) {
                    // 자동으로 교과서 짝꿍책으로 전환 (최초 1회만)
                    hasAutoSwitchedWeeks[weekKey] = true;
                    setTimeout(() => {
                        switchBookType('textbook');
                    }, 500);
                }
            }
        }

        // ===== 찜하기 토글 (홈) =====
        function toggleFavHome(el, id, title, genre, bg) {
            const added = Favorites.toggle({ id, title, genre, bg });
            if (added) {
                el.classList.add('active');
                el.querySelector('i').className = 'fa-solid fa-heart';
            } else {
                el.classList.remove('active');
                el.querySelector('i').className = 'fa-regular fa-heart';
            }
        }

        function initFavHearts() {
            document.querySelectorAll('.fav-heart-sm').forEach(el => {
                const onclick = el.getAttribute('onclick') || '';
                const match = onclick.match(/toggleFavHome\(this,\s*'([^']+)'/);
                if (match && Favorites.isFavorite(match[1])) {
                    el.classList.add('active');
                    el.querySelector('i').className = 'fa-solid fa-heart';
                }
            });
        }

        // ===== 또또 캐릭터 팝업 =====
        function showTtottoPopup() {
            const popup = document.getElementById('ttotto-popup');
            popup.classList.remove('hidden');
            popup.style.display = 'flex';
        }

        function hideTtottoPopup() {
            const popup = document.getElementById('ttotto-popup');
            popup.classList.add('hidden');
            popup.style.display = 'none';
        }

        function showTtottoRecommendPopup() {
            const popup = document.getElementById('ttotto-recommend-popup');
            if (popup) {
                popup.classList.remove('hidden');
                popup.style.display = 'flex';
            }
        }

        function hideTtottoRecommendPopup() {
            const popup = document.getElementById('ttotto-recommend-popup');
            if (popup) {
                popup.classList.add('hidden');
                popup.style.display = 'none';
            }
        }

        // ===== Init =====
        document.addEventListener('DOMContentLoaded', () => {
            // 최초 진입 시 공유 키 정리 (stale completed 상태 방지)
            // book-viewer에서 돌아온 경우가 아니면 공유 키 삭제
            const referrer = document.referrer || '';
            if (!referrer.includes('book-viewer')) {
                sessionStorage.removeItem('currentBook');
            }
            loadSidebar('home');
            loadLogoutModal();
            selectWeek(1);
            initFavHearts();

            // 저장된 티켓 카운트 로드
            const savedOrbs = localStorage.getItem('bingo_orbs');
            if (savedOrbs) {
                document.getElementById('bingo-orb-count').textContent = savedOrbs;
            }

            // 퀴즈/어휘챌린지 완료 후 돌아온 경우 프로그래스바 업데이트
            setTimeout(() => {
                checkActivityCompletion();
            }, 100);
        });

        // 활동 완료 후 복귀 시 진행상태 체크
        function checkActivityCompletion() {
            // 다시 읽기 모드 체크
            const isReReading = sessionStorage.getItem('isReReadingMode') === 'true';

            let needsUpdate = false;
            let targetBookType = currentBookType;

            // 퀴즈 완료 체크
            const quizJustCompleted = sessionStorage.getItem('quizJustCompleted') === 'true';
            const quizCompletedWeek = parseInt(sessionStorage.getItem('quizCompletedWeek') || '0');
            const quizCompletedBookType = sessionStorage.getItem('quizCompletedBookType') || 'core';

            if (quizJustCompleted && quizCompletedWeek === currentWeek) {
                sessionStorage.removeItem('quizJustCompleted');
                sessionStorage.removeItem('quizCompletedWeek');
                sessionStorage.removeItem('quizCompletedBookType');
                targetBookType = quizCompletedBookType;

                // 다시 읽기 모드에서는 임시 진행상태만 업데이트
                if (isReReading) {
                    const rereadKey = 'rereadProgress_' + currentWeek + '_' + quizCompletedBookType;
                    const rereadProgress = JSON.parse(sessionStorage.getItem(rereadKey) || '{}');
                    rereadProgress.quizCompleted = true;
                    sessionStorage.setItem(rereadKey, JSON.stringify(rereadProgress));
                }
                needsUpdate = true;
            }

            // 어휘챌린지 완료 체크
            const vocabJustCompleted = sessionStorage.getItem('vocabJustCompleted') === 'true';
            const vocabCompletedWeek = parseInt(sessionStorage.getItem('vocabCompletedWeek') || '0');
            const vocabCompletedBookType = sessionStorage.getItem('vocabCompletedBookType') || 'core';

            if (vocabJustCompleted && vocabCompletedWeek === currentWeek) {
                sessionStorage.removeItem('vocabJustCompleted');
                sessionStorage.removeItem('vocabCompletedWeek');
                sessionStorage.removeItem('vocabCompletedBookType');
                targetBookType = vocabCompletedBookType;

                // 다시 읽기 모드에서는 임시 진행상태만 업데이트
                if (isReReading) {
                    const rereadKey = 'rereadProgress_' + currentWeek + '_' + vocabCompletedBookType;
                    const rereadProgress = JSON.parse(sessionStorage.getItem(rereadKey) || '{}');
                    rereadProgress.vocabCompleted = true;
                    sessionStorage.setItem(rereadKey, JSON.stringify(rereadProgress));
                }
                needsUpdate = true;
            }

            // 다시 읽기 모드 처리
            if (isReReading) {
                isReReadingMode = true;
                const rereadKey = 'rereadProgress_' + currentWeek + '_' + targetBookType;
                const rereadProgress = JSON.parse(sessionStorage.getItem(rereadKey) || '{}');

                // 다시 읽기 모드에서 모든 활동 완료 시
                const rereadBookDone = rereadProgress.bookCompleted === true;
                const rereadQuizDone = rereadProgress.quizCompleted === true;
                const rereadVocabDone = rereadProgress.vocabCompleted === true || targetBookType === 'textbook';

                if (rereadBookDone && rereadQuizDone && rereadVocabDone) {
                    // 다시 읽기 완료 - 모드 해제 및 완료 상태로 복귀
                    sessionStorage.removeItem('isReReadingMode');
                    sessionStorage.removeItem(rereadKey);
                    isReReadingMode = false;
                    showToast('📚 다시 읽기 완료! 수고하셨어요!', 'success');
                }

                // 해당 책타입으로 전환
                if (currentBookType !== targetBookType) {
                    switchBookType(targetBookType);
                }
                updateLearningProgress();
                updateStepGauge();
                return; // 다시 읽기 모드에서는 여기서 종료
            }

            // 업데이트가 필요한 경우 (일반 모드)
            if (needsUpdate) {
                // 해당 책타입으로 전환 후 프로그래스 업데이트
                if (currentBookType !== targetBookType) {
                    switchBookType(targetBookType);
                }
                updateLearningProgress();
                updateStepGauge();
                updateHeaderRewardBoxState();

                // 모든 활동 완료 시 축하 토스트
                const progressKey = currentWeek + '_' + targetBookType;
                const progress = getWeekProgress(progressKey);
                const bookData = getWeekBookData(progressKey);

                const bookDone = bookData.completed === true;
                const quizDone = progress.quizCompleted === true;
                const vocabDone = progress.vocabCompleted === true;

                if (bookDone && quizDone && vocabDone) {
                    showToast('🎉 모든 활동 완료! 보상 상자를 열어보세요!', 'success');
                }
            }

            // 주간 완료 체크 (100% 달성 시 선물상자 잠금해제)
            checkWeekAllComplete();
        }

        // ===== Touch Swipe =====
        (function() {
            let startX = 0, dragging = false;
            const carousel = document.querySelector('.story-carousel');
            if (!carousel) return;
            carousel.addEventListener('touchstart', e => { startX = e.touches[0].clientX; dragging = true; }, { passive: true });
            carousel.addEventListener('touchend', e => {
                if (!dragging) return; dragging = false;
                const diff = startX - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 50) { diff > 0 ? nextPage() : prevPage(); }
            }, { passive: true });
        })();
    </script>

<!-- ===== Proto Navigation (공통 모듈) ===== -->
<link rel="stylesheet" href="../css/proto-nav.css">
<script src="../js/proto-nav.js"></script>

<!-- home.html 전용 시나리오 등록 -->
<script>
// ProtoNav refreshUI를 home.html용으로 연결
ProtoNav._refreshUI = function() {
    if (typeof updateBookDisplay === 'function') updateBookDisplay();
    if (typeof updateLearningProgress === 'function') updateLearningProgress();
    if (typeof updateStepGauge === 'function') updateStepGauge();
    if (typeof syncAllProgressBars === 'function') syncAllProgressBars();
    if (typeof updateBookTypeTabs === 'function') updateBookTypeTabs();
    if (typeof updateHeaderRewardBoxState === 'function') updateHeaderRewardBoxState();
};

// home.html 전용 시나리오 카테고리 등록
ProtoNav.registerScenarios([
    {
        title: '웅진북클럽 KRS',
        badge: '구독 시나리오',
        buttons: [
            { icon: 'fa-book-open', label: '코어북 학습 완료', onClick: () => {
                const week = currentWeek;
                const progressKey = week + '_core';
                const data = weeklyData[week].core;
                const bookData = {
                    title: data.book.title, type: data.bookType, level: data.book.level,
                    currentBookPage: data.totalPages, totalPages: data.totalPages,
                    week: week, bookType: 'core', completed: true
                };
                saveWeekBookData(bookData, progressKey);
                sessionStorage.setItem('currentBook', JSON.stringify(bookData));
                const progress = getWeekProgress(progressKey) || {};
                progress.bookCompleted = true; progress.quizCompleted = true;
                progress.quizScore = 100; progress.vocabCompleted = true;
                if (data.hasRetelling) progress.retellingCompleted = true;
                progress.weekCompleted = true; progress.allComplete = true;
                saveWeekProgress(progress, progressKey);
                hasAutoSwitchedWeeks['week_' + week + '_core'] = true;
                if (currentBookType !== 'core') { switchBookType('core'); }
                else { ProtoNav.refreshUI(); }
                ProtoNav.toast('코어북 학습 완료 적용');
            }},
            { icon: 'fa-book', label: '교과서 짝꿍책 완료', onClick: () => {
                const week = currentWeek;
                // 코어북 먼저 완료
                const coreKey = week + '_core';
                const coreData = weeklyData[week].core;
                const coreBook = { title: coreData.book.title, type: coreData.bookType, level: coreData.book.level,
                    currentBookPage: coreData.totalPages, totalPages: coreData.totalPages, week: week, bookType: 'core', completed: true };
                saveWeekBookData(coreBook, coreKey);
                const coreProg = getWeekProgress(coreKey) || {};
                coreProg.bookCompleted = true; coreProg.quizCompleted = true; coreProg.quizScore = 100; coreProg.vocabCompleted = true;
                if (coreData.hasRetelling) coreProg.retellingCompleted = true;
                coreProg.weekCompleted = true; coreProg.allComplete = true;
                saveWeekProgress(coreProg, coreKey);
                hasAutoSwitchedWeeks['week_' + week + '_core'] = true;
                // 교과서 짝꿍책 완료
                const textKey = week + '_textbook';
                const textData = weeklyData[week].textbook;
                const textBook = { title: textData.book.title, type: textData.bookType, level: textData.book.level,
                    currentBookPage: textData.totalPages, totalPages: textData.totalPages, week: week, bookType: 'textbook', completed: true };
                saveWeekBookData(textBook, textKey);
                sessionStorage.setItem('currentBook', JSON.stringify(textBook));
                const textProg = getWeekProgress(textKey) || {};
                textProg.bookCompleted = true; textProg.quizCompleted = true; textProg.quizScore = 100;
                textProg.weekCompleted = true; textProg.allComplete = true;
                saveWeekProgress(textProg, textKey);
                switchBookType('textbook');
                ProtoNav.toast('교과서 짝꿍책 완료 적용');
            }},
            { icon: 'fa-trophy', label: '주차 전체 완료 (코어+교과서)', onClick: () => {
                // textbookComplete 로직 재활용
                document.querySelector('[data-proto-scenario="textbookComplete"]')?.click();
                // 간단히 직접 실행
                const week = currentWeek;
                const coreKey = week + '_core'; const coreData = weeklyData[week].core;
                const coreBook = { title: coreData.book.title, type: coreData.bookType, level: coreData.book.level,
                    currentBookPage: coreData.totalPages, totalPages: coreData.totalPages, week: week, bookType: 'core', completed: true };
                saveWeekBookData(coreBook, coreKey);
                const coreProg = getWeekProgress(coreKey) || {};
                coreProg.bookCompleted = true; coreProg.quizCompleted = true; coreProg.quizScore = 100; coreProg.vocabCompleted = true;
                if (coreData.hasRetelling) coreProg.retellingCompleted = true;
                coreProg.weekCompleted = true; coreProg.allComplete = true;
                saveWeekProgress(coreProg, coreKey);
                hasAutoSwitchedWeeks['week_' + week + '_core'] = true;
                const textKey = week + '_textbook'; const textData = weeklyData[week].textbook;
                const textBook = { title: textData.book.title, type: textData.bookType, level: textData.book.level,
                    currentBookPage: textData.totalPages, totalPages: textData.totalPages, week: week, bookType: 'textbook', completed: true };
                saveWeekBookData(textBook, textKey);
                sessionStorage.setItem('currentBook', JSON.stringify(textBook));
                const textProg = getWeekProgress(textKey) || {};
                textProg.bookCompleted = true; textProg.quizCompleted = true; textProg.quizScore = 100;
                textProg.weekCompleted = true; textProg.allComplete = true;
                saveWeekProgress(textProg, textKey);
                sessionStorage.setItem('weekAllComplete_' + currentWeek, 'true');
                // 이미 접혀있으면 먼저 펼치기
                if (isWeekCollapsed) {
                    isWeekCollapsed = false;
                    const w = document.getElementById('carousel-wrapper');
                    if (w) { w.classList.remove('week-done-collapsed'); w.style.maxHeight = ''; }
                    const tb = document.getElementById('book-type-tabs');
                    if (tb) tb.style.display = '';
                    const banner = document.getElementById('week-done-banner');
                    if (banner) banner.classList.remove('visible');
                }
                sessionStorage.removeItem('isWeekCollapsed');
                // checkAndAutoCollapse의 자동 접기/축하 차단 (Proto Nav이 직접 처리)
                window._protoNavCollapsing = true;
                // UI 갱신 (switchBookType early return 방지)
                currentBookType = 'core';
                switchBookType('textbook');
                // 접기 (switchBookType 내부 타이밍보다 이후에 실행)
                setTimeout(() => {
                    window._protoNavCollapsing = false;
                    if (!isWeekCollapsed) toggleWeekCollapse();
                }, 1200);
                ProtoNav.toast('주차 전체 완료 (코어+교과서) 적용');
            }},
            { icon: 'fa-star', label: '추천도서 읽기 완료', onClick: () => {
                sessionStorage.setItem('recommendedBooksRead_week_' + currentWeek, '3');
                ProtoNav.toast('추천도서 읽기 완료 적용');
            }}
        ]
    },
    {
        title: '웅진북클럽 (일반)',
        badge: '가입 시나리오',
        buttons: [
            { icon: 'fa-user-plus', label: '무료체험 신청 전', onClick: () => {
                sessionStorage.clear(); localStorage.clear();
                sessionStorage.setItem('membershipStatus', 'none');
                ProtoNav.toast('무료체험 신청 전 상태 적용');
                setTimeout(() => location.reload(), 500);
            }},
            { icon: 'fa-user-clock', label: '무체 후 미가입', onClick: () => {
                sessionStorage.clear(); localStorage.clear();
                sessionStorage.setItem('membershipStatus', 'freeTrialComplete');
                sessionStorage.setItem('freeTrialCompleted', 'true');
                ProtoNav.toast('무체 후 미가입 상태 적용');
                setTimeout(() => location.reload(), 500);
            }},
            { icon: 'fa-user-check', label: '무체 후 KRS 전환', onClick: () => {
                sessionStorage.clear(); localStorage.clear();
                sessionStorage.setItem('membershipStatus', 'krs');
                sessionStorage.setItem('freeTrialCompleted', 'true');
                sessionStorage.setItem('krsSubscribed', 'true');
                ProtoNav.toast('무체 후 KRS 전환 상태 적용');
                setTimeout(() => location.reload(), 500);
            }}
        ]
    },
    {
        title: '유틸리티',
        badge: '도구',
        buttons: [
            { icon: 'fa-rotate-left', label: '현재 주차 초기화', onClick: () => {
                const week = currentWeek;
                ['core', 'textbook'].forEach(type => {
                    const key = week + '_' + type;
                    sessionStorage.removeItem(getProgressKey(key));
                    sessionStorage.removeItem(getBookKey(key));
                });
                sessionStorage.removeItem('currentBook');
                sessionStorage.removeItem('weekAllComplete_' + week);
                localStorage.removeItem('header_reward_claimed_week_' + week);
                localStorage.removeItem('bingoReward_week_' + week);
                if (typeof isReReadingMode !== 'undefined') isReReadingMode = false;
                sessionStorage.removeItem('isReReadingMode');
                // 주차완료 접힘 상태 해제
                if (typeof clearWeekAllCompleteState === 'function') clearWeekAllCompleteState();
                selectWeek(week);
                ProtoNav.refreshUI();
                ProtoNav.toast(week + '주차 초기화 완료');
            }},
            { icon: 'fa-trash-can', label: '전체 리셋', onClick: () => {
                sessionStorage.clear(); localStorage.clear();
                ProtoNav.toast('전체 리셋 (새로고침)');
                setTimeout(() => location.reload(), 500);
            }},
            { icon: 'fa-table-cells', label: '빙고판 완성', onClick: () => {
                bingoBoard = [5, 5, 5, 5, 5, 5, 5, 5, 5];
                bingoFlipped = [true, true, true, true, true, true, true, true, true];
                bingoOrbs = 0; bingoStars = 500;
                bingoCompletedLines = [0, 1, 2, 3, 4, 5, 6, 7];
                if (typeof updateBingoDisplay === 'function') updateBingoDisplay();
                ProtoNav.toast('빙고판 완성 적용');
                setTimeout(() => { if (typeof showBingoModal === 'function') showBingoModal(); }, 300);
            }},
            { type: 'week-btns', onClick: (w) => {
                selectWeek(w);
                ProtoNav.updateStatus();
                ProtoNav.toast(w + '주차로 이동');
            }}
        ]
    }
]);

// ===== 주차 전체 완료 - 드롭다운 접기/펼치기 =====
let isWeekAllCompleteCollapsed = false;

function applyWeekAllCompleteState() {
    isWeekAllCompleteCollapsed = true;

    const wrapper = document.getElementById('carousel-wrapper');
    const rewards = document.getElementById('header-rewards-group');
    const toggle = document.getElementById('week-done-toggle');
    const banner = document.getElementById('week-done-banner');
    const weekLabel = document.getElementById('week-label');

    // 1) carousel (학습완료~다시읽기) 접기
    if (wrapper) {
        wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
        requestAnimationFrame(() => {
            wrapper.classList.add('week-done-collapsed');
        });
    }

    // 2) 헤더 보상 영역 숨기기
    if (rewards) rewards.classList.add('week-done-hidden');

    // 3) 드롭다운 토글 버튼 표시
    if (toggle) {
        toggle.style.display = 'flex';
        toggle.classList.remove('expanded');
    }

    // 4) 완료 배너 표시
    if (banner) banner.classList.add('visible');

    // 5) 탭을 완료 스타일로
    document.querySelectorAll('.book-type-tab').forEach(t => {
        t.classList.add('tab-done');
        t.classList.remove('active');
    });

    // 6) 주차 라벨 완료 스타일
    if (weekLabel) weekLabel.classList.add('week-label-done');

    // 7) 추천도서 강조
    const recSection = document.getElementById('recommend-section');
    if (recSection) {
        recSection.classList.add('recommend-highlight');
        setTimeout(() => {
            recSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
    }
}

function clearWeekAllCompleteState() {
    isWeekAllCompleteCollapsed = false;

    const wrapper = document.getElementById('carousel-wrapper');
    const rewards = document.getElementById('header-rewards-group');
    const toggle = document.getElementById('week-done-toggle');
    const banner = document.getElementById('week-done-banner');
    const weekLabel = document.getElementById('week-label');

    if (wrapper) {
        wrapper.classList.remove('week-done-collapsed');
        // 애니메이션 후 정리
        setTimeout(() => { wrapper.style.maxHeight = ''; }, 500);
    }
    if (rewards) rewards.classList.remove('week-done-hidden');
    if (toggle) { toggle.style.display = 'none'; toggle.classList.remove('expanded'); }
    if (banner) banner.classList.remove('visible');
    if (weekLabel) weekLabel.classList.remove('week-label-done');
    document.querySelectorAll('.book-type-tab').forEach(t => {
        t.classList.remove('tab-done');
    });
}

function toggleWeekCompleteExpand() {
    const wrapper = document.getElementById('carousel-wrapper');
    const toggle = document.getElementById('week-done-toggle');
    const banner = document.getElementById('week-done-banner');
    const rewards = document.getElementById('header-rewards-group');

    if (isWeekAllCompleteCollapsed) {
        // 펼치기
        isWeekAllCompleteCollapsed = false;
        if (wrapper) wrapper.classList.remove('week-done-collapsed');
        if (toggle) toggle.classList.add('expanded');
        if (banner) banner.classList.remove('visible');
        if (rewards) rewards.classList.remove('week-done-hidden');
        // 탭 active 복원 (현재 bookType 기준)
        document.querySelectorAll('.book-type-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.bookType === currentBookType);
        });
        setTimeout(() => { if (wrapper) wrapper.style.maxHeight = ''; }, 500);
    } else {
        // 다시 접기
        isWeekAllCompleteCollapsed = true;
        if (wrapper) {
            wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
            requestAnimationFrame(() => { wrapper.classList.add('week-done-collapsed'); });
        }
        if (toggle) toggle.classList.remove('expanded');
        if (banner) banner.classList.add('visible');
        if (rewards) rewards.classList.add('week-done-hidden');
        document.querySelectorAll('.book-type-tab').forEach(t => {
            t.classList.add('tab-done');
            t.classList.remove('active');
        });
    }
}

// ===== 새로운 주차 접기/펼치기 토글 =====
let isWeekCollapsed = false;

function toggleWeekCollapse() {
    const wrapper = document.getElementById('carousel-wrapper');
    const toggle = document.getElementById('week-collapse-toggle');
    const toggleCompleted = document.getElementById('week-collapse-toggle-completed');
    const tabs = document.getElementById('book-type-tabs');
    const banner = document.getElementById('week-done-banner');

    if (isWeekCollapsed) {
        // 펼치기 - 족자처럼 위에서 아래로 펼쳐짐
        isWeekCollapsed = false;
        sessionStorage.setItem('isWeekCollapsed', 'false');

        if (wrapper) {
            wrapper.classList.remove('week-done-collapsed');
            setTimeout(() => { wrapper.style.maxHeight = ''; }, 600);
        }
        if (toggle) toggle.classList.remove('collapsed');
        if (toggleCompleted) toggleCompleted.classList.remove('collapsed');
        if (tabs) tabs.style.display = '';
        if (banner) banner.classList.remove('visible');

        // 추천도서 2권으로 축소
        toggleRecommendedBooks(false);
    } else {
        // 접기 - 족자처럼 아래에서 위로 말려 올라감
        isWeekCollapsed = true;
        sessionStorage.setItem('isWeekCollapsed', 'true');

        if (wrapper) {
            wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
            requestAnimationFrame(() => {
                wrapper.classList.add('week-done-collapsed');
            });
        }
        if (toggle) toggle.classList.add('collapsed');
        if (toggleCompleted) toggleCompleted.classList.add('collapsed');
        if (tabs) tabs.style.display = 'none';

        // 코어북과 교과서 짝꿍책 모두 완료 시 배너 표시
        const cp = getWeekProgress(currentWeek + '_core');
        const tp = getWeekProgress(currentWeek + '_textbook');
        if (cp && cp.allComplete && tp && tp.allComplete) {
            if (banner) banner.classList.add('visible');

            // 추천도서 4권으로 확장
            toggleRecommendedBooks(true);
        }
    }
}

// 추천도서 2권/4권 토글 함수
function toggleRecommendedBooks(expand) {
    const grid = document.querySelector('.netflix-books-grid');
    const extraBooks = document.querySelectorAll('.extra-book');

    if (expand) {
        // 4권으로 확장
        if (grid) grid.classList.add('expanded');
        extraBooks.forEach(book => {
            book.style.display = 'flex';
        });

        // EHEH 캐릭터 팝업 표시 (추천책 4권이 될 때마다 표시)
        setTimeout(() => {
            showTtottoRecommendPopup();
        }, 800);
    } else {
        // 2권으로 축소
        if (grid) grid.classList.remove('expanded');
        extraBooks.forEach(book => {
            book.style.display = 'none';
        });
    }
}

// 페이지 로드 시 추천도서 상태 초기화
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        // 주차가 접혀있고 완료 상태인지 확인
        const savedCollapseState = sessionStorage.getItem('isWeekCollapsed');
        const cp = getWeekProgress(currentWeek + '_core');
        const tp = getWeekProgress(currentWeek + '_textbook');

        if (savedCollapseState === 'true' && cp && cp.allComplete && tp && tp.allComplete) {
            // 추천도서 4권 표시
            toggleRecommendedBooks(true);
        }
    }, 100);
});

// 주차 전체 완료 시 자동으로 접기
function checkAndAutoCollapse() {
    const cp = getWeekProgress(currentWeek + '_core');
    const tp = getWeekProgress(currentWeek + '_textbook');
    const toggleBtn = document.getElementById('week-collapse-toggle');
    const toggleBtnCompleted = document.getElementById('week-collapse-toggle-completed');

    // 코어북과 교과서 짝꿍책 모두 완료 시 버튼 표시
    if (cp && cp.allComplete && tp && tp.allComplete) {
        // 진행 화면의 버튼은 숨김
        if (toggleBtn) toggleBtn.classList.remove('show');
        // 완료 화면의 버튼만 표시
        if (toggleBtnCompleted) toggleBtnCompleted.style.display = 'flex';

        // Proto Nav이 직접 접기/축하를 처리 중이면 자동 접기 건너뜀
        if (window._protoNavCollapsing) return;

        // sessionStorage에서 접힌 상태 확인
        const savedCollapseState = sessionStorage.getItem('isWeekCollapsed');

        if (savedCollapseState === 'true' && !isWeekCollapsed) {
            // 저장된 상태가 접힘이면 즉시 접기
            toggleWeekCollapse();
        } else if (!isWeekCollapsed && savedCollapseState === null) {
            // 최초 완료 시 자동 접기
            setTimeout(() => {
                toggleWeekCollapse();
            }, 600);
        }
    } else {
        // 미완료 시 버튼 숨김
        if (toggleBtn) toggleBtn.classList.remove('show');
        if (toggleBtnCompleted) toggleBtnCompleted.style.display = 'none';
    }
}

// 탭 클릭 시 주차완료 접힌 상태면 펼치기
const origSwitchBookType = switchBookType;
switchBookType = function(bookType) {
    if (isWeekAllCompleteCollapsed) {
        toggleWeekCompleteExpand();
    }
    if (currentBookType === bookType && !isWeekAllCompleteCollapsed) return;
    origSwitchBookType(bookType);
};

// 페이지 로드 시 주차완료 상태 복원
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        // 새로운 주차 접기 체크
        checkAndAutoCollapse();

        // 기존 주차 완료 상태 복원 (호환성)
        if (sessionStorage.getItem('weekAllComplete_' + currentWeek) === 'true') {
            const cp = getWeekProgress(currentWeek + '_core');
            const tp = getWeekProgress(currentWeek + '_textbook');
            if (cp && cp.allComplete && tp && tp.allComplete) {
                applyWeekAllCompleteState();
            }
        }
    }, 800);
});
</script>

<!-- 빙고 토스트 알림 (overflow-hidden 밖에 배치) -->
<div id="bingo-toast" class="bingo-toast"></div>
</body>
</html>
