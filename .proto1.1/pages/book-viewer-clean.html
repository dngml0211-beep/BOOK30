<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶í´ëŸ½ 3.0 - ë…ì„œ ë·°ì–´</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Common JS -->
    <script src="../js/common.js"></script>

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }
        body { background: linear-gradient(180deg, #FFF7ED 0%, #FEF3C7 50%, #ECFDF5 100%); }

        /* iframe ì»¨í…Œì´ë„ˆ - ì „ì²´ í™”ë©´ (ê³ ì •) */
        .viewer-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            overflow: hidden;
        }
        .viewer-frame {
            width: 100%;
            height: 100%;
            border: none;
            margin-top: 0;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top-color: #FF9F43;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            max-width: 400px;
            text-align: center;
            padding: 24px;
        }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .back-btn {
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            transform: scale(1.05);
        }
        .back-btn:active {
            transform: scale(0.95);
        }

        /* í—¤ë” í† ê¸€ */
        header {
            transition: transform 0.3s ease;
        }
        header.hidden {
            transform: translateY(-100%);
        }

    </style>
</head>
<body class="font-sans text-gray-800 h-screen overflow-hidden">
    <!-- Top Header (í•œ ì¤„) -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-b border-orange-100 shadow-sm">
        <div class="relative flex items-center justify-between px-4 py-2.5">
            <!-- Left: Back Button + Chatbot Test -->
            <div class="flex items-center gap-2 flex-shrink-0">
                <button onclick="goBack()" class="back-btn w-9 h-9 bg-orange-50 hover:bg-orange-100 rounded-lg flex items-center justify-center text-brand-primary transition-colors">
                    <i class="fa-solid fa-arrow-left text-sm"></i>
                </button>

                <!-- ì±—ë´‡ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
                <button onclick="toggleBuddyTestPanel()" class="bg-green-600 hover:bg-green-500 px-2.5 py-1.5 rounded-lg text-white text-xs font-bold transition-colors flex items-center gap-1.5" title="ì±—ë´‡ í…ŒìŠ¤íŠ¸ ëª¨ë“œ">
                    <span>â—</span>
                    <span class="hidden sm:inline">ì±—ë´‡ í…ŒìŠ¤íŠ¸</span>
                </button>
            </div>

            <!-- Center: Title (ì ˆëŒ€ ì¤‘ì•™ ì •ë ¬) -->
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center text-center pointer-events-none">
                <h1 class="font-noto text-sm font-bold text-gray-800" id="content-title">ì˜¤ì¦ˆì˜ ë§ˆë²•ì‚¬</h1>
                <p class="text-xs text-gray-400" id="content-subtitle">AI ë²„ë””ì™€ í•¨ê»˜ ì½ê¸°</p>
            </div>

            <!-- Right: Badge -->
            <div class="flex items-center gap-1.5 bg-gradient-to-r from-orange-50 to-amber-50 px-2.5 py-1.5 rounded-lg border border-orange-100 flex-shrink-0">
                <span class="text-base">ğŸ¿ï¸</span>
                <span class="font-noto text-xs text-brand-primary font-bold hidden sm:inline" id="level-badge">K2-1</span>
            </div>
        </div>
    </header>


    <!-- Viewer Container -->
    <div class="viewer-container" id="viewer-container">
        <!-- Loading Overlay -->
        <div class="loader-overlay" id="loader-overlay">
            <div class="loader-spinner"></div>
            <p class="font-noto text-gray-600 mt-4">ë…ì„œ ë·°ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- Book Viewer (ë…ì„œë·°ì–´ë§Œ) -->
        <iframe id="book-viewer-frame"
            class="viewer-frame"
            src="book-reader.html"
            title="ë…ì„œ ë·°ì–´">
        </iframe>

        <!-- Error Message (hidden by default) -->
        <div class="error-message hidden" id="error-message">
            <div class="text-6xl mb-4">ğŸ˜¢</div>
            <h3 class="font-noto text-xl text-gray-800 mb-2">ë·°ì–´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-sm text-gray-500 mb-4">íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            <button onclick="location.reload()" class="px-6 py-2 bg-brand-primary text-white rounded-xl hover:bg-orange-600 transition-colors">
                <i class="fa-solid fa-rotate-right mr-2"></i>ë‹¤ì‹œ ì‹œë„
            </button>
        </div>
    </div>

    <script>
        /**
         * DOM ìš”ì†Œ ì°¸ì¡°
         */
        const frame = document.getElementById('book-viewer-frame');
        const loaderOverlay = document.getElementById('loader-overlay');
        const errorMessage = document.getElementById('error-message');
        const header = document.querySelector('header');
        let headerVisible = true;

        /**
         * postMessage í†µì‹  ìˆ˜ì‹ 
         */
        window.addEventListener('message', (event) => {
            const { type, data } = event.data;

            switch (type) {
                case 'PAGE_CHANGED':
                    handlePageProgress(data);
                    break;

                case 'BOOK_COMPLETED':
                    handleBookCompletion(data);
                    break;

                case 'UI_VISIBILITY_CHANGED':
                    handleUIVisibilityChange(data.visible);
                    break;
            }
        });

        /**
         * í˜ì´ì§€ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
         */
        function handlePageProgress(data) {
            const progressData = {
                bookId: data.bookId,
                currentPage: data.currentPage || 1,
                totalPages: data.totalPages || 32,
                percentage: data.percentage || 0,
                lastRead: new Date().toISOString()
            };

            // í˜„ì¬ ì±… ì •ë³´ ì—…ë°ì´íŠ¸
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            currentBook.currentPage = progressData.currentPage;
            currentBook.totalPages = progressData.totalPages;
            currentBook.percentage = progressData.percentage;
            currentBook.lastRead = progressData.lastRead;
            sessionStorage.setItem('currentBook', JSON.stringify(currentBook));

            sessionStorage.setItem('readingProgress', JSON.stringify(progressData));
        }

        /**
         * ì™„ë… ì´ë²¤íŠ¸ ì²˜ë¦¬
         */
        function handleBookCompletion(data) {
            const completionData = {
                bookId: data.bookId,
                bookTitle: data.bookTitle,
                completedAt: new Date().toISOString(),
                readingTime: data.readingTime || 0,
                pageCount: data.pageCount || 0
            };

            const completions = JSON.parse(sessionStorage.getItem('bookCompletions') || '[]');
            completions.push(completionData);
            sessionStorage.setItem('bookCompletions', JSON.stringify(completions));

            sessionStorage.setItem('bookJustCompleted', 'true');
            sessionStorage.setItem('lastCompletedBook', JSON.stringify(completionData));
        }

        /**
         * ì™„ë… í…ŒìŠ¤íŠ¸
         */
        function testBookCompletion() {
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            const testData = {
                bookId: currentBook.id || 'test-book-1',
                bookTitle: currentBook.title || 'í…ŒìŠ¤íŠ¸ ë„ì„œ',
                completedAt: new Date().toISOString(),
                readingTime: 1200,
                pageCount: 32
            };

            handleBookCompletion(testData);
            alert('âœ… ì™„ë… ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!\ní™ˆìœ¼ë¡œ ëŒì•„ê°€ì„œ ì™„ë… ë±ƒì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }

        /**
         * ì±—ë´‡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ í† ê¸€
         */
        function toggleBuddyTestPanel() {
            if (frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'TOGGLE_BUDDY_TEST_PANEL' }, '*');
            }
        }

        /**
         * iframe UI ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬
         */
        function handleUIVisibilityChange(visible) {
            if (visible) {
                showHeader();
            } else {
                hideHeader();
            }
        }

        /**
         * iframe ì´ë²¤íŠ¸ ì²˜ë¦¬
         */
        frame.addEventListener('load', () => {
            setTimeout(() => loaderOverlay.style.display = 'none', 500);

            // ì‚¬ìš©ì ì •ë³´ ì „ë‹¬
            if (frame.contentWindow) {
                frame.contentWindow.postMessage({
                    type: 'USER_INFO',
                    data: AppState.getUserInfo()
                }, '*');
            }
        });

        frame.addEventListener('error', () => {
            loaderOverlay.style.display = 'none';
            errorMessage.classList.remove('hidden');
        });

        /**
         * í—¤ë” í† ê¸€ ê¸°ëŠ¥
         */
        function showHeader() {
            headerVisible = true;
            header.classList.remove('hidden');
        }

        function hideHeader() {
            headerVisible = false;
            header.classList.add('hidden');
        }

        function toggleHeader() {
            headerVisible ? hideHeader() : showHeader();

            // iframe UIë„ í•¨ê»˜ í† ê¸€
            if (frame.contentWindow) {
                frame.contentWindow.postMessage({ type: 'TOGGLE_UI' }, '*');
            }
        }

        /**
         * í´ë¦­ í† ê¸€ í™œì„±í™”
         */
        function enableClickToggle() {
            // ì™¸ë¶€ ì˜ì—­ í´ë¦­ ì‹œ í—¤ë” í† ê¸€
            document.addEventListener('click', (e) => {
                if (e.target.closest('header')) {
                    return;
                }
                toggleHeader();
            });
        }

        // ìŠ¤í˜ì´ìŠ¤ë°”/ESCë¡œ í† ê¸€
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Escape') {
                e.preventDefault();
                toggleHeader();
            }
        });

        /**
         * ì´ˆê¸°í™”
         */
        document.addEventListener('DOMContentLoaded', () => {
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');

            if (currentBook.title) {
                document.getElementById('content-title').textContent = currentBook.title;
                document.getElementById('content-subtitle').textContent = currentBook.author || 'AI ë²„ë””ì™€ í•¨ê»˜ ì½ê¸°';
            }

            // í™ˆí™”ë©´ì—ì„œ ê°€ì ¸ì˜¨ ë ˆë²¨ í‘œì‹œ
            if (currentBook.level) {
                document.getElementById('level-badge').textContent = currentBook.level;
            }

            enableClickToggle();
        });
    </script>
</body>
</html>
