<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶í´ëŸ½ 3.0 - ë…ì„œ ë·°ì–´</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Common JS -->
    <script src="../js/common.js"></script>

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }
        body { background: linear-gradient(180deg, #FFF7ED 0%, #FEF3C7 50%, #ECFDF5 100%); }

        /* iframe ì»¨í…Œì´ë„ˆ - ì „ì²´ í™”ë©´ */
        .viewer-container {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            overflow: hidden;
        }
        .viewer-frame {
            width: 100%;
            height: calc(100% + 50px);
            border: none;
            margin-top: -50px;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top-color: #FF9F43;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            max-width: 400px;
            text-align: center;
            padding: 24px;
        }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .back-btn {
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            transform: scale(1.05);
        }
        .back-btn:active {
            transform: scale(0.95);
        }

        /* í—¤ë” ìë™ ìˆ¨ê¹€ */
        header {
            transition: transform 0.3s ease;
        }
        header.hidden {
            transform: translateY(-100%);
        }

        /* ë·°ì–´ ì»¨í…Œì´ë„ˆ ì „ì²´ í™”ë©´ ëª¨ë“œ */
        .viewer-container.fullscreen {
            top: 0;
        }

        /* í”Œë¡œíŒ… ì™„ë… ë²„íŠ¼ (í—¤ë” ìˆ¨ê¹€ ì‹œ) */
        .floating-test-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 16px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            font-size: 13px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .floating-test-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .floating-test-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
        }
        .floating-test-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 640px) {
            .viewer-container {
                top: 48px;
            }
            .viewer-container.fullscreen {
                top: 0;
            }
            .floating-test-btn {
                bottom: 80px;
                right: 16px;
                padding: 10px 14px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="font-sans text-gray-800 h-screen overflow-hidden">
    <!-- Top Header (í•œ ì¤„) -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-b border-orange-100 shadow-sm">
        <div class="flex items-center px-4 py-2.5">
            <!-- Left: Back + Test Buttons -->
            <div class="flex items-center gap-2 flex-shrink-0">
                <button onclick="goBack()" class="back-btn w-9 h-9 bg-orange-50 hover:bg-orange-100 rounded-lg flex items-center justify-center text-brand-primary transition-colors">
                    <i class="fa-solid fa-arrow-left text-sm"></i>
                </button>

                <!-- ì±—ë´‡ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
                <button onclick="toggleBuddyTestPanel()" class="bg-green-600 hover:bg-green-500 px-2.5 py-1.5 rounded-lg text-white text-xs font-bold transition-colors flex items-center gap-1.5" title="ì±—ë´‡ í…ŒìŠ¤íŠ¸ ëª¨ë“œ">
                    <span>â—</span>
                    <span class="hidden sm:inline">ì±—ë´‡ í…ŒìŠ¤íŠ¸</span>
                </button>

                <!-- ì™„ë… í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
                <button onclick="testBookCompletion()" class="bg-green-100 hover:bg-green-200 px-2.5 py-1.5 rounded-lg text-green-700 text-xs font-bold transition-colors flex items-center gap-1.5" title="ì™„ë… í…ŒìŠ¤íŠ¸">
                    <i class="fa-solid fa-check-circle"></i>
                    <span class="hidden sm:inline">ì™„ë…</span>
                </button>
            </div>

            <!-- Center: Title (ì¤‘ì•™ ì •ë ¬) -->
            <div class="flex-1 flex flex-col items-center justify-center text-center px-4">
                <h1 class="font-noto text-sm font-bold text-gray-800" id="content-title">ì˜¤ì¦ˆì˜ ë§ˆë²•ì‚¬</h1>
                <p class="text-xs text-gray-400" id="content-subtitle">AI ë²„ë””ì™€ í•¨ê»˜ ì½ê¸°</p>
            </div>

            <!-- Right: Badge -->
            <div class="flex items-center gap-1.5 bg-gradient-to-r from-orange-50 to-amber-50 px-2.5 py-1.5 rounded-lg border border-orange-100 flex-shrink-0">
                <span class="text-base">ğŸ¿ï¸</span>
                <span class="font-noto text-xs text-brand-primary font-bold hidden sm:inline">Lv.5</span>
            </div>
        </div>
    </header>

    <!-- í”Œë¡œíŒ… ì™„ë… í…ŒìŠ¤íŠ¸ ë²„íŠ¼ (í—¤ë” ìˆ¨ê¹€ ì‹œ í‘œì‹œ) -->
    <button onclick="testBookCompletion()" class="floating-test-btn font-noto" id="floating-test-btn">
        <i class="fa-solid fa-check-circle"></i>
        <span>ì™„ë… í…ŒìŠ¤íŠ¸</span>
    </button>

    <!-- Viewer Container -->
    <div class="viewer-container" id="viewer-container">
        <!-- Loading Overlay -->
        <div class="loader-overlay" id="loader-overlay">
            <div class="loader-spinner"></div>
            <p class="font-noto text-gray-600 mt-4">ë…ì„œ ë·°ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- Book Viewer (ë…ì„œë·°ì–´ë§Œ) -->
        <iframe id="book-viewer-frame"
            class="viewer-frame"
            src="../../ë¶í´ëŸ½3.0_í†µí•©ë·°ì–´/prototype/1.í†µí•©ë·°ì–´/ë¶í´ëŸ½3.0_ë…ì„œë·°ì–´_v0.3.html"
            title="ë…ì„œ ë·°ì–´">
        </iframe>

        <!-- Error Message (hidden by default) -->
        <div class="error-message hidden" id="error-message">
            <div class="text-6xl mb-4">ğŸ˜¢</div>
            <h3 class="font-noto text-xl text-gray-800 mb-2">ë·°ì–´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-sm text-gray-500 mb-4">íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            <button onclick="location.reload()" class="px-6 py-2 bg-brand-primary text-white rounded-xl hover:bg-orange-600 transition-colors">
                <i class="fa-solid fa-rotate-right mr-2"></i>ë‹¤ì‹œ ì‹œë„
            </button>
        </div>
    </div>

    <script>
        /**
         * postMessage í†µì‹  ìˆ˜ì‹ 
         */
        window.addEventListener('message', (event) => {
            const { type, data } = event.data;
            console.log('[Viewer] Message received:', type, data);

            switch (type) {
                case 'VIEWER_READY':
                    console.log('[Viewer] Book viewer is ready');
                    break;

                case 'PAGE_CHANGED':
                    console.log('[Viewer] Page changed:', data);
                    handlePageProgress(data);
                    break;

                case 'BOOK_COMPLETED':
                    console.log('[Viewer] Book reading completed:', data);
                    handleBookCompletion(data);
                    break;

                case 'UI_VISIBILITY_CHANGED':
                    console.log('[Viewer] UI visibility changed:', data);
                    handleUIVisibilityChange(data.visible);
                    break;

                default:
                    console.warn('[Viewer] Unknown message type:', type);
            }
        });

        /**
         * í˜ì´ì§€ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
         */
        function handlePageProgress(data) {
            const progressData = {
                bookId: data.bookId,
                currentPage: data.currentPage || 1,
                totalPages: data.totalPages || 32,
                percentage: data.percentage || 0,
                lastRead: new Date().toISOString()
            };

            // í˜„ì¬ ì±… ì •ë³´ ì—…ë°ì´íŠ¸
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            currentBook.currentPage = progressData.currentPage;
            currentBook.totalPages = progressData.totalPages;
            currentBook.percentage = progressData.percentage;
            currentBook.lastRead = progressData.lastRead;
            sessionStorage.setItem('currentBook', JSON.stringify(currentBook));

            // ì½ê¸° ì§„í–‰ë¥  ì €ì¥
            sessionStorage.setItem('readingProgress', JSON.stringify(progressData));

            console.log('[Viewer] Progress updated:', progressData);
        }

        /**
         * ì™„ë… ì´ë²¤íŠ¸ ì²˜ë¦¬
         */
        function handleBookCompletion(data) {
            const completionData = {
                bookId: data.bookId,
                bookTitle: data.bookTitle,
                completedAt: new Date().toISOString(),
                readingTime: data.readingTime || 0,
                pageCount: data.pageCount || 0
            };

            // sessionStorageì— ì €ì¥
            const completions = JSON.parse(sessionStorage.getItem('bookCompletions') || '[]');
            completions.push(completionData);
            sessionStorage.setItem('bookCompletions', JSON.stringify(completions));

            // ì™„ë… í”Œë˜ê·¸ ì„¤ì •
            sessionStorage.setItem('bookJustCompleted', 'true');
            sessionStorage.setItem('lastCompletedBook', JSON.stringify(completionData));

            console.log('[Viewer] Book completion saved:', completionData);
        }

        /**
         * ì™„ë… í…ŒìŠ¤íŠ¸ (ê°œë°œìš©)
         */
        function testBookCompletion() {
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');

            const testData = {
                bookId: currentBook.id || 'test-book-1',
                bookTitle: currentBook.title || 'í…ŒìŠ¤íŠ¸ ë„ì„œ',
                completedAt: new Date().toISOString(),
                readingTime: 1200,
                pageCount: 32
            };

            console.log('[Test] Simulating book completion:', testData);
            handleBookCompletion(testData);

            alert('âœ… ì™„ë… ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!\ní™ˆìœ¼ë¡œ ëŒì•„ê°€ì„œ ì™„ë… ë±ƒì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }

        /**
         * ì±—ë´‡ í…ŒìŠ¤íŠ¸ íŒ¨ë„ í† ê¸€
         */
        function toggleBuddyTestPanel() {
            const frame = document.getElementById('book-viewer-frame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({
                    type: 'TOGGLE_BUDDY_TEST_PANEL'
                }, '*');
            }
        }

        /**
         * iframe UI ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬
         */
        function handleUIVisibilityChange(visible) {
            if (visible) {
                showHeader();
            } else {
                hideHeader();
            }
        }

        /**
         * iframe ë¡œë”© ì™„ë£Œ
         */
        document.getElementById('book-viewer-frame').addEventListener('load', () => {
            console.log('[Viewer] Book viewer loaded');
            setTimeout(() => {
                document.getElementById('loader-overlay').style.display = 'none';
            }, 500);

            // ì‚¬ìš©ì ì •ë³´ ì „ë‹¬
            const userInfo = AppState.getUserInfo();
            const frame = document.getElementById('book-viewer-frame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({
                    type: 'USER_INFO',
                    data: userInfo
                }, '*');
            }
        });

        /**
         * iframe ë¡œë”© ì—ëŸ¬
         */
        document.getElementById('book-viewer-frame').addEventListener('error', () => {
            console.error('[Viewer] Failed to load book viewer');
            document.getElementById('loader-overlay').style.display = 'none';
            document.getElementById('error-message').classList.remove('hidden');
        });

        /**
         * í—¤ë” í† ê¸€ ê¸°ëŠ¥
         */
        let headerVisible = true;
        const header = document.querySelector('header');
        const viewerContainer = document.getElementById('viewer-container');
        const floatingBtn = document.getElementById('floating-test-btn');

        function showHeader() {
            headerVisible = true;
            header.classList.remove('hidden');
            viewerContainer.classList.remove('fullscreen');
            floatingBtn.classList.remove('visible');
        }

        function hideHeader() {
            headerVisible = false;
            header.classList.add('hidden');
            viewerContainer.classList.add('fullscreen');
            floatingBtn.classList.add('visible');
        }

        function toggleHeader() {
            if (headerVisible) {
                hideHeader();
            } else {
                showHeader();
            }

            // iframe UIë„ í•¨ê»˜ í† ê¸€
            const frame = document.getElementById('book-viewer-frame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({
                    type: 'TOGGLE_UI'
                }, '*');
            }
        }

        // í™”ë©´ ì „ì²´ í´ë¦­ ì‹œ í—¤ë” í† ê¸€
        let clickListenerActive = false;

        // iframeì´ ë¡œë“œë˜ë©´ í´ë¦­ ê°ì§€ë¥¼ ìœ„í•œ ì˜¤ë²„ë ˆì´ ì¶”ê°€
        function enableClickToggle() {
            if (clickListenerActive) return;
            clickListenerActive = true;

            // iframe ìœ„ì— íˆ¬ëª… ì˜¤ë²„ë ˆì´ë¥¼ ì ê¹ ë³´ì—¬ì¤¬ë‹¤ ìˆ¨ê¸°ëŠ” ë°©ì‹ìœ¼ë¡œ í´ë¦­ ê°ì§€
            document.addEventListener('click', (e) => {
                // í—¤ë”ë‚˜ ë²„íŠ¼ í´ë¦­ì€ ë¬´ì‹œ
                if (e.target.closest('header') || e.target.closest('.floating-test-btn')) {
                    return;
                }
                toggleHeader();
            });

            // iframe ì˜ì—­ í´ë¦­ë„ ê°ì§€
            window.addEventListener('blur', () => {
                // iframe í´ë¦­ ì‹œ blur ì´ë²¤íŠ¸ ë°œìƒ
                setTimeout(() => {
                    if (document.activeElement.tagName === 'IFRAME') {
                        toggleHeader();
                    }
                }, 100);
            });
        }

        // ìŠ¤í˜ì´ìŠ¤ë°”/ESCë¡œ í† ê¸€
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Escape') {
                e.preventDefault();
                toggleHeader();
            }
        });

        /**
         * ì´ˆê¸°í™”
         */
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Viewer] Book viewer initialized');

            // ì±… ì •ë³´ í‘œì‹œ
            const currentBook = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            if (currentBook.title) {
                document.getElementById('content-title').textContent = currentBook.title;
                document.getElementById('content-subtitle').textContent = currentBook.author || 'AI ë²„ë””ì™€ í•¨ê»˜ ì½ê¸°';
            }

            // í´ë¦­ í† ê¸€ í™œì„±í™”
            enableClickToggle();
        });
    </script>
</body>
</html>
