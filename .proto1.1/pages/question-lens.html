<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶í´ëŸ½ 3.0 - ì§ˆë¬¸ë Œì¦ˆ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1'
                        },
                        lens: {
                            purple: '#8B5CF6',
                            purpleDark: '#6D28D9',
                            pink: '#EC4899',
                            blue: '#3B82F6',
                            green: '#10B981'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }

        body {
            background: linear-gradient(180deg, #F3E8FF 0%, #E9D5FF 50%, #DDD6FE 100%);
        }

        /* ì±„íŒ… ë²„ë¸” */
        .chat-bubble {
            animation: bubbleIn 0.4s ease-out;
        }
        @keyframes bubbleIn {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chat-bubble.buddy {
            background: white;
            border-radius: 20px 20px 20px 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #8B5CF6, #6D28D9);
            color: white;
            border-radius: 20px 20px 4px 20px;
        }

        /* ë²„ë”” ì•„ë°”íƒ€ */
        .buddy-avatar {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* ì§ˆë¬¸ ì¹´ë“œ */
        .question-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .question-card:hover {
            transform: translateY(-6px) scale(1.02);
        }
        .question-card:active {
            transform: translateY(-2px) scale(0.98);
        }

        /* 3D ë²„íŠ¼ */
        .btn-3d {
            transform: translateY(-4px);
            transition: all 0.1s ease;
        }
        .btn-3d:active {
            transform: translateY(0);
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator span {
            animation: typingBounce 1.4s ease-in-out infinite;
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* ì„ íƒëœ ì¹´ë“œ */
        .question-card.selected {
            border-color: #8B5CF6;
            background: linear-gradient(135deg, #F3E8FF, #E9D5FF);
            transform: scale(1.05);
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* ë°˜ì§ì„ íš¨ê³¼ */
        .sparkle {
            animation: sparkle 2s ease-in-out infinite;
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜ */
        .complete-badge {
            animation: badgePop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes badgePop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* ì±… ì„ íƒ ë²„íŠ¼ */
        .book-select-btn {
            animation: fadeInUp 0.5s ease-out backwards;
        }
        .book-select-btn:nth-child(1) { animation-delay: 0.1s; }
        .book-select-btn:nth-child(2) { animation-delay: 0.2s; }
        .book-select-btn:nth-child(3) { animation-delay: 0.3s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .book-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
        }
    </style>
</head>
<body class="font-sans text-gray-800 min-h-screen overflow-hidden flex flex-col">
    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-purple-100 px-6 py-4">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 bg-purple-50 hover:bg-purple-100 rounded-xl flex items-center justify-center text-purple-600 transition-colors">
                <i class="fa-solid fa-arrow-left"></i>
            </button>

            <div class="flex items-center gap-2 absolute left-1/2 -translate-x-1/2">
                <span class="text-2xl">ğŸ”</span>
                <span class="font-noto text-lg text-purple-600">ì§ˆë¬¸ ë Œì¦ˆ</span>
            </div>

            <!-- ì±… ì •ë³´ (ì±… ì„ íƒ í›„ í‘œì‹œ) -->
            <div id="header-book-info" class="hidden items-center gap-2 bg-purple-50 px-3 py-1.5 rounded-full">
                <span class="text-sm">ğŸ“–</span>
                <span id="header-book-title" class="text-xs text-purple-600 font-medium">ë§ˆë²•ì‚¬ì˜ ë¬¼ì•½</span>
            </div>
            <!-- ì±… ì •ë³´ê°€ ì—†ì„ ë•Œ ê· í˜•ì„ ìœ„í•œ placeholder -->
            <div id="header-placeholder" class="w-10 h-10"></div>
        </div>
    </header>

    <!-- ì±… ì„ íƒ í™”ë©´ -->
    <div id="book-selection-screen" class="flex-1 flex flex-col items-center justify-center px-4 py-8">
        <div class="max-w-md w-full text-center">
            <!-- ë²„ë”” ì¸ì‚¬ -->
            <div class="buddy-avatar w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-5xl shadow-xl">
                ğŸ¿ï¸
            </div>
            <h2 class="font-noto text-2xl text-purple-700 mb-2">ì•ˆë…•! ë‚˜ëŠ” ë²„ë””ì•¼!</h2>
            <p class="text-gray-600 mb-8">ìš°ë¦¬ ì–´ë–¤ ì±…ìœ¼ë¡œ ì´ì•¼ê¸°í• ê¹Œ?</p>

            <!-- ìµœê·¼ ì½ì€ ì±… ë¦¬ìŠ¤íŠ¸ -->
            <div class="space-y-3" id="book-list">
                <!-- ì±… 1 -->
                <button onclick="selectBook('magic-potion')" class="book-select-btn w-full bg-white hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 rounded-2xl p-4 flex items-center gap-4 transition-all group">
                    <div class="w-14 h-18 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-xl flex items-center justify-center text-2xl shadow-md group-hover:scale-105 transition-transform">
                        ğŸ§™â€â™‚ï¸
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-noto text-gray-800 group-hover:text-purple-600">ë§ˆë²•ì‚¬ì˜ ë¬¼ì•½</p>
                        <p class="text-xs text-gray-400">ì˜¤ëŠ˜ ì½ì€ ì±…</p>
                    </div>
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </button>

                <!-- ì±… 2 -->
                <button onclick="selectBook('forest-friends')" class="book-select-btn w-full bg-white hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 rounded-2xl p-4 flex items-center gap-4 transition-all group">
                    <div class="w-14 h-18 bg-gradient-to-br from-green-400 to-emerald-500 rounded-xl flex items-center justify-center text-2xl shadow-md group-hover:scale-105 transition-transform">
                        ğŸŒ²
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-noto text-gray-800 group-hover:text-purple-600">ìˆ²ì† ì¹œêµ¬ë“¤</p>
                        <p class="text-xs text-gray-400">ì–´ì œ ì½ì€ ì±…</p>
                    </div>
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </button>

                <!-- ì±… 3 -->
                <button onclick="selectBook('princess-dragon')" class="book-select-btn w-full bg-white hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 rounded-2xl p-4 flex items-center gap-4 transition-all group">
                    <div class="w-14 h-18 bg-gradient-to-br from-pink-400 to-rose-500 rounded-xl flex items-center justify-center text-2xl shadow-md group-hover:scale-105 transition-transform">
                        ğŸ‰
                    </div>
                    <div class="flex-1 text-left">
                        <p class="font-noto text-gray-800 group-hover:text-purple-600">ê³µì£¼ì™€ ìš©</p>
                        <p class="text-xs text-gray-400">3ì¼ ì „ ì½ì€ ì±…</p>
                    </div>
                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-right text-sm"></i>
                    </div>
                </button>
            </div>

            <p class="text-xs text-gray-400 mt-6">
                <i class="fa-solid fa-clock mr-1"></i>
                ìµœê·¼ ì½ì€ ìˆœì„œë¡œ ë³´ì—¬ë“œë ¤ìš”
            </p>
        </div>
    </div>

    <!-- ì±„íŒ… ì˜ì—­ (ì²˜ìŒì— ìˆ¨ê¹€) -->
    <main class="flex-1 overflow-y-auto hide-scrollbar px-4 py-6 hidden" id="chat-container">
        <div class="max-w-2xl mx-auto space-y-6" id="chat-messages">
            <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
    </main>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <footer class="bg-white/95 backdrop-blur-lg border-t border-purple-100 px-4 py-4" id="input-area">
        <div class="max-w-2xl mx-auto">
            <!-- ì´ˆê¸° ìƒíƒœ: ì‹œì‘ ë²„íŠ¼ (ì±… ì„ íƒ í›„ í‘œì‹œ) -->
            <div id="start-section" class="hidden text-center">
                <button onclick="startConversation()" class="btn-3d px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-noto text-lg shadow-lg" style="box-shadow: 0 6px 0 #6D28D9, 0 8px 20px rgba(0,0,0,0.15);">
                    <i class="fa-solid fa-comments mr-2"></i> ëŒ€í™” ì‹œì‘í•˜ê¸°
                </button>
            </div>

            <!-- ì§ˆë¬¸ ì¹´ë“œ ì„ íƒ -->
            <div id="card-selection" class="hidden">
                <p class="text-center text-sm text-gray-500 mb-3">ë­ê°€ ê¶ê¸ˆí•œì§€ í•˜ë‚˜ë§Œ ê³¨ë¼ë´!</p>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="selectQuestionCard('who')" class="question-card bg-gradient-to-br from-blue-50 to-indigo-50 border-3 border-blue-200 rounded-2xl p-4 text-center" data-card="who">
                        <span class="text-3xl mb-2 block">ğŸ‘¤</span>
                        <span class="font-noto text-blue-600 text-sm">ëˆ„êµ¬ì¼ê¹Œ?</span>
                    </button>
                    <button onclick="selectQuestionCard('what')" class="question-card bg-gradient-to-br from-green-50 to-emerald-50 border-3 border-green-200 rounded-2xl p-4 text-center" data-card="what">
                        <span class="text-3xl mb-2 block">â“</span>
                        <span class="font-noto text-green-600 text-sm">ë¬´ì—‡ì¼ê¹Œ?</span>
                    </button>
                    <button onclick="selectQuestionCard('why')" class="question-card bg-gradient-to-br from-amber-50 to-orange-50 border-3 border-amber-200 rounded-2xl p-4 text-center" data-card="why">
                        <span class="text-3xl mb-2 block">ğŸ¤”</span>
                        <span class="font-noto text-amber-600 text-sm">ì™œ ê·¸ë¬ì„ê¹Œ?</span>
                    </button>
                </div>
            </div>

            <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
            <div id="text-input-section" class="hidden input-area">
                <div class="flex items-end gap-3">
                    <div class="flex-1 bg-purple-50 rounded-2xl p-3 border-2 border-purple-100 focus-within:border-purple-300 transition-colors">
                        <textarea id="user-input" placeholder="ìƒê°ì„ ë§í•´ë´!" class="w-full bg-transparent outline-none resize-none text-gray-800" rows="2" oninput="autoResize(this)"></textarea>
                    </div>
                    <button onclick="sendMessage()" class="btn-3d w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl flex items-center justify-center" style="box-shadow: 0 4px 0 #6D28D9;">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-400 text-center mt-2">ì—”í„°ë¥¼ ëˆŒëŸ¬ ì „ì†¡í•˜ì„¸ìš”</p>
            </div>

            <!-- ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ -->
            <div id="next-question-section" class="hidden text-center">
                <button onclick="showNextQuestion()" class="btn-3d px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl font-noto text-lg shadow-lg" style="box-shadow: 0 6px 0 #6D28D9;">
                    ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- ì™„ë£Œ ë²„íŠ¼ -->
            <div id="complete-section" class="hidden text-center">
                <button onclick="completeSession()" class="btn-3d px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl font-noto text-lg shadow-lg" style="box-shadow: 0 6px 0 #047857;">
                    <i class="fa-solid fa-check mr-2"></i> ì§ˆë¬¸ ë Œì¦ˆ ì™„ë£Œ!
                </button>
            </div>
        </div>
    </footer>

    <!-- ì™„ë£Œ ëª¨ë‹¬ -->
    <div id="complete-modal" class="hidden fixed inset-0 z-[100] bg-gradient-to-br from-purple-500 via-pink-500 to-rose-500 flex items-center justify-center">
        <div class="text-center px-6">
            <div class="complete-badge w-40 h-40 mx-auto mb-6 bg-white rounded-full flex items-center justify-center shadow-2xl">
                <span class="text-7xl">ğŸ”</span>
            </div>
            <h2 class="font-noto text-4xl text-white mb-2">ì§ˆë¬¸ ë Œì¦ˆ ì™„ë£Œ!</h2>
            <p class="text-white/90 text-xl mb-8">ì±…ì— ëŒ€í•´ ë” ê¹Šì´ ìƒê°í–ˆì–´ìš”!</p>

            <div class="flex justify-center gap-4 mb-8">
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <span class="text-3xl mb-1 block">â­</span>
                    <span class="text-white font-noto">+25 ë³„</span>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <span class="text-3xl mb-1 block">ğŸ’¬</span>
                    <span class="text-white font-noto">ì§ˆë¬¸ 3ê°œ</span>
                </div>
            </div>

            <button onclick="goBack()" class="btn-3d px-10 py-4 bg-white text-purple-600 rounded-2xl font-noto text-lg" style="box-shadow: 0 6px 0 #DDD6FE;">
                ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <script src="../js/common.js"></script>
    <script>
        // ì±… ë°ì´í„°
        const booksData = {
            'magic-potion': {
                title: 'ë§ˆë²•ì‚¬ì˜ ë¬¼ì•½',
                emoji: 'ğŸ§™â€â™‚ï¸',
                conversations: {
                    who: {
                        questions: [
                            { q: "ìˆ²ì†ì—ì„œ ë§ˆë²•ì‚¬ë¥¼ ë„ì™€ì¤€ ì¹œêµ¬ëŠ” ëˆ„êµ¬ì¼ê¹Œ?", hint: "ë‚ ê°œê°€ ìˆê³  ë…¸ë˜ë¥¼ ì˜ ë¶ˆëŸ¬ìš”" },
                            { q: "ë§ˆë²•ì‚¬ê°€ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì¹œêµ¬ëŠ” ëˆ„êµ¬ë¼ê³  ìƒê°í•´?", hint: "" }
                        ]
                    },
                    what: {
                        questions: [
                            { q: "ë§ˆë²•ì‚¬ê°€ ë§Œë“  ë¬¼ì•½ì˜ ìƒ‰ê¹”ì€ ë¬´ì—‡ì´ì—ˆì„ê¹Œ?", hint: "ë¬´ì§€ê°œì²˜ëŸ¼ ì—¬ëŸ¬ ìƒ‰ì´ì—ìš”" },
                            { q: "ë§ˆë²•ì‚¬ì˜ ì§‘ì—ì„œ ê°€ì¥ ì‹ ê¸°í•œ ë¬¼ê±´ì€ ë­ì˜€ì„ê¹Œ?", hint: "" }
                        ]
                    },
                    why: {
                        questions: [
                            { q: "ë§ˆë²•ì‚¬ê°€ ìˆ²ì†ìœ¼ë¡œ ì¬ë£Œë¥¼ ì°¾ìœ¼ëŸ¬ ê°„ ì´ìœ ëŠ” ë­˜ê¹Œ?", hint: "íŠ¹ë³„í•œ ë¬¼ì•½ì„ ë§Œë“¤ê³  ì‹¶ì—ˆì–´ìš”" },
                            { q: "ìˆ²ì† ë™ë¬¼ë“¤ì´ ë§ˆë²•ì‚¬ë¥¼ ë„ì™€ì¤€ ì´ìœ ê°€ ë­ë¼ê³  ìƒê°í•´?", hint: "" }
                        ]
                    }
                }
            },
            'forest-friends': {
                title: 'ìˆ²ì† ì¹œêµ¬ë“¤',
                emoji: 'ğŸŒ²',
                conversations: {
                    who: {
                        questions: [
                            { q: "ìˆ²ì†ì—ì„œ ê°€ì¥ ìš©ê°í•œ ì¹œêµ¬ëŠ” ëˆ„êµ¬ì˜€ì„ê¹Œ?", hint: "ì‘ì§€ë§Œ ì”©ì”©í•´ìš”" },
                            { q: "ë‹¤ëŒì¥ê°€ ê°€ì¥ ì¢‹ì•„í•˜ëŠ” ì¹œêµ¬ëŠ” ëˆ„êµ¬ë¼ê³  ìƒê°í•´?", hint: "" }
                        ]
                    },
                    what: {
                        questions: [
                            { q: "ìˆ²ì† ì¹œêµ¬ë“¤ì´ í•¨ê»˜ ë§Œë“  ê±´ ë¬´ì—‡ì´ì—ˆì„ê¹Œ?", hint: "ëª¨ë‘ í•¨ê»˜ ì‚´ ìˆ˜ ìˆëŠ” ê³³ì´ì—ìš”" },
                            { q: "ì¹œêµ¬ë“¤ì´ ë‚˜ëˆ  ë¨¹ì€ ë§›ìˆëŠ” ìŒì‹ì€ ë­ì˜€ì„ê¹Œ?", hint: "" }
                        ]
                    },
                    why: {
                        questions: [
                            { q: "í† ë¼ê°€ ìˆ²ì† ì¹œêµ¬ë“¤ì„ ë„ì™€ì£¼ë ¤ê³  í•œ ì´ìœ ëŠ” ë­˜ê¹Œ?", hint: "í˜¼ìë³´ë‹¤ í•¨ê»˜ê°€ ì¢‹ì•„ì„œìš”" },
                            { q: "ìˆ²ì† ì¹œêµ¬ë“¤ì´ ì„œë¡œ ë„ìš°ë©´ì„œ ì‚° ì´ìœ ê°€ ë­ë¼ê³  ìƒê°í•´?", hint: "" }
                        ]
                    }
                }
            },
            'princess-dragon': {
                title: 'ê³µì£¼ì™€ ìš©',
                emoji: 'ğŸ‰',
                conversations: {
                    who: {
                        questions: [
                            { q: "ê³µì£¼ë¥¼ êµ¬í•˜ëŸ¬ ì˜¨ ì‚¬ëŒì€ ëˆ„êµ¬ì˜€ì„ê¹Œ?", hint: "ê°‘ì˜·ì„ ì…ê³  ìˆì§€ ì•Šì•˜ì–´ìš”" },
                            { q: "ìš©ì˜ ê°€ì¥ ì¹œí•œ ì¹œêµ¬ëŠ” ëˆ„êµ¬ë¼ê³  ìƒê°í•´?", hint: "" }
                        ]
                    },
                    what: {
                        questions: [
                            { q: "ìš©ì´ ì§€í‚¤ê³  ìˆë˜ ë³´ë¬¼ì€ ë¬´ì—‡ì´ì—ˆì„ê¹Œ?", hint: "ë°˜ì§ë°˜ì§ ë¹›ë‚˜ëŠ” ê±´ ì•„ë‹ˆì—ìš”" },
                            { q: "ê³µì£¼ê°€ ìš©ì—ê²Œ ì¤€ ì„ ë¬¼ì€ ë­ì˜€ì„ê¹Œ?", hint: "" }
                        ]
                    },
                    why: {
                        questions: [
                            { q: "ìš©ì´ ë¬´ì„­ê²Œ í–‰ë™í–ˆë˜ ì´ìœ ëŠ” ë­˜ê¹Œ?", hint: "ì‚¬ì‹¤ì€ ì™¸ë¡œì› ì–´ìš”" },
                            { q: "ê³µì£¼ì™€ ìš©ì´ ì¹œêµ¬ê°€ ëœ ì´ìœ ê°€ ë­ë¼ê³  ìƒê°í•´?", hint: "" }
                        ]
                    }
                }
            }
        };

        // ìƒíƒœ ê´€ë¦¬
        let selectedBook = null;
        let conversationData = null;
        let currentCardType = null;
        let currentQuestionIndex = 0;
        let answeredQuestions = 0;
        const totalQuestions = 3;
        let cameFromBuddy = false; // AI ë²„ë””ì—ì„œ ì§„ì…í–ˆëŠ”ì§€ ì—¬ë¶€

        // ì±… ì„ íƒ
        function selectBook(bookId) {
            selectedBook = booksData[bookId];
            conversationData = selectedBook.conversations;

            // í—¤ë” ì±… ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('header-book-title').textContent = selectedBook.title;
            document.getElementById('header-book-info').classList.remove('hidden');
            document.getElementById('header-book-info').classList.add('flex');
            document.getElementById('header-placeholder').classList.add('hidden');

            // ì±… ì„ íƒ í™”ë©´ ìˆ¨ê¸°ê¸°
            document.getElementById('book-selection-screen').classList.add('hidden');

            // ì±„íŒ… ì˜ì—­ í‘œì‹œ
            document.getElementById('chat-container').classList.remove('hidden');

            // ë°”ë¡œ ëŒ€í™” ì‹œì‘
            startConversation();
        }

        // ëŒ€í™” ì‹œì‘
        function startConversation() {
            // ë²„ë”” ì¸íŠ¸ë¡œ ë©”ì‹œì§€
            addBuddyMessage(`${selectedBook.emoji} '${selectedBook.title}' ì´ì•¼ê¸° ì¬ë¯¸ìˆì—ˆì–´?`);

            setTimeout(() => {
                addBuddyMessage("ë‚˜ë‘ ê°™ì´ ì´ì•¼ê¸°í•´ë³¼ë˜? ë­ê°€ ê¶ê¸ˆí•œì§€ ê³¨ë¼ë´!");
                showCardSelection();
            }, 1000);
        }

        // ë²„ë”” ë©”ì‹œì§€ ì¶”ê°€
        function addBuddyMessage(text, showTyping = true) {
            const container = document.getElementById('chat-messages');

            if (showTyping) {
                // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
                const typing = document.createElement('div');
                typing.className = 'flex items-end gap-3 mb-4';
                typing.id = 'typing-indicator';
                typing.innerHTML = `
                    <div class="buddy-avatar w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-2xl shadow-md flex-shrink-0">
                        ğŸ¿ï¸
                    </div>
                    <div class="chat-bubble buddy px-4 py-3">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                container.appendChild(typing);
                scrollToBottom();

                setTimeout(() => {
                    typing.remove();
                    actuallyAddBuddyMessage(text);
                }, 600);
            } else {
                actuallyAddBuddyMessage(text);
            }
        }

        function actuallyAddBuddyMessage(text) {
            const container = document.getElementById('chat-messages');
            const message = document.createElement('div');
            message.className = 'flex items-end gap-3 mb-4';
            message.innerHTML = `
                <div class="buddy-avatar w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-2xl shadow-md flex-shrink-0">
                    ğŸ¿ï¸
                </div>
                <div class="chat-bubble buddy px-5 py-4 max-w-[80%]">
                    <p class="text-gray-800">${text}</p>
                </div>
            `;
            container.appendChild(message);
            scrollToBottom();
        }

        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        function addUserMessage(text) {
            const container = document.getElementById('chat-messages');
            const message = document.createElement('div');
            message.className = 'flex items-end justify-end gap-3 mb-4';
            message.innerHTML = `
                <div class="chat-bubble user px-5 py-4 max-w-[80%]">
                    <p>${text}</p>
                </div>
                <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-pink-400 rounded-full flex items-center justify-center text-lg shadow-md flex-shrink-0">
                    ğŸ‘¦
                </div>
            `;
            container.appendChild(message);
            scrollToBottom();
        }

        // ì¹´ë“œ ì„ íƒ í‘œì‹œ
        function showCardSelection() {
            document.getElementById('card-selection').classList.remove('hidden');
            document.getElementById('text-input-section').classList.add('hidden');
            document.getElementById('next-question-section').classList.add('hidden');
        }

        // ì§ˆë¬¸ ì¹´ë“œ ì„ íƒ
        function selectQuestionCard(cardType) {
            // ì´ì „ ì„ íƒ í•´ì œ
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('selected');
            });

            // í˜„ì¬ ì„ íƒ í‘œì‹œ
            document.querySelector(`[data-card="${cardType}"]`).classList.add('selected');

            currentCardType = cardType;
            currentQuestionIndex = 0;

            const cardNames = { who: 'ëˆ„êµ¬ì¼ê¹Œ?', what: 'ë¬´ì—‡ì¼ê¹Œ?', why: 'ì™œ ê·¸ë¬ì„ê¹Œ?' };
            const cardEmojis = { who: 'ğŸ‘¤', what: 'â“', why: 'ğŸ¤”' };

            setTimeout(() => {
                // ì¹´ë“œ ì„ íƒ ìˆ¨ê¸°ê¸°
                document.getElementById('card-selection').classList.add('hidden');

                // ì‚¬ìš©ì ì„ íƒ ë©”ì‹œì§€
                addUserMessage(`${cardEmojis[cardType]} ${cardNames[cardType]}`);

                // ë²„ë”” ì‘ë‹µ
                setTimeout(() => {
                    addBuddyMessage("ì¢‹ì•„! ê·¸ëŸ¼ ì§ˆë¬¸í• ê²Œ!");
                }, 500);

                setTimeout(() => {
                    askQuestion();
                }, 1200);
            }, 300);
        }

        // ì§ˆë¬¸í•˜ê¸°
        function askQuestion() {
            const questions = conversationData[currentCardType].questions;
            const question = questions[currentQuestionIndex];

            addBuddyMessage(question.q);

            if (question.hint) {
                setTimeout(() => {
                    addBuddyMessage(`ğŸ’¡ íŒíŠ¸: ${question.hint}`, false);
                }, 500);
            }

            // ì…ë ¥ ì˜ì—­ í‘œì‹œ
            setTimeout(() => {
                document.getElementById('text-input-section').classList.remove('hidden');
                document.getElementById('user-input').focus();
            }, 800);
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();

            if (!text) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addUserMessage(text);
            input.value = '';
            input.style.height = 'auto';

            // ì…ë ¥ ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('text-input-section').classList.add('hidden');

            // ë²„ë”” ë°˜ì‘
            setTimeout(() => {
                const responses = [
                    "ì™€! ì •ë§ ì¢‹ì€ ìƒê°ì´ì•¼! ğŸŒŸ",
                    "ì˜¤~ ê·¸ë ‡ê²Œ ìƒê°í–ˆêµ¬ë‚˜! ëŒ€ë‹¨í•´! âœ¨",
                    "ì¬ë¯¸ìˆëŠ” ëŒ€ë‹µì´ì•¼! ğŸ‘",
                    "ë©‹ì§„ ìƒê°ì´ì•¼! ë‚˜ë„ ê·¸ë ‡ê²Œ ìƒê°í•´! ğŸ’œ"
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addBuddyMessage(randomResponse);

                answeredQuestions++;

                setTimeout(() => {
                    currentQuestionIndex++;

                    if (currentQuestionIndex < conversationData[currentCardType].questions.length) {
                        // ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ í‘œì‹œ
                        document.getElementById('next-question-section').classList.remove('hidden');
                    } else if (answeredQuestions < totalQuestions) {
                        // ë‹¤ë¥¸ ì¹´ë“œ ì„ íƒ ìœ ë„
                        addBuddyMessage("ë‹¤ë¥¸ ê²ƒë„ ê¶ê¸ˆí•˜ì§€ ì•Šì•„? ë˜ ê³¨ë¼ë´!");
                        showCardSelection();
                    } else {
                        // ì™„ë£Œ
                        addBuddyMessage("ì™€! ì˜¤ëŠ˜ ì •ë§ ë§ì´ ìƒê°í–ˆì–´! ëŒ€ë‹¨í•´! ğŸ‰");
                        document.getElementById('complete-section').classList.remove('hidden');
                    }
                }, 800);
            }, 600);
        }

        // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ
        function showNextQuestion() {
            document.getElementById('next-question-section').classList.add('hidden');
            askQuestion();
        }

        // ì„¸ì…˜ ì™„ë£Œ
        function completeSession() {
            document.getElementById('complete-modal').classList.remove('hidden');
        }

        // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // í…ìŠ¤íŠ¸ì—ì–´ë¦¬ì–´ ìë™ ë†’ì´ ì¡°ì ˆ
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // ì—”í„°í‚¤ ì „ì†¡
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('user-input');
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // AI ë²„ë””ì—ì„œ ì±…ì„ ì´ë¯¸ ì„ íƒí•˜ê³  ì˜¨ ê²½ìš° â†’ ì±… ì„ íƒ ìŠ¤í‚µ
            const buddyBookRaw = sessionStorage.getItem('aiBuddyBook');
            const chatStateRaw = sessionStorage.getItem('aiBuddyChatState');

            // aiBuddyChatStateê°€ ìˆìœ¼ë©´ AI ë²„ë””ì—ì„œ ì˜¨ ê²ƒìœ¼ë¡œ ê°„ì£¼
            if (chatStateRaw) {
                cameFromBuddy = true;
            }

            // ë‚˜ì˜ ê¸°ë¡ì—ì„œ ì§„ì…í•œ ê²½ìš° â†’ ì´ì „ ëŒ€í™” ë‚´ìš© í‘œì‹œ
            const recordRaw = sessionStorage.getItem('questionLensRecord');
            if (recordRaw) {
                try {
                    const record = JSON.parse(recordRaw);
                    const defaultConversations = booksData['magic-potion'].conversations;
                    selectedBook = {
                        title: record.book,
                        emoji: record.bookEmoji,
                        conversations: defaultConversations
                    };
                    conversationData = selectedBook.conversations;

                    // í—¤ë”ì— ì±… ì •ë³´ í‘œì‹œ
                    document.getElementById('header-book-title').textContent = selectedBook.title;
                    document.getElementById('header-book-info').classList.remove('hidden');
                    document.getElementById('header-book-info').classList.add('flex');
                    document.getElementById('header-placeholder').classList.add('hidden');

                    // ì±… ì„ íƒ í™”ë©´ ìŠ¤í‚µ â†’ ì±„íŒ… ì˜ì—­ ë°”ë¡œ í‘œì‹œ
                    document.getElementById('book-selection-screen').classList.add('hidden');
                    document.getElementById('chat-container').classList.remove('hidden');

                    // ì´ì „ ëŒ€í™” ë‚´ìš© ë Œë”ë§ (íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ í‘œì‹œ)
                    actuallyAddBuddyMessage(`${record.bookEmoji} '${record.book}' ì´ì•¼ê¸° ì¬ë¯¸ìˆì—ˆì–´?`);
                    actuallyAddBuddyMessage("ë‚˜ë‘ ê°™ì´ ì´ì•¼ê¸°í•´ë³¼ë˜? ë­ê°€ ê¶ê¸ˆí•œì§€ ê³¨ë¼ë´!");
                    addUserMessage(record.title);
                    actuallyAddBuddyMessage(record.preview);
                    actuallyAddBuddyMessage("ë˜ ê¶ê¸ˆí•œ ê±° ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë´! ë‹¤ë¥¸ ì§ˆë¬¸ë„ í•´ë³¼ê¹Œ?");

                    // ì§ˆë¬¸ì¹´ë“œ 3ê°œ í‘œì‹œ (ëˆ„êµ¬ì¼ê¹Œ?, ë¬´ì—‡ì¼ê¹Œ?, ì™œê·¸ë¬ì„ê¹Œ?)
                    showCardSelection();

                    cameFromBuddy = true;
                    sessionStorage.removeItem('questionLensRecord');
                } catch (e) {
                    // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ í™”ë©´
                }
                return; // ë‚˜ì˜ ê¸°ë¡ ì§„ì…ì´ë©´ ì•„ë˜ buddyBook ë¡œì§ ìŠ¤í‚µ
            }

            if (buddyBookRaw) {
                try {
                    const buddyBook = JSON.parse(buddyBookRaw);
                    // ë²„ë”” ì±… â†’ ì§ˆë¬¸ë Œì¦ˆ ë§¤í•‘ (IDê°€ ë‹¤ë¥´ë¯€ë¡œ ê¸°ë³¸ ëŒ€í™” ì„¸íŠ¸ ì‚¬ìš©)
                    const defaultConversations = booksData['magic-potion'].conversations;
                    selectedBook = {
                        title: buddyBook.title,
                        emoji: buddyBook.emoji,
                        conversations: defaultConversations
                    };
                    conversationData = selectedBook.conversations;

                    // í—¤ë”ì— ì±… ì •ë³´ í‘œì‹œ
                    document.getElementById('header-book-title').textContent = selectedBook.title;
                    document.getElementById('header-book-info').classList.remove('hidden');
                    document.getElementById('header-book-info').classList.add('flex');
                    document.getElementById('header-placeholder').classList.add('hidden');

                    // ì±… ì„ íƒ í™”ë©´ ìŠ¤í‚µ â†’ ì±„íŒ… ì˜ì—­ ë°”ë¡œ í‘œì‹œ
                    document.getElementById('book-selection-screen').classList.add('hidden');
                    document.getElementById('chat-container').classList.remove('hidden');

                    // ë²„ë”” ì¸ì‚¬ (ì±… ì´ë¯¸ ì„ íƒëœ ìƒíƒœ)
                    addBuddyMessage(`${selectedBook.emoji} '${selectedBook.title}' ì´ì•¼ê¸° ì¬ë¯¸ìˆì—ˆì–´?`);
                    setTimeout(() => {
                        addBuddyMessage("ë‚˜ë‘ ê°™ì´ ì´ì•¼ê¸°í•´ë³¼ë˜? ë­ê°€ ê¶ê¸ˆí•œì§€ í•˜ë‚˜ë§Œ ê³¨ë¼ë´!");
                        showCardSelection();
                    }, 1000);

                    // AI ë²„ë””ì—ì„œ ì§„ì… í”Œë˜ê·¸ ì„¤ì •
                    cameFromBuddy = true;
                    // ì‚¬ìš©í•œ ì„¸ì…˜ ë°ì´í„° ì œê±°
                    sessionStorage.removeItem('aiBuddyBook');
                } catch (e) {
                    // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì±… ì„ íƒ í™”ë©´ ìœ ì§€
                }
            }
        });

        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            // ì™„ë£Œ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
            if (!document.getElementById('complete-modal').classList.contains('hidden')) {
                document.getElementById('complete-modal').classList.add('hidden');
                if (cameFromBuddy) {
                    window.location.href = 'ai-buddy.html';
                } else {
                    resetToBookSelection();
                }
                return;
            }

            // AI ë²„ë””ì—ì„œ ì˜¨ ê²½ìš° â†’ ë²„ë”” ì±—ë´‡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            if (cameFromBuddy) {
                window.location.href = 'ai-buddy.html';
                return;
            }

            // ëŒ€í™” ì¤‘ì´ë©´ ì±… ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            if (selectedBook && document.getElementById('book-selection-screen').classList.contains('hidden')) {
                resetToBookSelection();
            } else if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'home.html';
            }
        }

        // ì±… ì„ íƒ í™”ë©´ìœ¼ë¡œ ë¦¬ì…‹
        function resetToBookSelection() {
            // ìƒíƒœ ì´ˆê¸°í™”
            selectedBook = null;
            conversationData = null;
            currentCardType = null;
            currentQuestionIndex = 0;
            answeredQuestions = 0;

            // UI ì´ˆê¸°í™”
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('book-selection-screen').classList.remove('hidden');
            document.getElementById('chat-container').classList.add('hidden');
            document.getElementById('header-book-info').classList.add('hidden');
            document.getElementById('header-book-info').classList.remove('flex');
            document.getElementById('header-placeholder').classList.remove('hidden');

            // ì…ë ¥ ì„¹ì…˜ë“¤ ìˆ¨ê¸°ê¸°
            document.getElementById('card-selection').classList.add('hidden');
            document.getElementById('text-input-section').classList.add('hidden');
            document.getElementById('next-question-section').classList.add('hidden');
            document.getElementById('complete-section').classList.add('hidden');
        }
    </script>

<!-- Proto Navigation (æ€¨ë“¯ë„» Dev Tool) -->
<link rel="stylesheet" href="../css/proto-nav.css">
<script src="../js/proto-nav.js"></script>
</body>
</html>
