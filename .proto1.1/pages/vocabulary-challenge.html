<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶í´ëŸ½ 3.0 - ì–´íœ˜ ì±Œë¦°ì§€</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FEF3C7', primary: '#FF9F43', dark: '#F368E0', secondary: '#54a0ff', green: '#1dd1a1'
                        },
                        game: {
                            purple: '#7C3AED',
                            purpleDark: '#5B21B6',
                            blue: '#3B82F6',
                            green: '#10B981',
                            yellow: '#F59E0B',
                            red: '#EF4444',
                            pink: '#EC4899'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }

        /* ë‹¨ìˆœí•œ ë‹¨ìƒ‰ ë°°ê²½ */
        body {
            background: #1E1B4B;
        }

        /* 3D ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-3d {
            transform: translateY(-4px);
            transition: all 0.1s ease;
        }
        .btn-3d:active {
            transform: translateY(0);
        }

        /* ë‹¨ì–´ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .word-card {
            background: white;
            color: #1E1B4B;
            border-radius: 20px;
            padding: 16px 24px;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
            position: absolute;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2), 0 12px 30px rgba(0,0,0,0.3);
            transition: all 0.15s ease;
            user-select: none;
        }
        .word-card:hover {
            transform: scale(1.05);
        }
        .word-card:active {
            transform: scale(0.95);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.3);
        }
        .word-card.correct {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            animation: correctPop 0.5s ease;
        }
        .word-card.wrong {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            animation: shake 0.5s ease;
        }
        .word-card.hidden-card {
            opacity: 0;
            pointer-events: none;
            transform: scale(0);
        }

        @keyframes correctPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(0); opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* ì¤‘ì•™ í‚¤ì›Œë“œ ì¹´ë“œ */
        .keyword-card {
            background: linear-gradient(135deg, #7C3AED, #5B21B6);
            border-radius: 24px;
            padding: 24px 48px;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            box-shadow: 0 12px 0 #4C1D95, 0 16px 40px rgba(0,0,0,0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        /* ì½¤ë³´ í…ìŠ¤íŠ¸ */
        .combo-text {
            position: fixed;
            font-size: 3rem;
            font-weight: bold;
            color: #FCD34D;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5), 0 0 40px rgba(252, 211, 77, 0.5);
            animation: comboPopup 1s ease forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes comboPopup {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            30% { transform: scale(1.3) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) translateY(-50px) rotate(0deg); opacity: 0; }
        }

        /* ì—ë„ˆì§€/í•˜íŠ¸ ë°” */
        .heart-container {
            display: flex;
            gap: 8px;
        }
        .heart {
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
        }
        .heart.lost {
            filter: grayscale(1);
            opacity: 0.3;
        }

        /* ì½¤ë³´ ì ìˆ˜íŒ */
        .combo-display {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            border-radius: 16px;
            padding: 8px 20px;
            box-shadow: 0 4px 0 #B45309, 0 6px 15px rgba(0,0,0,0.3);
        }

        /* íƒ€ì´ë¨¸ ë°” */
        .timer-track {
            height: 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 999px;
            overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #34D399);
            border-radius: 999px;
            transition: width 0.1s linear;
        }
        .timer-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #FBBF24);
        }
        .timer-fill.danger {
            background: linear-gradient(90deg, #EF4444, #F87171);
        }

        /* íŒíŠ¸ ì˜ì—­ */
        .hint-box {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 12px 24px;
        }

        /* ì™„ë£Œ í™”ë©´ ë°°ì§€ */
        .badge-stamp {
            animation: stampIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes stampIn {
            0% { transform: scale(3) rotate(-30deg); opacity: 0; }
            70% { transform: scale(0.9) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        /* í”Œë¡œíŒ… ì• ë‹ˆë©”ì´ì…˜ */
        .float-1 { animation: float1 4s ease-in-out infinite; }
        .float-2 { animation: float2 3.5s ease-in-out infinite; }
        .float-3 { animation: float3 5s ease-in-out infinite; }
        .float-4 { animation: float4 4.5s ease-in-out infinite; }

        @keyframes float1 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(15px, -20px); }
        }
        @keyframes float2 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-20px, 15px); }
        }
        @keyframes float3 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(10px, 25px); }
        }
        @keyframes float4 {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-15px, -15px); }
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="font-sans text-white min-h-screen overflow-hidden">
    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="fixed top-0 left-0 right-0 z-50 px-6 py-4">
        <div class="max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-3">
                <!-- ë‹«ê¸° ë²„íŠ¼ -->
                <button onclick="exitChallenge()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>

                <!-- ì½¤ë³´ ì ìˆ˜ -->
                <div class="combo-display flex items-center gap-2">
                    <span class="text-white/80 text-sm">ì½¤ë³´</span>
                    <span id="combo-count" class="font-noto text-2xl text-white">0</span>
                    <span class="text-xl">ğŸ”¥</span>
                </div>

                <!-- í•˜íŠ¸ -->
                <div class="heart-container">
                    <span class="heart" id="heart-1">â¤ï¸</span>
                    <span class="heart" id="heart-2">â¤ï¸</span>
                    <span class="heart" id="heart-3">â¤ï¸</span>
                </div>
            </div>

            <!-- íƒ€ì´ë¨¸ ë°” -->
            <div class="timer-track">
                <div id="timer-bar" class="timer-fill" style="width: 100%"></div>
            </div>
        </div>
    </header>

    <!-- ê²Œì„ ì˜ì—­ -->
    <main class="h-screen flex flex-col items-center justify-center px-6 pt-24 pb-32" id="game-area">
        <!-- ë¼ìš´ë“œ í‘œì‹œ -->
        <div class="mb-4">
            <span class="bg-white/20 backdrop-blur-sm text-white/90 px-4 py-2 rounded-full text-sm font-bold">
                ë¼ìš´ë“œ <span id="round-number">1</span> / <span id="total-rounds">3</span>
            </span>
        </div>

        <!-- íŒíŠ¸ -->
        <div class="hint-box mb-8 slide-up">
            <p id="hint-text" class="text-white/90 text-center">í˜€ëì—ì„œ ëŠê»´ì§€ëŠ” ê¸°ë¶„ ì¢‹ì€ ë§›</p>
        </div>

        <!-- ì¤‘ì•™ í‚¤ì›Œë“œ -->
        <div class="keyword-card font-noto mb-12 slide-up" id="keyword-card">
            <span id="keyword-text">ë‹¬ì½¤í•˜ë‹¤</span>
        </div>

        <!-- ë‹¨ì–´ ì¹´ë“œë“¤ (ì ˆëŒ€ ìœ„ì¹˜) -->
        <div class="relative w-full max-w-2xl h-64" id="cards-container">
            <!-- ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>

        <!-- ì ìˆ˜ í‘œì‹œ -->
        <div class="fixed bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-4">
            <div class="bg-white/10 backdrop-blur-sm rounded-2xl px-6 py-3 border border-white/20">
                <span class="text-white/70 text-sm">ì ìˆ˜</span>
                <span id="score" class="font-noto text-2xl text-white ml-2">0</span>
            </div>
        </div>
    </main>

    <!-- ë¼ìš´ë“œ ì™„ë£Œ í™”ë©´ -->
    <div id="round-complete" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center">
        <div class="text-center slide-up">
            <div class="badge-stamp w-40 h-40 mx-auto mb-6 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center shadow-2xl">
                <span class="text-6xl">ğŸ’</span>
            </div>
            <h2 class="font-noto text-4xl text-white mb-2" id="round-result-text">Excellent!</h2>
            <p class="text-white/80 text-xl mb-6">ì½¤ë³´ <span id="round-combo">5</span>íšŒ ë‹¬ì„±!</p>
            <button onclick="nextRound()" class="btn-3d bg-gradient-to-r from-game-purple to-game-pink text-white font-noto text-xl px-10 py-4 rounded-2xl shadow-lg">
                ë‹¤ìŒ ë¼ìš´ë“œ
            </button>
        </div>
    </div>

    <!-- ê²Œì„ ì™„ë£Œ í™”ë©´ -->
    <div id="game-complete" class="hidden fixed inset-0 z-[200] bg-gradient-to-br from-game-purple via-purple-600 to-pink-500 flex items-center justify-center">
        <div class="text-center px-6">
            <!-- íŠ¸ë¡œí”¼ ë±ƒì§€ -->
            <div class="badge-stamp w-48 h-48 mx-auto mb-8 bg-gradient-to-br from-yellow-300 via-yellow-400 to-orange-400 rounded-full flex items-center justify-center shadow-2xl border-8 border-yellow-200">
                <span class="text-8xl">ğŸ†</span>
            </div>

            <h2 class="font-noto text-5xl text-white mb-3">ì±Œë¦°ì§€ ì™„ë£Œ!</h2>
            <p class="text-white/90 text-2xl mb-8">ëŒ€ë‹¨í•´ìš”! ëª¨ë“  ë‹¨ê³„ë¥¼ í´ë¦¬ì–´í–ˆì–´ìš”!</p>

            <!-- ê²°ê³¼ ì¹´ë“œë“¤ -->
            <div class="flex justify-center gap-4 mb-8">
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <p class="text-white/70 text-sm">ìµœê³  ì½¤ë³´</p>
                    <p id="final-combo" class="font-noto text-3xl text-yellow-300">12</p>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <p class="text-white/70 text-sm">ì´ ì ìˆ˜</p>
                    <p id="final-score" class="font-noto text-3xl text-white">450</p>
                </div>
                <div class="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border border-white/30">
                    <p class="text-white/70 text-sm">íšë“ ë³„</p>
                    <p class="font-noto text-3xl text-yellow-300">+50â­</p>
                </div>
            </div>

            <!-- í•™ìŠµ ì™„ë£Œ ì•ˆë‚´ -->
            <div class="bg-white rounded-3xl p-6 max-w-md mx-auto shadow-2xl mb-6">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">âœ…</div>
                    <div class="text-left">
                        <p class="font-noto text-lg text-gray-800">ì´ë²ˆ ì£¼ í•™ìŠµ ì™„ë£Œ!</p>
                        <p class="text-sm text-gray-500">ëª¨ë“  í™œë™ì„ ë§ˆì³¤ì–´ìš”</p>
                    </div>
                </div>
                <button onclick="goToHome()" class="btn-3d w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-noto text-xl rounded-2xl shadow-lg" style="box-shadow: 0 6px 0 #047857, 0 8px 20px rgba(0,0,0,0.2);">
                    í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ê²Œì„ ë°ì´í„°
        const gameRounds = [
            {
                keyword: 'ë‹¬ì½¤í•˜ë‹¤',
                hint: 'í˜€ëì—ì„œ ëŠê»´ì§€ëŠ” ê¸°ë¶„ ì¢‹ì€ ë§›',
                correctWords: ['ì‚¬íƒ•', 'ì¼€ì´í¬'],
                wrongWords: ['ì†Œê¸ˆ', 'êµ¬ë‘']
            }
        ];

        // ê²Œì„ ìƒíƒœ
        let currentRound = 0;
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let hearts = 3;
        let timeLeft = 100;
        let timerInterval = null;
        let correctWordsFound = 0;
        let totalCorrectWords = 0;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            startGame();
        });

        function startGame() {
            currentRound = 0;
            score = 0;
            combo = 0;
            maxCombo = 0;
            hearts = 3;
            loadRound();
        }

        function loadRound() {
            const round = gameRounds[currentRound];
            totalCorrectWords = round.correctWords.length;
            correctWordsFound = 0;
            timeLeft = 100;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('keyword-text').textContent = round.keyword;
            document.getElementById('hint-text').textContent = round.hint;
            document.getElementById('round-number').textContent = currentRound + 1;
            document.getElementById('total-rounds').textContent = gameRounds.length;

            // ì¹´ë“œ ìƒì„±
            createWordCards(round);

            // íƒ€ì´ë¨¸ ì‹œì‘
            startTimer();
        }

        function createWordCards(round) {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';

            const allWords = [...round.correctWords, ...round.wrongWords];
            shuffleArray(allWords);

            // ì¹´ë“œ ìœ„ì¹˜ (4ê°œì˜ ì½”ë„ˆ + ì¤‘ê°„)
            const positions = [
                { top: '10%', left: '5%', float: 'float-1' },
                { top: '10%', right: '5%', float: 'float-2' },
                { bottom: '10%', left: '5%', float: 'float-3' },
                { bottom: '10%', right: '5%', float: 'float-4' }
            ];

            allWords.forEach((word, index) => {
                const card = document.createElement('div');
                card.className = `word-card ${positions[index].float}`;
                card.textContent = word;
                card.dataset.word = word;
                card.dataset.correct = round.correctWords.includes(word) ? 'true' : 'false';

                // ìœ„ì¹˜ ì„¤ì •
                const pos = positions[index];
                if (pos.top) card.style.top = pos.top;
                if (pos.bottom) card.style.bottom = pos.bottom;
                if (pos.left) card.style.left = pos.left;
                if (pos.right) card.style.right = pos.right;

                card.onclick = () => selectWord(card);
                container.appendChild(card);
            });
        }

        function selectWord(card) {
            const isCorrect = card.dataset.correct === 'true';

            if (isCorrect) {
                // ì •ë‹µ!
                card.classList.add('correct');
                correctWordsFound++;
                combo++;
                maxCombo = Math.max(maxCombo, combo);
                score += 50 + (combo * 10);

                updateUI();
                showComboText(card);

                // ì¹´ë“œ ì œê±°
                setTimeout(() => {
                    card.classList.add('hidden-card');
                    checkRoundComplete();
                }, 400);
            } else {
                // ì˜¤ë‹µ
                card.classList.add('wrong');
                combo = 0;
                loseHeart();
                updateUI();

                setTimeout(() => {
                    card.classList.remove('wrong');
                }, 500);
            }
        }

        function showComboText(card) {
            const texts = ['Good!', 'Great!', 'Excellent!', 'Amazing!', 'Perfect!'];
            const textIndex = Math.min(combo - 1, texts.length - 1);

            const comboEl = document.createElement('div');
            comboEl.className = 'combo-text font-noto';
            comboEl.textContent = texts[textIndex];

            const rect = card.getBoundingClientRect();
            comboEl.style.left = rect.left + rect.width / 2 + 'px';
            comboEl.style.top = rect.top + 'px';
            comboEl.style.transform = 'translateX(-50%)';

            document.body.appendChild(comboEl);

            setTimeout(() => {
                comboEl.remove();
            }, 1000);
        }

        function updateUI() {
            document.getElementById('combo-count').textContent = combo;
            document.getElementById('score').textContent = score;
        }

        function loseHeart() {
            if (hearts > 0) {
                const heartEl = document.getElementById(`heart-${hearts}`);
                heartEl.classList.add('lost');
                heartEl.textContent = 'ğŸ–¤';
                hearts--;

                if (hearts <= 0) {
                    endGame();
                }
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft -= 0.5;
                updateTimerUI();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // ì‹œê°„ ì´ˆê³¼ ì‹œ ë¼ìš´ë“œ ì‹¤íŒ¨
                    loseHeart();
                    if (hearts > 0) {
                        showRoundComplete();
                    }
                }
            }, 50);
        }

        function updateTimerUI() {
            const timerBar = document.getElementById('timer-bar');
            timerBar.style.width = timeLeft + '%';

            timerBar.classList.remove('warning', 'danger');
            if (timeLeft < 30) {
                timerBar.classList.add('danger');
            } else if (timeLeft < 60) {
                timerBar.classList.add('warning');
            }
        }

        function checkRoundComplete() {
            if (correctWordsFound >= totalCorrectWords) {
                clearInterval(timerInterval);
                showRoundComplete();
            }
        }

        function showRoundComplete() {
            const results = ['Good!', 'Great!', 'Excellent!', 'Amazing!'];
            document.getElementById('round-result-text').textContent = results[Math.min(maxCombo, results.length - 1)];
            document.getElementById('round-combo').textContent = combo;

            document.getElementById('round-complete').classList.remove('hidden');
        }

        function nextRound() {
            document.getElementById('round-complete').classList.add('hidden');

            currentRound++;
            if (currentRound >= gameRounds.length) {
                showGameComplete();
            } else {
                combo = 0; // ì½¤ë³´ ë¦¬ì…‹
                updateUI();
                loadRound();
            }
        }

        function showGameComplete() {
            clearInterval(timerInterval);

            document.getElementById('final-combo').textContent = maxCombo;
            document.getElementById('final-score').textContent = score;

            document.getElementById('game-complete').classList.remove('hidden');

            // í•™ìŠµ ì™„ë£Œ ìƒíƒœ ì €ì¥ (ì£¼ì°¨ë³„+ì±…íƒ€ì…ë³„ í‚¤ ì‚¬ìš©)
            const bookData = JSON.parse(sessionStorage.getItem('currentBook') || '{}');
            const week = bookData.week || 1;
            const bookType = bookData.bookType || 'core';
            const isReReadingMode = sessionStorage.getItem('isReReadingMode') === 'true' || bookData.isReReading;

            // ë‹¤ì‹œ ì½ê¸° ëª¨ë“œì—ì„œëŠ” ì‹¤ì œ ì§„í–‰ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
            if (!isReReadingMode) {
                const progressKey = 'learningProgress_w' + week + '_' + bookType;
                const progressData = JSON.parse(sessionStorage.getItem(progressKey) || '{}');
                progressData.vocabCompleted = true;
                progressData.vocabScore = score;
                progressData.weekCompleted = true;
                sessionStorage.setItem(progressKey, JSON.stringify(progressData));

                // í•˜ìœ„ í˜¸í™˜: ê¸°ì¡´ í‚¤ì—ë„ ì €ì¥
                sessionStorage.setItem('learningProgress', JSON.stringify(progressData));
            }

            // ì–´íœ˜ì±Œë¦°ì§€ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì • (í™ˆì—ì„œ í™•ì¸ìš© - ë‹¤ì‹œ ì½ê¸° ëª¨ë“œì—ì„œë„ í•„ìš”)
            sessionStorage.setItem('vocabJustCompleted', 'true');
            sessionStorage.setItem('vocabCompletedWeek', week.toString());
            sessionStorage.setItem('vocabCompletedBookType', bookType);
        }

        function endGame() {
            clearInterval(timerInterval);
            showGameComplete();
        }

        function goToHome() {
            window.location.href = 'home.html';
        }

        function exitChallenge() {
            if (confirm('ì±Œë¦°ì§€ë¥¼ ê·¸ë§Œë‘˜ê¹Œìš”?')) {
                window.location.href = 'home.html';
            }
        }

        // ìœ í‹¸ë¦¬í‹°
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>

<!-- Proto Navigation (æ€¨ë“¯ë„» Dev Tool) -->
<link rel="stylesheet" href="../css/proto-nav.css">
<script src="../js/proto-nav.js"></script>
</body>
</html>
